<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    /* Global Styles & Eastern European Snowy Minimal Theme */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: 
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
        url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .container, .panel, #characterCreation, .modal, #loginPanel {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    /* Grid of Rooms */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* Buttons */
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    .exit-button {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(200,150,130,0.7);
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Modal Styles (for plant selection, kitchen, water, door interaction) */
    .modal, #doorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea,
    #doorModal button, #doorModal input {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    /* Responsive Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    /* Responsive Chat Log */
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Biodata Panel */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Harvest Inventory Display */
    #harvestInventory {
      margin-top: 10px;
      padding: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
    }
    /* Garden Slots */
    #garden-panel .slot {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #777;
      border-radius: 4px;
    }
    #garden-panel .slot button {
      margin-left: 5px;
      padding: 3px 6px;
      font-size: 12px;
    }
    /* New panel for Login */
    #loginPanel {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
      display: none;
    }
    /* In-App Notification Panel */
    #notificationPanel {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px;
      border: 1px solid #fff;
      border-radius: 4px;
      z-index: 1002;
      display: none;
      max-width: 300px;
      font-size: 14px;
    }
  </style>
  <!-- Firebase SDKs: Auth and Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- Login Panel -->
<div id="loginPanel">
  <h3>Login / Register</h3>
  <input type="email" id="loginEmail" placeholder="Email" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button onclick="loginUser()">Login</button>
  <button onclick="registerUser()">Register</button>
  <button onclick="googleSignIn()">Sign in with Google</button>
</div>

<!-- Character Creation Section -->
<div id="characterCreation">
  <h3>Create Your Character</h3>
  <p>Welcome, <span id="displayName"></span>!</p>
  <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
    <input type="text" id="charName" placeholder="Name" required>
    <input type="number" id="charAge" placeholder="Age" required>
    <select id="charGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
    <textarea id="charBackstory" placeholder="Backstory" required></textarea>
    <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
    <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
    <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
    <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
    <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
    <select id="roomNumber" required>
      <option value="">Select Room Number</option>
    </select>
    <button type="submit">Create Character</button>
  </form>
</div>

<!-- Main Game Section -->
<div id="mainGame" style="display: none;">
  <!-- Notification Panel for In-App Alerts -->
  <div id="notificationPanel"></div>

  <!-- Main Screen -->
  <div id="main-screen">
    <div class="container">
      <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
      <button class="exit-button" onclick="signOutUser()">Exit</button>
      <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
      <div class="grid">
        <!-- Room buttons will be generated dynamically -->
      </div>
      <button class="power-room" onclick="showPowerPanel()">Power Room</button>
    </div>
    <div class="facilities">
      <button onclick="handleClick('Community Kitchen')">Community Kitchen</button>
      <button onclick="openGroceryPanel()">Groceries Stand</button>
      <button onclick="handleClick('Water Supplies (Laundry)')">Water Supplies (Laundry)</button>
      <button onclick="togglePlayerStatus()">Biodata</button>
    </div>
    <div id="playerStatus">
      <!-- Biodata updated dynamically; includes room info and harvest inventory -->
    </div>
  </div>

  <!-- Power Source Panel -->
  <div id="minigame-panel" class="panel">
    <h2>Wind Turbine Control Panel</h2>
    <p><strong>Objective:</strong> Ensure the turbine provides electricity, water heating, and lighting.</p>
    <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    <div id="instructions" style="display: none;">
      <p>Adjust wind speed, engage brakes as needed, lubricate, and confirm power output.</p>
    </div>
    <div class="control">
      <label for="windSpeedSlider">Wind Speed Regulator:</label>
      <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
      <span id="windSpeedValue"></span>
    </div>
    <div class="control">
      <label for="brakeButton">Brake System:</label>
      <button id="brakeButton" onclick="toggleBrake()">Engage Brake</button>
    </div>
    <div class="control">
      <label>Voltage Monitor:</label>
      <span id="voltageDisplay"></span> V
    </div>
    <div class="control">
      <label for="lubricateButton">Lubrication Check:</label>
      <button id="lubricateButton" onclick="lubricate()">Lubricate</button>
    </div>
    <div class="control">
      <label for="powerOutputConfirm">Power Output Confirm:</label>
      <button id="powerOutputConfirm" onclick="togglePowerOutput()">Confirm Output</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('minigame-panel')">Return to Main Screen</button>
    </div>
    <h3>System Log:</h3>
    <div id="minigameLog"></div>
    <div class="control">
      <label>Power Status:</label>
      <span id="powerStatusDisplay">Unknown</span>
    </div>
  </div>

  <!-- Garbage Chute Panel -->
  <div id="garbage-panel" class="panel">
    <h2>Garbage Chute Control</h2>
    <p><strong>Objective:</strong> Clear accumulated garbage before it causes a community health crisis.</p>
    <div class="control">
      <label>Garbage Level:</label>
      <span id="garbageDisplay"></span> / 100
    </div>
    <div class="control">
      <button onclick="clearGarbage()">Clear Garbage</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('garbage-panel')">Return to Main Screen</button>
    </div>
    <h3>Garbage Log:</h3>
    <div id="garbageLog"></div>
  </div>

  <!-- Grocery Store Panel -->
  <div id="grocery-panel" class="panel">
    <h2>Grocery Store</h2>
    <p>Purchase essential items. Prices may vary with electricity availability.</p>
    <div class="grocery-item">
      <p><strong>Food Staples</strong> - $10</p>
      <button onclick="buyItem('Food Staples')">Buy Food</button>
    </div>
    <div class="grocery-item">
      <p><strong>Seeds</strong> (for Community Garden) - $2 each</p>
      <button onclick="buyItem('Seeds')">Buy Seeds</button>
    </div>
    <div class="grocery-item">
      <p><strong>Maintenance Essentials</strong> - $5</p>
      <button onclick="buyItem('Maintenance Essentials')">Buy Maintenance</button>
    </div>
    <div class="grocery-item">
      <p><strong>Room Decorations</strong> - $7</p>
      <button onclick="buyItem('Room Decoration')">Buy Decoration</button>
    </div>
    <div class="grocery-item">
      <p><strong>Alcohol</strong> - $3</p>
      <button onclick="buyItem('Alcohol')">Buy Alcohol</button>
    </div>
    <div class="grocery-item">
      <p><strong>Cigarettes</strong> - $4</p>
      <button onclick="buyItem('Cigarettes')">Buy Cigarettes</button>
    </div>
    <!-- Harvest Inventory Section -->
    <h3>Your Harvest Inventory</h3>
    <div id="harvestInventory"></div>
    <button onclick="sellHarvest()">Sell Harvest</button>
    <button onclick="hidePanel('grocery-panel')">Return to Main Menu</button>
  </div>

  <!-- Community Garden Panel -->
  <div id="garden-panel" class="panel">
    <h2>Community Garden</h2>
    <p>Manage your rooftop garden. Plants need watering and fertilizing; seasonal changes affect growth.</p>
    <div id="plantSlots">
      <!-- Plant slots will be generated dynamically -->
    </div>
    <!-- Replace Sell Produce with Harvest Produce -->
    <button onclick="harvestProduce()">Harvest Produce</button>
    <button onclick="hidePanel('garden-panel')">Return to Main Screen</button>
  </div>

  <!-- Chat Panel (Room Chat / Door Chat) -->
  <div id="chatPanel" class="panel">
    <h2 id="chatRoomTitle"></h2>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="closeChat()">Close Chat</button>
  </div>
</div>

<!-- Door Modal for Front Door Interactions -->
<div id="doorModal">
  <h2 id="doorTitle">Door Interaction</h2>
  <div id="doorOptions">
    <button onclick="handleKnock()">Knock</button>
    <button onclick="showPasswordInput()">Enter Password</button>
  </div>
  <div id="passwordDiv" style="display:none;">
    <input type="text" id="doorPassword" placeholder="Enter 4-digit password">
    <button onclick="verifyPassword()">Submit Password</button>
  </div>
  <button onclick="closeDoorModal()">Cancel</button>
</div>

<script>
  // ----------------------------
  // Firebase Initialization & Config
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
    authDomain: "thephantasyreport.firebaseapp.com",
    projectId: "thephantasyreport",
    storageBucket: "thephantasyreport.firebasestorage.app",
    messagingSenderId: "887983841070",
    appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
    measurementId: "G-9MS36H0YV4"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ----------------------------
  // Room Password Mapping (default values)
  // ----------------------------
  const roomPasswords = {
    "Room 1": "0001",
    "Room 2": "0002",
    "Room 3": "0003",
    "Room 4": "0004",
    "Room 5": "0005",
    "Room 6": "0006",
    "Room 7": "0007",
    "Room 8": "0008",
    "Room 9": "0009",
    "Room 10": "0010",
    "Room 11": "0011",
    "Room 12": "0012",
    "Room 13": "0013",
    "Room 14": "0014",
    "Room 15": "0015",
    "Room 16": "0016",
    "Room 17": "0017",
    "Room 18": "0018",
    "Room 19": "0019",
    "Room 20": "0020",
    "Room 21": "0021",
    "Room 22": "0022",
    "Room 23": "0023",
    "Room 24": "0024",
    "Room 25": "0025"
  };

  // Global variables for current room and mode
  let currentRoom = "";
  // doorChatMode: false = room chat (inside), true = door chat (visitor)
  let doorChatMode = false;
  // New harvest inventory object – stored as an object with produce name keys and quantity values.
  let harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");

  // ----------------------------
  // In-App Notification Listener
  // ----------------------------
  function listenForNotifications() {
    const ownerEmail = localStorage.getItem('playerName');
    if (!ownerEmail) return;
    db.collection("notifications")
      .where("owner", "==", ownerEmail)
      .orderBy("timestamp", "desc")
      .onSnapshot(snapshot => {
        let notifications = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          notifications += `<p>${data.message}</p>`;
        });
        const panel = document.getElementById("notificationPanel");
        if (notifications) {
          panel.innerHTML = notifications;
          panel.style.display = "block";
        } else {
          panel.style.display = "none";
        }
      });
  }

  // ----------------------------
  // Utility: Clear All Game State from localStorage
  // ----------------------------
  function clearGameState() {
    const keys = ['playerName', 'characterName', 'money', 'seeds', 'mushroomSeeds', 'windSpeed', 'brakeEngaged', 'powerOutputConfirmed', 'lastInteractionTime', 'garbageLevel', 'lastGarbageUpdate', 'harvestInventory'];
    keys.forEach(key => localStorage.removeItem(key));
  }

  // ----------------------------
  // Missing Function Definitions (Trade, Direct Message, and Admin removed)
  // ----------------------------
  function showGarbagePanel() {
    document.getElementById('garbage-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function showPowerPanel() {
    document.getElementById('minigame-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function openGroceryPanel() {
    document.getElementById('grocery-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    updateHarvestInventoryUI();
  }
  function openGardenPanel() {
    document.getElementById('garden-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  // Buy item function for Grocery Store
  function buyItem(item) {
    const prices = {
      'Food Staples': 10,
      'Seeds': 2,
      'Maintenance Essentials': 5,
      'Room Decoration': 7,
      'Alcohol': 3,
      'Cigarettes': 4
    };
    let price = prices[item] || 0;
    let money = parseInt(localStorage.getItem('money')) || 50;
    if (money >= price) {
      money -= price;
      localStorage.setItem('money', money);
      alert("Purchased " + item + " for $" + price + ". Remaining money: $" + money);
      updatePlayerStatus();
    } else {
      alert("Not enough money to purchase " + item);
    }
  }

  // ----------------------------
  // Authentication Functions
  // ----------------------------
  function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById('loginPanel').style.display = 'none';
        checkCharacterExistence();
      })
      .catch(error => {
        alert("Login error: " + error.message);
      });
  }
  function registerUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById('loginPanel').style.display = 'none';
        checkCharacterExistence();
      })
      .catch(error => {
        alert("Registration error: " + error.message);
      });
  }
  function googleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        document.getElementById('loginPanel').style.display = 'none';
        checkCharacterExistence();
      })
      .catch(error => {
        alert("Google sign-in error: " + error.message);
      });
  }
  auth.onAuthStateChanged(user => {
    if(user){
      if (!localStorage.getItem('playerName')) {
        localStorage.setItem('playerName', user.email);
      }
      checkCharacterExistence();
      listenForNotifications(); // Start listening for in-app notifications
    } else {
      document.getElementById('loginPanel').style.display = 'block';
      document.getElementById('mainGame').style.display = 'none';
      document.getElementById('characterCreation').style.display = 'none';
    }
  });

  // ----------------------------
  // Character Creation & Management
  // ----------------------------
  function sanitizePlayerName(name) {
    return name.replace(/[\/\\]/g, '_');
  }
  function checkCharacterExistence() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    db.collection('players').doc(safePlayerName).get().then((doc) => {
      if (doc.exists) {
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      } else {
        document.getElementById('characterCreation').style.display = 'block';
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('displayName').innerText = playerName;
        document.getElementById('charName').value = playerName;
      }
    }).catch((error) => {
      console.error("Error checking character existence:", error);
    });
  }
  function createCharacter() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    const charName = document.getElementById('charName').value;
    const charAge = document.getElementById('charAge').value;
    const charGender = document.getElementById('charGender').value;
    const charReason = document.getElementById('charReason').value;
    const charBackstory = document.getElementById('charBackstory').value;
    const charSkills = document.getElementById('charSkills').value;
    const charInventory = document.getElementById('charInventory').value;
    const charAlliances = document.getElementById('charAlliances').value;
    const charRivalries = document.getElementById('charRivalries').value;
    const charReputation = document.getElementById('charReputation').value;
    const roomNumber = document.getElementById('roomNumber').value;
    const playerData = {
      name: charName,
      age: charAge,
      gender: charGender,
      reason: charReason,
      backstory: charBackstory,
      skills: charSkills.split(',').map(s => s.trim()),
      inventory: charInventory.split(',').map(i => i.trim()),
      alliances: charAlliances ? charAlliances.split(',').map(a => a.trim()) : [],
      rivalries: charRivalries ? charRivalries.split(',').map(r => r.trim()) : [],
      reputation: parseInt(charReputation) || 0,
      roomNumber: roomNumber,
      health: 100,
      hunger: 0,
      injury: 0,
      mood: 100,
      conditions: {
        physical: "Healthy",
        mental: "Content",
        activity: "Idle"
      },
      lastUpdated: Date.now()
    };
    db.collection('players').doc(safePlayerName).set(playerData, { merge: true })
      .then(() => {
        localStorage.setItem('characterName', charName);
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
        // Update room ownership based on chosen roomNumber.
        db.collection('rooms').doc('Room ' + roomNumber).set({
          owner: playerName
        }, { merge: true });
      })
      .catch((error) => {
        console.error("Error creating character:", error);
      });
  }
  let isEditing = false;
  function enableEdit() {
    isEditing = true;
    updatePlayerStatus();
  }
  function cancelEdit() {
    isEditing = false;
    updatePlayerStatus();
  }
  function saveBiodata() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    const newName = document.getElementById('editName').value;
    const newAge = document.getElementById('editAge').value;
    const newReason = document.getElementById('editReason').value;
    const newRoomNumber = document.getElementById('editRoomNumber').value;
    const newBackstory = document.getElementById('editBackstory').value;
    const newSkills = document.getElementById('editSkills').value;
    const newInventory = document.getElementById('editInventory').value;
    const newAlliances = document.getElementById('editAlliances').value;
    const newRivalries = document.getElementById('editRivalries').value;
    const newReputation = document.getElementById('editReputation').value;
    db.collection('players').doc(safePlayerName).set({
      name: newName,
      age: newAge,
      reason: newReason,
      roomNumber: newRoomNumber,
      backstory: newBackstory,
      skills: newSkills.split(',').map(s => s.trim()),
      inventory: newInventory.split(',').map(i => i.trim()),
      alliances: newAlliances ? newAlliances.split(',').map(a => a.trim()) : [],
      rivalries: newRivalries ? newRivalries.split(',').map(r => r.trim()) : [],
      reputation: parseInt(newReputation) || 0,
      lastUpdated: Date.now()
    }, { merge: true })
    .then(() => {
      localStorage.setItem('characterName', newName);
      isEditing = false;
      alert('Biodata updated successfully.');
      // Update room ownership if roomNumber changed.
      db.collection('rooms').doc('Room ' + newRoomNumber).set({
        owner: newName
      }, { merge: true });
    })
    .catch((error) => {
      console.error("Error updating biodata:", error);
    });
  }
  function updatePlayerStatus() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    db.collection('players').doc(safePlayerName)
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          localStorage.setItem('characterName', data.name);
          let statusHTML = `<h3>Biodata</h3>`;
          if (!isEditing) {
            statusHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
            statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
            statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
            statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
            statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
            statusHTML += `<p><strong>Gender:</strong> ${data.gender || "N/A"}</p>`;
            statusHTML += `<p><strong>Age:</strong> ${data.age}</p>`;
            statusHTML += `<p><strong>Reason:</strong> ${data.reason}</p>`;
            statusHTML += `<p><strong>Room:</strong> ${data.roomNumber ? "Room " + data.roomNumber : "Not set"}</p>`;
            statusHTML += `<p><strong>Physical:</strong> ${data.conditions.physical}</p>`;
            statusHTML += `<p><strong>Mental:</strong> ${data.conditions.mental}</p>`;
            statusHTML += `<p><strong>Activity:</strong> ${data.conditions.activity}</p>`;
            statusHTML += `<p><strong>Backstory:</strong> ${data.backstory || "N/A"}</p>`;
            statusHTML += `<p><strong>Skills:</strong> ${data.skills ? data.skills.join(", ") : "N/A"}</p>`;
            statusHTML += `<p><strong>Inventory:</strong> ${data.inventory ? data.inventory.join(", ") : "N/A"}</p>`;
            statusHTML += `<p><strong>Alliances:</strong> ${data.alliances ? data.alliances.join(", ") : "None"}</p>`;
            statusHTML += `<p><strong>Rivalries:</strong> ${data.rivalries ? data.rivalries.join(", ") : "None"}</p>`;
            statusHTML += `<p><strong>Reputation:</strong> ${data.reputation || 0}</p>`;
            statusHTML += `<p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString()}</p>`;
            statusHTML += `<button onclick="enableEdit()">Edit</button>`;
          } else {
            statusHTML += `<p><strong>Name:</strong> <input type="text" id="editName" value="${data.name}" /></p>`;
            statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
            statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
            statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
            statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
            statusHTML += `<p><strong>Gender:</strong> ${data.gender || "N/A"}</p>`;
            statusHTML += `<p><strong>Age:</strong> <input type="number" id="editAge" value="${data.age}" /></p>`;
            statusHTML += `<p><strong>Reason:</strong> <textarea id="editReason">${data.reason}</textarea></p>`;
            statusHTML += `<p><strong>Room:</strong> <input type="number" id="editRoomNumber" value="${data.roomNumber || ''}" min="1" max="25"/></p>`;
            statusHTML += `<p><strong>Backstory:</strong> <textarea id="editBackstory">${data.backstory || ""}</textarea></p>`;
            statusHTML += `<p><strong>Skills:</strong> <input type="text" id="editSkills" value="${data.skills ? data.skills.join(", ") : ""}" /></p>`;
            statusHTML += `<p><strong>Inventory:</strong> <input type="text" id="editInventory" value="${data.inventory ? data.inventory.join(", ") : ""}" /></p>`;
            statusHTML += `<p><strong>Alliances:</strong> <input type="text" id="editAlliances" value="${data.alliances ? data.alliances.join(", ") : ""}" /></p>`;
            statusHTML += `<p><strong>Rivalries:</strong> <input type="text" id="editRivalries" value="${data.rivalries ? data.rivalries.join(", ") : ""}" /></p>`;
            statusHTML += `<p><strong>Reputation:</strong> <input type="number" id="editReputation" value="${data.reputation || 0}" /></p>`;
            statusHTML += `<p><strong>Physical:</strong> ${data.conditions.physical}</p>`;
            statusHTML += `<p><strong>Mental:</strong> ${data.conditions.mental}</p>`;
            statusHTML += `<p><strong>Activity:</strong> ${data.conditions.activity}</p>`;
            statusHTML += `<p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString()}</p>`;
            statusHTML += `<button onclick="saveBiodata()">Save Changes</button> `;
            statusHTML += `<button onclick="cancelEdit()">Cancel</button>`;
          }
          // Display Money and Harvest Inventory from localStorage
          statusHTML += `<p><strong>Money:</strong> $${localStorage.getItem('money') || 50}</p>`;
          statusHTML += `<p><strong>Seeds:</strong> ${localStorage.getItem('seeds') || 0}</p>`;
          statusHTML += `<p><strong>Mushroom Seeds:</strong> ${localStorage.getItem('mushroomSeeds') || 0}</p>`;
          // Display harvest inventory
          statusHTML += `<h4>Harvest Inventory:</h4><div id="harvestInventoryDisplay"></div>`;
          document.getElementById('playerStatus').innerHTML = statusHTML;
          updateHarvestInventoryUI();
        }
      }, (error) => {
        console.error("Error getting player status:", error);
      });
  }
  // Function to update the harvest inventory display in the biodata panel and grocery store
  function updateHarvestInventoryUI() {
    // Update localStorage
    localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
    // Update in biodata panel
    const displayDiv = document.getElementById('harvestInventoryDisplay');
    if (displayDiv) {
      let html = "";
      for (let item in harvestInventory) {
        html += `<p>${item}: ${harvestInventory[item]}</p>`;
      }
      displayDiv.innerHTML = html || "<p>None</p>";
    }
    // Also update the grocery store panel inventory
    const groceryInv = document.getElementById('harvestInventory');
    if (groceryInv) {
      let html = "";
      for (let item in harvestInventory) {
        html += `<p>${item}: ${harvestInventory[item]}</p>`;
      }
      groceryInv.innerHTML = html || "<p>None</p>";
    }
  }

  // ----------------------------
  // Room Interaction & Chat Functions
  // ----------------------------
  function openRoomInteraction(roomName) {
    currentRoom = roomName;
    db.collection("rooms").doc(roomName).get().then(doc => {
      if (doc.exists) {
        const roomData = doc.data();
        const currentPlayer = localStorage.getItem("playerName");
        if (currentPlayer === roomData.owner) {
          openRoomChat(roomName);
        } else {
          showDoorModal(roomName);
        }
      } else {
        alert("Room " + roomName + " does not exist. Please contact support.");
      }
    }).catch(error => {
      console.error("Error fetching room data:", error);
      alert("Error fetching room data for " + roomName);
    });
  }
  function openRoomChat(roomName) {
    doorChatMode = false;
    document.getElementById('chatRoomTitle').textContent = roomName + " Chat (Inside)";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function openDoorChat(roomName) {
    doorChatMode = true;
    document.getElementById('chatRoomTitle').textContent = roomName + " Door Chat (Visitor)";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function listenForMessages(roomName) {
    const chatLog = document.getElementById('chatLog');
    const messagesRef = db.collection("messages");
    messagesRef
      .where("room", "==", roomName)
      .where("chatType", "==", doorChatMode ? "door" : "room")
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  function closeChat() {
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    currentRoom = "";
  }
  async function sendChatMessage() {
    const msg = document.getElementById('chatInput').value;
    if (msg.trim() !== "") {
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      try {
        await db.collection("messages").add({
          room: currentRoom,
          sender: characterName,
          content: msg,
          chatType: doorChatMode ? "door" : "room",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('chatInput').value = "";
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ----------------------------
  // Door Modal Functions
  // ----------------------------
  function showDoorModal(roomName) {
    currentRoom = roomName;
    document.getElementById('doorTitle').textContent = "You are at the door of " + roomName;
    document.getElementById('doorModal').style.display = 'block';
    document.getElementById('passwordDiv').style.display = 'none';
    document.getElementById('doorPassword').value = "";
  }
  function closeDoorModal() {
    document.getElementById('doorModal').style.display = 'none';
  }
  function showPasswordInput() {
    document.getElementById('passwordDiv').style.display = 'block';
  }
  function verifyPassword() {
    const enteredPassword = document.getElementById('doorPassword').value;
    const correctPassword = roomPasswords[currentRoom];
    if (enteredPassword === correctPassword) {
      alert("Password correct. You now enter the room.");
      closeDoorModal();
      openRoomChat(currentRoom);
    } else {
      alert("Incorrect password. Please try again or choose to knock.");
    }
  }
  function handleKnock() {
    alert("You knocked on the door. Please wait for the owner’s response.");
    db.collection("rooms").doc(currentRoom).get().then(doc => {
      if (doc.exists) {
        const owner = doc.data().owner;
        const visitor = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "A visitor";
        db.collection("notifications").add({
          owner: owner,
          room: currentRoom,
          message: `${visitor} knocked on your door of ${currentRoom}.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }).catch(error => {
      console.error("Error sending knock notification:", error);
    });
    closeDoorModal();
    openDoorChat(currentRoom);
  }

  // ----------------------------
  // Community Kitchen & Water Supplies Functions
  // ----------------------------
  function handleClick(facility) {
    if (facility === "Community Kitchen") {
      openKitchenPanel();
    } else if (facility === "Water Supplies (Laundry)") {
      openWaterPanel();
    }
  }
  function openKitchenPanel() {
    document.getElementById('kitchenPanel').style.display = 'block';
  }
  function closeKitchenPanel() {
    document.getElementById('kitchenPanel').style.display = 'none';
  }
  function processFood() {
    alert("Food processed for improved safety and efficiency.");
  }
  function openWaterPanel() {
    document.getElementById('waterPanel').style.display = 'block';
  }
  function closeWaterPanel() {
    document.getElementById('waterPanel').style.display = 'none';
  }
  function useWater() {
    alert("Water distributed for gardening, cooking, and personal use.");
  }

  // ----------------------------
  // Garden & Planting Functions
  // ----------------------------
  let plantTypes = [
    { name: "Tomato", description: "Juicy and tangy", price: 5 },
    { name: "Lettuce", description: "Crisp leaves", price: 3 },
    { name: "Carrot", description: "Crunchy roots", price: 4 },
    { name: "Potato", description: "Starchy tubers", price: 6 },
    { name: "Cucumber", description: "Refreshing", price: 4 },
    { name: "Bell Pepper", description: "Vibrant and sweet", price: 5 },
    { name: "Eggplant", description: "Creamy texture", price: 5 },
    { name: "Spinach", description: "Tender leaves", price: 3 },
    { name: "Zucchini", description: "Mild and versatile", price: 4 },
    { name: "Herb Plant", description: "Aromatic", price: 2 }
  ];
  const mushroomTypes = [
    { name: "Shiitake", description: "Rich umami", price: 10 },
    { name: "Portobello", description: "Earthy taste", price: 7 },
    { name: "Enoki", description: "Delicate flavor", price: 15 },
    { name: "Oyster", description: "Sweet and woody", price: 12 },
    { name: "Morel", description: "Nutty and earthy", price: 20 }
  ];
  let garden = {};
  // Initialize garden slots 1-10 and a special slot 11 for mushroom tree.
  for (let i = 1; i <= 10; i++) {
    garden[i] = { plantedTime: null, wateredTime: null, fertilized: false, mature: false, produceType: null };
  }
  garden[11] = { plantedTime: null, wateredTime: null, fertilized: false, mature: false, mushrooms: 0, produceType: null };

  // Update garden UI – note: maturity threshold changed from 60 to 30 minutes.
  function updateGardenUI() {
    for (let i = 1; i <= 10; i++) {
      let slot = document.getElementById('slot' + i);
      let statusSpan = slot.querySelector('.status');
      if (garden[i].plantedTime === null) {
        statusSpan.textContent = "Empty";
      } else {
        let elapsed = (Date.now() - garden[i].plantedTime) / 60000;
        let produceName = garden[i].produceType ? garden[i].produceType.name : "";
        if (elapsed >= 30 && !garden[i].mature) {  // maturity threshold is now 30 minutes
          garden[i].mature = true;
          statusSpan.textContent = "Mature: " + produceName;
          let btn = slot.querySelector('button');
          if (btn) btn.style.display = 'none';
        } else if (!garden[i].mature) {
          statusSpan.textContent = "Growing (" + Math.floor(elapsed) + " min): " + produceName;
          if (Date.now() - garden[i].wateredTime > 5 * 60000) {
            if (!slot.querySelector('.waterBtn')) {
              let waterBtn = document.createElement('button');
              waterBtn.className = 'waterBtn';
              waterBtn.textContent = "Water";
              waterBtn.onclick = function() { waterPlant(i); };
              slot.appendChild(waterBtn);
            }
          }
          if (!garden[i].fertilized && !slot.querySelector('.fertilizeBtn')) {
            let fertBtn = document.createElement('button');
            fertBtn.className = 'fertilizeBtn';
            fertBtn.textContent = "Fertilize";
            fertBtn.onclick = function() { fertilizePlant(i); };
            slot.appendChild(fertBtn);
          }
        }
      }
    }
    let treeSlot = document.getElementById('mushroomTree');
    let treeStatus = treeSlot.querySelector('.status');
    if (garden[11].plantedTime === null) {
      treeStatus.textContent = "Empty";
    } else {
      let elapsed = (Date.now() - garden[11].plantedTime) / 60000;
      let produceName = garden[11].produceType ? garden[11].produceType.name : "";
      if (elapsed >= 30 && !garden[11].mature) {
        garden[11].mature = true;
        garden[11].mushrooms = 5;
        treeStatus.textContent = "Mature: " + produceName + " (" + garden[11].mushrooms + " mushrooms)";
        let btn = treeSlot.querySelector('button');
        if (btn) btn.style.display = 'none';
      } else if (!garden[11].mature) {
        treeStatus.textContent = "Growing (" + Math.floor(elapsed) + " min): " + produceName;
      }
    }
  }

  // ----------------------------
  // Harvest Produce Functions
  // ----------------------------
  // Harvest the produce from any mature garden slot, and add to harvestInventory.
  function harvestProduce() {
    let harvested = false;
    // Loop through garden slots 1-10
    for (let i = 1; i <= 10; i++) {
      if (garden[i].mature && garden[i].produceType) {
        let produceName = garden[i].produceType.name;
        // Add one unit per slot harvest (you can adjust logic as needed)
        harvestInventory[produceName] = (harvestInventory[produceName] || 0) + 1;
        // Reset slot
        garden[i] = { plantedTime: null, wateredTime: null, fertilized: false, mature: false, produceType: null };
        harvested = true;
      }
    }
    // Check mushroom tree (slot 11)
    if (garden[11].mature && garden[11].produceType) {
      let produceName = garden[11].produceType.name;
      // For mushroom tree, add the number of mushrooms available
      harvestInventory[produceName] = (harvestInventory[produceName] || 0) + garden[11].mushrooms;
      garden[11] = { plantedTime: null, wateredTime: null, fertilized: false, mature: false, mushrooms: 0, produceType: null };
      harvested = true;
    }
    if (harvested) {
      alert("Harvest successful! Check your Harvest Inventory in your biodata and at the Grocery Stand.");
      updateGardenUI();
      updateHarvestInventoryUI();
      updatePlayerStatus();
    } else {
      alert("No mature produce to harvest.");
    }
  }

  // ----------------------------
  // Grocery Store: Sell Harvested Produce
  // ----------------------------
  function sellHarvest() {
    let totalEarnings = 0;
    // For each produce in harvestInventory, find its price from plantTypes or mushroomTypes arrays.
    for (let produce in harvestInventory) {
      let quantity = harvestInventory[produce];
      let price = 0;
      // Try to find in plantTypes
      let plant = plantTypes.find(p => p.name === produce);
      if (!plant) {
        // Try in mushroomTypes if not found in plantTypes
        plant = mushroomTypes.find(p => p.name === produce);
      }
      if (plant) {
        price = plant.price;
      }
      totalEarnings += price * quantity;
    }
    if (totalEarnings > 0) {
      let currentMoney = parseInt(localStorage.getItem('money')) || 50;
      currentMoney += totalEarnings;
      localStorage.setItem('money', currentMoney);
      alert("You sold your harvest for $" + totalEarnings + ". Current money: $" + currentMoney);
      // Clear harvest inventory
      harvestInventory = {};
      updateHarvestInventoryUI();
      updatePlayerStatus();
    } else {
      alert("Nothing to sell in your harvest inventory.");
    }
  }

  // ----------------------------
  // Room Interaction & Chat Functions
  // ----------------------------
  function openRoomInteraction(roomName) {
    currentRoom = roomName;
    db.collection("rooms").doc(roomName).get().then(doc => {
      if (doc.exists) {
        const roomData = doc.data();
        const currentPlayer = localStorage.getItem("playerName");
        if (currentPlayer === roomData.owner) {
          openRoomChat(roomName);
        } else {
          showDoorModal(roomName);
        }
      } else {
        alert("Room " + roomName + " does not exist. Please contact support.");
      }
    }).catch(error => {
      console.error("Error fetching room data:", error);
      alert("Error fetching room data for " + roomName);
    });
  }
  function openRoomChat(roomName) {
    doorChatMode = false;
    document.getElementById('chatRoomTitle').textContent = roomName + " Chat (Inside)";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function openDoorChat(roomName) {
    doorChatMode = true;
    document.getElementById('chatRoomTitle').textContent = roomName + " Door Chat (Visitor)";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function listenForMessages(roomName) {
    const chatLog = document.getElementById('chatLog');
    const messagesRef = db.collection("messages");
    messagesRef
      .where("room", "==", roomName)
      .where("chatType", "==", doorChatMode ? "door" : "room")
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  function closeChat() {
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    currentRoom = "";
  }
  async function sendChatMessage() {
    const msg = document.getElementById('chatInput').value;
    if (msg.trim() !== "") {
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      try {
        await db.collection("messages").add({
          room: currentRoom,
          sender: characterName,
          content: msg,
          chatType: doorChatMode ? "door" : "room",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('chatInput').value = "";
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ----------------------------
  // Door Modal Functions
  // ----------------------------
  function showDoorModal(roomName) {
    currentRoom = roomName;
    document.getElementById('doorTitle').textContent = "You are at the door of " + roomName;
    document.getElementById('doorModal').style.display = 'block';
    document.getElementById('passwordDiv').style.display = 'none';
    document.getElementById('doorPassword').value = "";
  }
  function closeDoorModal() {
    document.getElementById('doorModal').style.display = 'none';
  }
  function showPasswordInput() {
    document.getElementById('passwordDiv').style.display = 'block';
  }
  function verifyPassword() {
    const enteredPassword = document.getElementById('doorPassword').value;
    const correctPassword = roomPasswords[currentRoom];
    if (enteredPassword === correctPassword) {
      alert("Password correct. You now enter the room.");
      closeDoorModal();
      openRoomChat(currentRoom);
    } else {
      alert("Incorrect password. Please try again or choose to knock.");
    }
  }
  function handleKnock() {
    alert("You knocked on the door. Please wait for the owner’s response.");
    db.collection("rooms").doc(currentRoom).get().then(doc => {
      if (doc.exists) {
        const owner = doc.data().owner;
        const visitor = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "A visitor";
        db.collection("notifications").add({
          owner: owner,
          room: currentRoom,
          message: `${visitor} knocked on your door of ${currentRoom}.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }).catch(error => {
      console.error("Error sending knock notification:", error);
    });
    closeDoorModal();
    openDoorChat(currentRoom);
  }

  // ----------------------------
  // Community Kitchen & Water Supplies Functions
  // ----------------------------
  function handleClick(facility) {
    if (facility === "Community Kitchen") {
      openKitchenPanel();
    } else if (facility === "Water Supplies (Laundry)") {
      openWaterPanel();
    }
  }
  function openKitchenPanel() {
    document.getElementById('kitchenPanel').style.display = 'block';
  }
  function closeKitchenPanel() {
    document.getElementById('kitchenPanel').style.display = 'none';
  }
  function processFood() {
    alert("Food processed for improved safety and efficiency.");
  }
  function openWaterPanel() {
    document.getElementById('waterPanel').style.display = 'block';
  }
  function closeWaterPanel() {
    document.getElementById('waterPanel').style.display = 'none';
  }
  function useWater() {
    alert("Water distributed for gardening, cooking, and personal use.");
  }

  // ----------------------------
  // Power Source Simulation Functions
  // ----------------------------
  let windSpeed = localStorage.getItem('windSpeed') || 50;
  let brakeEngaged = JSON.parse(localStorage.getItem('brakeEngaged')) || false;
  let powerOutputConfirmed = JSON.parse(localStorage.getItem('powerOutputConfirmed')) || false;
  let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
  let garbageLevel = localStorage.getItem('garbageLevel') || 0;
  let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
  let powerStatus = "Unknown";
  function updateWindSpeed() {
    windSpeed = document.getElementById('windSpeedSlider').value;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    localStorage.setItem('windSpeed', windSpeed);
    updateVoltage();
    updateLastInteraction();
  }
  function toggleBrake() {
    brakeEngaged = !brakeEngaged;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    localStorage.setItem('brakeEngaged', brakeEngaged);
    updateVoltage();
    updateLastInteraction();
  }
  function togglePowerOutput() {
    powerOutputConfirmed = !powerOutputConfirmed;
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    localStorage.setItem('powerOutputConfirmed', powerOutputConfirmed);
    evaluatePowerOutput();
    updateLastInteraction();
  }
  function lubricate() {
    logPowerMessage("Lubrication complete. Moving parts are now well-oiled.");
    updateLastInteraction();
  }
  function updateVoltage() {
    let factor = brakeEngaged ? 0.5 : 1.0;
    let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
    voltage = Math.max(0, voltage);
    document.getElementById('voltageDisplay').textContent = voltage.toFixed(1);
    localStorage.setItem('voltage', voltage);
  }
  function evaluatePowerOutput() {
    if (windSpeed >= 40 && windSpeed <= 70 && powerOutputConfirmed) {
      powerStatus = "On";
    } else {
      powerStatus = "Off";
    }
    document.getElementById('powerStatusDisplay').textContent = powerStatus;
    if (powerStatus === "Off") {
      alert("Power is insufficient! Flats will experience reduced services.");
    }
  }
  // New function: simulate a gradual power event every minute
  function simulatePowerEvent() {
    if (Date.now() - lastInteractionTime > 60000) {
      windSpeed = Math.max(0, windSpeed - 5);
      localStorage.setItem('windSpeed', windSpeed);
      updateVoltage();
    }
  }
  // Updated garbage functions: update based on elapsed time and reset timestamp upon clear.
  function updateGarbageDisplay() {
    const now = Date.now();
    const elapsedMinutes = Math.floor((now - lastGarbageUpdate) / 60000);
    if (elapsedMinutes > 0) {
      garbageLevel = Math.min(100, Number(garbageLevel) + elapsedMinutes);
      lastGarbageUpdate = now;
      localStorage.setItem('garbageLevel', garbageLevel);
      localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
      document.getElementById('garbageDisplay').textContent = garbageLevel;
      if (garbageLevel > 80) {
        alert("High garbage levels detected! The community is getting sick.");
      }
    }
  }
  // New function: log garbage messages to the garbage log panel.
  function logGarbageMessage(message) {
    const garbageLog = document.getElementById('garbageLog');
    const timestamp = new Date().toLocaleTimeString();
    garbageLog.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    garbageLog.scrollTop = garbageLog.scrollHeight;
  }
  function clearGarbage() {
    garbageLevel = 0;
    lastGarbageUpdate = Date.now();
    localStorage.setItem('garbageLevel', garbageLevel);
    localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    // Get the character's name for roleplay flavor
    const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
    logGarbageMessage(`Garbage cleared by ${characterName}.`);
  }
  function simulateRandomEvent() {
    if (Date.now() - lastInteractionTime > 30000) {
      logPowerMessage("System overload due to inactivity! Flats experience a blackout for 1-2 days.");
    }
    const events = [
      "Sudden strong winds detected! Adjust wind speed or engage brakes.",
      "Low energy output observed! Check lubrication or adjust controls.",
      "Minor electrical fault occurred! Reset the circuit breaker.",
      "Dust accumulation detected! Perform a quick maintenance check."
    ];
    logPowerMessage(events[Math.floor(Math.random() * events.length)]);
  }
  function logPowerMessage(message) {
    const logDiv = document.getElementById('minigameLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  function toggleInstructions() {
    const instrDiv = document.getElementById("instructions");
    instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
  }
  function updateLastInteraction() {
    lastInteractionTime = Date.now();
    localStorage.setItem('lastInteractionTime', lastInteractionTime);
  }

  // ----------------------------
  // Season Simulation
  // ----------------------------
  let currentSeason = "Spring";
  function updateSeason() {
    const seasons = ["Spring", "Summer", "Autumn", "Winter"];
    let index = Math.floor((Date.now() / 120000)) % seasons.length;
    currentSeason = seasons[index];
    console.log("Current Season: " + currentSeason);
  }
  setInterval(updateSeason, 120000);

  // ----------------------------
  // Modal Panel Utilities
  // ----------------------------
  function hidePanel(panelId) {
    document.getElementById(panelId).style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }

  // ----------------------------
  // DOMContentLoaded & Initialization
  // ----------------------------
  window.onload = function() {
    // Generate room number options
    var roomSelect = document.getElementById('roomNumber');
    if (roomSelect) {
      for (let i = 1; i <= 25; i++) {
        let option = document.createElement('option');
        option.value = i;
        option.textContent = "Room " + i;
        roomSelect.appendChild(option);
      }
    }
    // Generate grid buttons for rooms
    var gridContainer = document.querySelector(".grid");
    if (gridContainer) {
      const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
      rooms.forEach(function(room) {
        let btn = document.createElement("button");
        btn.textContent = "Room " + room;
        btn.onclick = function() { openRoomInteraction("Room " + room); };
        gridContainer.appendChild(btn);
      });
    }
    // Generate plant slots
    var plantSlotsDiv = document.getElementById("plantSlots");
    if (plantSlotsDiv) {
      plantSlotsDiv.innerHTML = "";
      for (let i = 1; i <= 10; i++) {
        let slotDiv = document.createElement("div");
        slotDiv.className = "slot";
        slotDiv.id = "slot" + i;
        slotDiv.innerHTML = 'Slot ' + i + ': <span class="status">Empty</span> <button onclick="openPlantSelectionModal(' + i + ')">Plant Seed</button>';
        plantSlotsDiv.appendChild(slotDiv);
      }
      let treeDiv = document.createElement("div");
      treeDiv.className = "slot";
      treeDiv.id = "mushroomTree";
      treeDiv.innerHTML = 'Tree for Mushrooms: <span class="status">Empty</span> <button onclick="plantMushroomTree()">Plant Mushroom</button>';
      plantSlotsDiv.appendChild(treeDiv);
    }
    document.getElementById('windSpeedSlider').value = windSpeed;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    updateVoltage();
    updateGarbageDisplay();
    updateSeason();
    if (localStorage.getItem('playerName')) {
      checkCharacterExistence();
    }
    // Initialize harvest inventory from localStorage if exists
    harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
    // Set intervals: power event and garbage update every minute, plus existing intervals.
    setInterval(simulatePowerEvent, 60000);
    setInterval(updateGarbageDisplay, 60000);
    setInterval(updateVoltage, 5000);
    setInterval(simulateRandomEvent, 3600000);
    setInterval(updateGardenUI, 60000);
  };
</script>
</body>
</html>
