<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    /* Set body background with full image */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
      position: relative;
    }
    /* Apply full-page dark overlay using a pseudo-element */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5));
      z-index: -1;
      pointer-events: none;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .container, .panel, #characterCreation, .modal, #loginPanel {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    /* Grid of Rooms */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* Buttons */
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    .exit-button {
      position: absolute;
      left: 0;
      top: 530px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(200,150,130,0.7);
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Enlarged editing fields for Biodata */
    #playerStatus input,
    #playerStatus textarea {
      width: 100% !important;
      font-size: 16px;
      padding: 8px;
      margin-bottom: 10px;
    }
    /* Modal Styles (for plant selection, kitchen, water, door interaction) */
    .modal, #doorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea,
    #doorModal button, #doorModal input {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    /* Responsive Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    /* Responsive Chat Log */
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Biodata Panel */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Harvest Inventory Display */
    #harvestInventory {
      margin-top: 10px;
      padding: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
    }
    /* Garden Slots */
    #garden-panel .slot {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #777;
      border-radius: 4px;
    }
    #garden-panel .slot button {
      margin-left: 5px;
      padding: 3px 6px;
      font-size: 12px;
    }
    /* New panel for Login */
    #loginPanel {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
      display: none;
    }
    /* In-App Notification Panel */
    #notificationPanel {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px;
      border: 1px solid #fff;
      border-radius: 4px;
      z-index: 1002;
      display: none;
      max-width: 300px;
      font-size: 14px;
    }
    /* New Community Kitchen Panel */
    #kitchen-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Recipe Panel for Cooking (new) */
    #recipePanel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* New Water Supplies Panel */
    #water-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Chat area within panels */
    .panel .chatArea {
      border: 1px solid #ccc;
      padding: 10px;
      height: 150px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    
    /* NEW: Grocery Stand Styles - Option 2 with Tron Blue Neon Accents */
    .grocery-items-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .grocery-item {
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      color: #e0e0e0;
    }
    .grocery-item:hover {
      transform: scale(1.03);
      box-shadow: 0 0 10px #00bfff;
    }
    .grocery-item p {
      margin: 0 0 8px;
      font-size: 15px;
      font-weight: bold;
    }
    .grocery-item button {
      background-color: #00bfff;
      border: none;
      border-radius: 5px;
      padding: 8px;
      color: #222;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    .grocery-item button:hover {
      background-color: #009acd;
    }
    
    /* Grocery Stand Tabbed Section Specific Styles */
    .tab-headers {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .tab-button {
      background-color: #444;
      border: 1px solid #999;
      border-radius: 4px;
      color: #eee;
      cursor: pointer;
      padding: 10px;
      margin: 0 5px;
    }
    .tab-button:hover {
      background-color: #555;
    }
    .tab-button.active {
      background-color: #00bfff;
      color: #222;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
  <!-- Firebase SDKs: Auth and Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Wrap all content in a wrapper div to apply the overlay -->
  <div class="wrapper">
    <!-- Hidden YouTube Player for Ambient Music -->
    <iframe id="bgMusic" width="0" height="0" src="https://www.youtube.com/embed/gSwi1Tk1gV8?autoplay=1&loop=1&playlist=gSwi1Tk1gV8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position:absolute; left:-9999px;"></iframe>
  
    <!-- Toggle Music Player Button -->
    <div style="text-align:center; margin-top:10px;">
      <button onclick="toggleMusicPlayer()">Toggle Music Player</button>
    </div>
  
    <!-- Login Panel -->
    <div id="loginPanel">
      <h3>Login / Register</h3>
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button onclick="loginUser()">Login</button>
      <button onclick="registerUser()">Register</button>
      <button onclick="googleSignIn()">Sign in with Google</button>
    </div>
  
    <!-- Character Creation Section -->
    <div id="characterCreation">
      <h3>Create Your Character</h3>
      <p>Welcome, <span id="displayName"></span>!</p>
      <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
        <input type="text" id="charName" placeholder="Name" required>
        <input type="number" id="charAge" placeholder="Age" required>
        <select id="charGender" required>
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
        <textarea id="charBackstory" placeholder="Backstory" required></textarea>
        <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
        <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
        <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
        <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
        <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
        <select id="roomNumber" required>
          <option value="">Select Room Number</option>
        </select>
        <button type="submit">Create Character</button>
      </form>
    </div>
  
    <!-- Main Game Section -->
    <div id="mainGame" style="display: none;">
      <!-- Notification Panel -->
      <div id="notificationPanel"></div>
      <!-- Main Screen -->
      <div id="main-screen">
        <div class="container">
          <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
          <button class="exit-button" onclick="signOutUser()">Exit</button>
          <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
          <div class="grid">
            <!-- Room buttons generated dynamically -->
          </div>
          <button class="power-room" onclick="showPowerPanel()">
            Power Room <span id="powerAlert" style="display:none; font-size:1.2em; color:red;">!</span>
          </button>
        </div>
        <div class="facilities">
          <button onclick="openKitchenPanel()">Community Kitchen</button>
          <button onclick="openGroceryPanel()">Groceries Stand</button>
          <button onclick="openWaterPanel()">Water Supplies (Laundry)</button>
          <button onclick="togglePlayerStatus()">Biodata</button>
        </div>
        <div id="playerStatus">
          <!-- Biodata dynamically updated -->
        </div>
      </div>
  
      <!-- Panels -->
      <!-- Power Panel -->
      <div id="minigame-panel" class="panel">
        <h2>Wind Turbine Control Panel</h2>
        <p><strong>Objective:</strong> Ensure the turbine provides electricity, water heating, and lighting.</p>
        <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
        <div id="instructions" style="display: none;">
          <p>
            <strong>Step 1:</strong> Adjust the wind speed slider (optimal range: 40–70).<br>
            <strong>Step 2:</strong> Pull the electrical output lever to toggle power supply.<br>
            <strong>Step 3:</strong> Check water pressure and heater levels by pressing the corresponding buttons.<br>
            <strong>Step 4:</strong> Ensure the overall light status is "On".<br><br>
            <em>Note:</em> Every minute one of five malfunctions may occur. Follow the on-screen instructions to fix them; failure will negatively affect your biodata.
          </p>
        </div>
        <div class="control">
          <label for="windSpeedSlider">Wind Speed:</label>
          <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
          <span id="windSpeedValue"></span>
        </div>
        <div class="control">
          <label>Electrical Output:</label>
          <button id="outputLeverButton" onclick="toggleElectricalOutput()">Toggle Output</button>
        </div>
        <div class="control">
          <label>Water Pressure:</label>
          <button id="checkWaterPressureButton" onclick="checkWaterPressure()">Check Water</button>
        </div>
        <div class="control">
          <label>Heater Level:</label>
          <button id="checkHeaterLevelButton" onclick="checkHeaterLevel()">Check Heater</button>
        </div>
        <div class="control">
          <label>Light Status:</label>
          <span id="lightStatusDisplay">Unknown</span>
        </div>
        <div class="control">
          <label>Voltage:</label>
          <span id="voltageDisplay">0.0</span>
        </div>
        <div class="control">
          <h4>Service Impact & Suggestions:</h4>
          <div id="powerSuggestions" style="font-size:14px; background:rgba(255,255,255,0.1); padding:5px; border-radius:4px;"></div>
        </div>
        <div class="control">
          <button onclick="hidePanel('minigame-panel')">Return to Main Menu</button>
        </div>
        <h3>System Log:</h3>
        <div id="minigameLog"></div>
        <div class="control">
          <label>Power Status:</label>
          <span id="powerStatusDisplay">Unknown</span>
        </div>
      </div>
  
      <!-- Garbage Chute Panel -->
      <div id="garbage-panel" class="panel">
        <h2>Garbage Chute Control</h2>
        <p><strong>Objective:</strong> Clear accumulated garbage before it causes a community health crisis.</p>
        <div class="control">
          <label>Garbage Level:</label>
          <span id="garbageDisplay"></span> / 100
        </div>
        <div class="control">
          <button onclick="clearGarbage()">Clear Garbage</button>
        </div>
        <div class="control">
          <button onclick="hidePanel('garbage-panel')">Return to Main Menu</button>
        </div>
        <h3>Garbage Log:</h3>
        <div id="garbageLog"></div>
      </div>
  
      <!-- Grocery Stand Tabbed Section (ONLY ONE instance) -->
      <!-- Grocery Stand Tabbed Section Start -->
      <div id="grocery-panel" class="panel">
        <h2>Grocery Store</h2>
        <p>Purchase essential items. Prices may vary with electricity availability.</p>
        
        <!-- Tab Headers -->
        <div class="tab-headers">
          <button class="tab-button active" onclick="openTab(event, 'buyTab')">Buy Items</button>
          <button class="tab-button" onclick="openTab(event, 'sellTab')">Sell Items</button>
        </div>
        
        <!-- Tab Content -->
        <div id="buyTab" class="tab-content" style="display: block;">
          <div id="buySection" class="grocery-items-container">
            <div class="grocery-item">
              <p><strong>Food Staples</strong> - $10<br><em>Basic nourishment to reduce hunger.</em></p>
              <button onclick="buyItem('Food Staples')">Buy Food</button>
            </div>
            <div id="seedList" class="grocery-item">
              <h4>Seeds for Community Garden</h4>
              <!-- Seed items will be generated here -->
            </div>
            <div id="mushroomList" class="grocery-item">
              <h4>Mushrooms for Cultivation</h4>
              <!-- Mushroom items will be generated here -->
            </div>
            <div class="grocery-item">
              <p><strong>Lubricant Oil</strong> - $5<br><em>Essential for keeping the power panel running smoothly.</em></p>
              <button onclick="buyItem('Lubricant Oil')">Buy Lubricant Oil</button>
            </div>
            <div class="grocery-item">
              <p><strong>Alcohol</strong> - $3<br><em>Boosts mood but may have minor setbacks on health.</em></p>
              <button onclick="buyItem('Alcohol')">Buy Alcohol</button>
            </div>
            <div class="grocery-item">
              <p><strong>Cigarettes</strong> - $4<br><em>Temporarily improves mood but reduces health over time.</em></p>
              <button onclick="buyItem('Cigarettes')">Buy Cigarettes</button>
            </div>
            <!-- Additional items such as Health Items (First Aid Kit) will be added dynamically if not present -->
          </div>
        </div>
        
        <div id="sellTab" class="tab-content" style="display: none;">
          <div id="sellSection">
            <h3>Sell Your Harvest</h3>
            <div id="sellInventory">
              <!-- Dynamically generated sell inventory list -->
            </div>
            <button onclick="sellHarvest()">Sell Selected Items</button>
          </div>
        </div>
        
        <button onclick="hidePanel('grocery-panel')">Return to Main Menu</button>
      </div>
      <!-- Grocery Stand Tabbed Section End -->
  
      <!-- Community Garden Panel -->
      <div id="garden-panel" class="panel">
        <h2>Community Garden</h2>
        <p>Manage your rooftop garden. Plants (seeds or mushrooms) need water to mature. They require 5 minutes and sufficient water to grow.</p>
        <div id="plantSlots">
          <!-- Garden slots generated dynamically -->
        </div>
        <button onclick="harvestProduce()">Harvest Produce</button>
        <button onclick="hidePanel('garden-panel')">Return to Main Menu</button>
      </div>
  
      <!-- Community Kitchen Panel -->
      <div id="kitchen-panel" class="panel">
        <h2>Community Kitchen</h2>
        <p>Access the cookbook to view 20 available recipes. Each recipe has a single-sentence description based on plants and mushrooms grown in the community garden, along with its benefits and setbacks.</p>
        <button onclick="openRecipePanel()">Cook</button>
        <div id="stoveStatus" style="margin-top:10px; font-size:14px;">Stove: Available</div>
        <div id="cookingProcess" style="display:none; margin-top:10px; font-size:14px;">
          <p>Cooking in progress... Please wait 1 minute.</p>
        </div>
        <div>
          <h4>Kitchen Chat</h4>
          <div class="chatArea" id="kitchenChatLog"></div>
          <input type="text" id="kitchenChatInput" placeholder="Type a message...">
          <button onclick="sendKitchenChat()">Send</button>
        </div>
        <button onclick="hidePanel('kitchen-panel')">Return to Main Menu</button>
      </div>
  
      <!-- Recipe Panel -->
      <div id="recipePanel" class="panel">
        <h2>Recipe Selection</h2>
        <div id="recipeListContainer" style="max-height:300px; overflow-y:auto;"></div>
        <button onclick="hidePanel('recipePanel'); openKitchenPanel();">Cancel</button>
      </div>
  
      <!-- Water Supplies Panel -->
      <div id="water-panel" class="panel">
        <h2>Water Supplies (Laundry)</h2>
        <p>Water pressure is directly linked to the performance of the power panel. Use the washing machine to clean clothes – remember, low power output may result in lower water pressure.</p>
        <div>
          <p><strong>Water Pressure:</strong> <span id="waterPressureDisplay">Calculating...</span> PSI</p>
          <p><strong>Water Inventory:</strong> <span id="waterInventoryDisplay">0</span> units</p>
          <button onclick="collectWater()">Collect Water</button>
        </div>
        <div>
          <h4>Washing Machine</h4>
          <button onclick="washClothes()">Wash Clothes</button>
          <div class="chatArea" id="laundryChatLog"></div>
          <input type="text" id="laundryChatInput" placeholder="Type a message...">
          <button onclick="sendLaundryChat()">Send</button>
        </div>
        <button onclick="hidePanel('water-panel')">Return to Main Menu</button>
      </div>
  
      <!-- Chat Panel -->
      <div id="chatPanel" class="panel">
        <h2 id="chatRoomTitle"></h2>
        <div id="chatLog"></div>
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button onclick="sendChatMessage()">Send</button>
        <button onclick="closeChat()">Close Chat</button>
      </div>
    </div>
  
    <!-- Door Modal -->
    <div id="doorModal">
      <h2 id="doorTitle">Door Interaction</h2>
      <div id="doorOptions">
        <button onclick="handleKnock()">Knock</button>
        <button onclick="showPasswordInput()">Enter Password</button>
      </div>
      <div id="passwordDiv" style="display:none;">
        <input type="text" id="doorPassword" placeholder="Enter 4-digit password">
        <button onclick="verifyPassword()">Submit Password</button>
      </div>
      <button onclick="closeDoorModal()">Cancel</button>
    </div>
  </div>
  
  <script>
    // Store original background settings (main menu background)
    const originalBackground = "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed";
  
    // ----------------------------
    // Firebase Initialization & Config
    // ----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
      authDomain: "thephantasyreport.firebaseapp.com",
      projectId: "thephantasyreport",
      storageBucket: "thephantasyreport.firebasestorage.app",
      messagingSenderId: "887983841070",
      appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
      measurementId: "G-9MS36H0YV4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  
    // ----------------------------
    // Room Password Mapping
    // ----------------------------
    const roomPasswords = {
      "Room 1": "0001",
      "Room 2": "1414",
      "Room 3": "0003",
      "Room 4": "0004",
      "Room 5": "0005",
      "Room 6": "0006",
      "Room 7": "0007",
      "Room 8": "0008",
      "Room 9": "0009",
      "Room 10": "0010",
      "Room 11": "0011",
      "Room 12": "0715",
      "Room 13": "0013",
      "Room 14": "0014",
      "Room 15": "0015",
      "Room 16": "0016",
      "Room 17": "0017",
      "Room 18": "0018",
      "Room 19": "0019",
      "Room 20": "0020",
      "Room 21": "0021",
      "Room 22": "0022",
      "Room 23": "0023",
      "Room 24": "0024",
      "Room 25": "0025"
    };
  
    // Global variables
    let currentRoom = "";
    let doorChatMode = false;
    let harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
    let waterInventory = parseInt(localStorage.getItem('water')) || 0;
    // Global gardenSlots for 10 slots
    let gardenSlots = Array.from({length: 10}, (_, i) => ({
      slot: i + 1,
      type: null,
      watered: false,
      timer: null
    }));
  
    // Grocery Items Arrays: 20 Seed Types and 5 Mushroom Types
    const seedTypes = [
      "Sunflower Seed", "Pumpkin Seed", "Corn Seed", "Wheat Seed", "Rice Seed",
      "Barley Seed", "Oat Seed", "Millet Seed", "Sorghum Seed", "Quinoa Seed",
      "Flax Seed", "Sesame Seed", "Chia Seed", "Cumin Seed", "Mustard Seed",
      "Fennel Seed", "Caraway Seed", "Anise Seed", "Poppy Seed", "Basil Seed"
    ];
    const mushroomTypes = [
      "Button Mushroom", "Portobello Mushroom", "Shiitake Mushroom", "Oyster Mushroom", "Enoki Mushroom"
    ];
  
    // ----------------------------
    // Centralized Recipes Array
    // ----------------------------
    const recipes = [];
    for (let i = 0; i < 10; i++) {
      recipes.push({
        title: "Garden Salad " + (i + 1),
        description: "A refreshing mix of greens and button mushrooms that boosts vitality, though too much may slightly lower hunger.",
        ingredients: [
          { name: "Sunflower Seed", amount: 2 },
          { name: "Button Mushroom", amount: 3 }
        ],
        water: "100ml",
        benefits: "Boosts energy and mood.",
        setbacks: "Slightly decreases hunger."
      });
      recipes.push({
        title: "Mushroom Medley " + (i + 1),
        description: "A savory dish combining portobello mushrooms with pumpkin seeds that improves strength but may affect mood if overconsumed.",
        ingredients: [
          { name: "Portobello Mushroom", amount: 2 },
          { name: "Pumpkin Seed", amount: 2 }
        ],
        water: "120ml",
        benefits: "Improves strength.",
        setbacks: "May lower mood if eaten in excess."
      });
    }
  
    // ----------------------------
    // Helper Functions: Update Mood and Hunger
    // ----------------------------
    function updateMood(delta) {
      const playerEmail = localStorage.getItem('playerName');
      if (!playerEmail) return;
      const safePlayerName = sanitizePlayerName(playerEmail);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentMood = doc.data().mood || 100;
          let newMood = Math.max(0, currentMood + delta);
          db.collection('players').doc(safePlayerName).set({ mood: newMood, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
  
    function updateHunger(delta) {
      const playerEmail = localStorage.getItem('playerName');
      if (!playerEmail) return;
      const safePlayerName = sanitizePlayerName(playerEmail);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentHunger = doc.data().hunger || 0;
          let newHunger = Math.max(0, currentHunger + delta);
          db.collection('players').doc(safePlayerName).set({ hunger: newHunger, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
  
    // ----------------------------
    // Inventory Functions
    // ----------------------------
    function addItem(item, qty = 1) {
      if (harvestInventory[item]) {
        harvestInventory[item] += qty;
      } else {
        harvestInventory[item] = qty;
      }
      localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
      updateHarvestInventoryUI();
    }
  
    function removeItem(item, qty = 1) {
      if (harvestInventory[item]) {
        harvestInventory[item] = Math.max(0, harvestInventory[item] - qty);
        if (harvestInventory[item] === 0) {
          delete harvestInventory[item];
        }
      }
      localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
      updateHarvestInventoryUI();
    }
  
    function updateHarvestInventoryUI() {
      const invDiv = document.getElementById('harvestInventory');
      let html = "";
      for (let item in harvestInventory) {
        html += `<p>${item}: ${harvestInventory[item]}</p>`;
      }
      if (!html) html = "<p>None</p>";
      invDiv.innerHTML = html;
    }
  
    // ----------------------------
    // In-App Notification Listener
    // ----------------------------
    function listenForNotifications() {
      const ownerEmail = localStorage.getItem('playerName');
      if (!ownerEmail) return;
      db.collection("notifications")
        .where("owner", "==", ownerEmail)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          let notifications = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            notifications += `<p>${data.message}</p>`;
          });
          const panel = document.getElementById("notificationPanel");
          if (notifications) {
            panel.innerHTML = notifications;
            panel.style.display = "block";
          } else {
            panel.style.display = "none";
          }
        });
    }
  
    // ----------------------------
    // Utility: Clear All Game State
    // ----------------------------
    function clearGameState() {
      const keys = ['playerName', 'characterName', 'money', 'seeds', 'mushroomSeeds', 'windSpeed', 'lastInteractionTime', 'garbageLevel', 'lastGarbageUpdate', 'harvestInventory', 'water'];
      keys.forEach(key => localStorage.removeItem(key));
    }
  
    // ----------------------------
    // Sign Out Function
    // ----------------------------
    function signOutUser() {
      firebase.auth().signOut().then(() => {
        clearGameState();
        window.location.href = "index.html";
      }).catch((error) => {
        console.error("Error signing out: ", error);
      });
    }
  
    // ----------------------------
    // Panel Toggles and Navigation
    // ----------------------------
    function showGarbagePanel() {
      document.getElementById('garbage-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
    }
    function showPowerPanel() {
      document.body.style.backgroundImage = "url('https://i.pinimg.com/736x/2d/d9/76/2dd9762815138628d3c380fe097241d2.jpg')";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
      document.getElementById('minigame-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
    }
    function openGroceryPanel() {
      document.getElementById('grocery-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      generateGroceryItems();
      updateHarvestInventoryUI();
    }
    function openGardenPanel() {
      document.body.style.backgroundImage = "url('https://i.pinimg.com/736x/1a/97/af/1a97af089b326864a32ddb9f788c7c2d.jpg')";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
      document.getElementById('garden-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      renderGardenSlots();
    }
    function openKitchenPanel() {
      document.getElementById('kitchen-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
    }
    function openWaterPanel() {
      document.getElementById('water-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const pressure = Math.round(voltage * 0.8);
      document.getElementById('waterPressureDisplay').textContent = pressure;
      document.getElementById('waterInventoryDisplay').textContent = waterInventory;
    }
  
    // ----------------------------
    // Hide Panel Function (revert background)
    // ----------------------------
    function hidePanel(panelId) {
      document.getElementById(panelId).style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';
      // Reset the background to the original settings
      document.body.style.backgroundImage = "url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2')";
      document.body.style.backgroundRepeat = "no-repeat";
      document.body.style.backgroundAttachment = "fixed";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
    }
  
    // ----------------------------
    // Buy Item Function
    // ----------------------------
    function buyItem(item) {
      const prices = {
        'Food Staples': 10,
        'Lubricant Oil': 5,
        'Alcohol': 3,
        'Cigarettes': 4
      };
      let price = prices[item] || 2;
      let money = parseInt(localStorage.getItem('money')) || 50;
      if (money >= price) {
        money -= price;
        localStorage.setItem('money', money);
        alert("Purchased " + item + " for $" + price + ". Remaining money: $" + money);
        addItem(item, 1);
        applyItemEffects(item);
        updatePlayerStatus();
      } else {
        alert("Not enough money to purchase " + item);
      }
    }
  
    function applyItemEffects(item) {
      switch(item) {
        case "Food Staples":
          updateHunger(-5);
          updateMood(2);
          break;
        case "Lubricant Oil":
          updateMood(1);
          break;
        default:
          if(item.includes("Seed")) {
            updateMood(2);
          } else if(item.includes("Mushroom")) {
            updateMood(1);
            updateHunger(-1);
          } else if(item === "Alcohol") {
            updateMood(3);
            updateHunger(1);
          } else if(item === "Cigarettes") {
            updateMood(2);
            updateHunger(1);
          }
          break;
      }
    }
  
    // ----------------------------
    // Authentication Functions
    // ----------------------------
    function loginUser() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('loginPanel').style.display = 'none';
          checkCharacterExistence();
        })
        .catch(error => {
          alert("Login error: " + error.message);
        });
    }
    function registerUser() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('loginPanel').style.display = 'none';
          checkCharacterExistence();
        })
        .catch(error => {
          alert("Registration error: " + error.message);
        });
    }
    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then(result => {
          document.getElementById('loginPanel').style.display = 'none';
          checkCharacterExistence();
        })
        .catch(error => {
          alert("Google sign-in error: " + error.message);
        });
    }
    auth.onAuthStateChanged(user => {
      if (user) {
        if (!localStorage.getItem('playerName')) {
          localStorage.setItem('playerName', user.email);
        }
        checkCharacterExistence();
        listenForNotifications();
      } else {
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('characterCreation').style.display = 'none';
      }
    });
  
    // ----------------------------
    // Character Creation & Management
    // ----------------------------
    function sanitizePlayerName(name) {
      return name.replace(/[\/\\]/g, '_');
    }
    function checkCharacterExistence() {
      const playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then((doc) => {
        if (doc.exists) {
          document.getElementById('characterCreation').style.display = 'none';
          document.getElementById('mainGame').style.display = 'block';
          updatePlayerStatus();
        } else {
          document.getElementById('characterCreation').style.display = 'block';
          document.getElementById('mainGame').style.display = 'none';
          document.getElementById('displayName').innerText = playerName;
          document.getElementById('charName').value = playerName;
        }
      }).catch((error) => {
        console.error("Error checking character existence:", error);
      });
    }
    function createCharacter() {
      const playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      const charName = document.getElementById('charName').value;
      const charAge = document.getElementById('charAge').value;
      const charGender = document.getElementById('charGender').value;
      const charReason = document.getElementById('charReason').value;
      const charBackstory = document.getElementById('charBackstory').value;
      const charSkills = document.getElementById('charSkills').value;
      const charInventory = document.getElementById('charInventory').value;
      const charAlliances = document.getElementById('charAlliances').value;
      const charRivalries = document.getElementById('charRivalries').value;
      const charReputation = document.getElementById('charReputation').value;
      const roomNumber = document.getElementById('roomNumber').value;
      const playerData = {
        name: charName,
        age: charAge,
        gender: charGender,
        reason: charReason,
        backstory: charBackstory,
        skills: charSkills.split(',').map(s => s.trim()),
        inventory: charInventory.split(',').map(i => i.trim()),
        alliances: charAlliances ? charAlliances.split(',').map(a => a.trim()) : [],
        rivalries: charRivalries ? charRivalries.split(',').map(r => r.trim()) : [],
        reputation: parseInt(charReputation) || 0,
        roomNumber: roomNumber,
        health: 100,
        hunger: 0,
        injury: 0,
        mood: 100,
        conditions: {
          physical: "Healthy",
          mental: "Content",
          activity: "Idle"
        },
        lastUpdated: Date.now()
      };
      db.collection('players').doc(safePlayerName).set(playerData, { merge: true })
        .then(() => {
          localStorage.setItem('characterName', charName);
          document.getElementById('characterCreation').style.display = 'none';
          document.getElementById('mainGame').style.display = 'block';
          updatePlayerStatus();
          db.collection('rooms').doc('Room ' + roomNumber).set({
            owner: playerName
          }, { merge: true });
        })
        .catch((error) => {
          console.error("Error creating character:", error);
        });
    }
    let isEditing = false;
    function enableEdit() {
      isEditing = true;
      updatePlayerStatus();
    }
    function cancelEdit() {
      isEditing = false;
      updatePlayerStatus();
    }
    function togglePlayerStatus() {
      const biodataDiv = document.getElementById('playerStatus');
      biodataDiv.style.display = (biodataDiv.style.display === "none" || biodataDiv.style.display === "") ? "block" : "none";
    }
    function updatePlayerStatus() {
      const playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName)
        .onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            localStorage.setItem('characterName', data.name);
            let statusHTML = `<h3>Biodata</h3>`;
            if (!isEditing) {
              let coreStatsHTML = `<h4>Core Stats</h4>`;
              coreStatsHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
              coreStatsHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
              coreStatsHTML += `<div style="background:#444; border:1px solid #222; width:100%; height:20px; border-radius:5px; margin:5px 0;">
                   <div style="background:#4CAF50; width:${data.health}%; height:100%; border-radius:5px;"></div>
                  </div>`;
              coreStatsHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
              coreStatsHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
              coreStatsHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
              coreStatsHTML += `<p><strong>Room:</strong> ${data.roomNumber ? "Room " + data.roomNumber : "Not set"}</p>`;
              coreStatsHTML += `<p><strong>Reputation:</strong> ${data.reputation || 0}</p>`;
              let narrativeHTML = `<h4>Background</h4>`;
              narrativeHTML += `<p><strong>Reason:</strong> ${data.reason || "N/A"}</p>`;
              narrativeHTML += `<p><strong>Backstory:</strong> ${data.backstory || "N/A"}</p>`;
              narrativeHTML += `<p><strong>Skills:</strong> ${data.skills ? data.skills.join(", ") : "N/A"}</p>`;
              narrativeHTML += `<p><strong>Alliances:</strong> ${data.alliances ? data.alliances.join(", ") : "None"}</p>`;
              narrativeHTML += `<p><strong>Rivalries:</strong> ${data.rivalries ? data.rivalries.join(", ") : "None"}</p>`;
              let inventoryHTML = `<h4>Inventory</h4>`;
              for (let item in harvestInventory) {
                inventoryHTML += `<p>${item}: ${harvestInventory[item]}</p>`;
              }
              if (!inventoryHTML) inventoryHTML += `<p>None</p>`;
              statusHTML += `<div id="coreStats">${coreStatsHTML}</div>`;
              statusHTML += `<div id="narrativeStats" style="display:none;">${narrativeHTML}</div>`;
              statusHTML += `<button id="toggleNarrative" onclick="toggleNarrative()">Show Narrative</button>`;
              statusHTML += `<button onclick="enableEdit()">Edit Biodata</button>`;
              statusHTML += inventoryHTML;
            } else {
              statusHTML += `<h3>Edit Character</h3>`;
              statusHTML += `<div><strong>Core Stats</strong><br>`;
              statusHTML += `<p><strong>Name:</strong> <input type="text" id="editName" value="${data.name}" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
              statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
              statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
              statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
              statusHTML += `<p><strong>Room:</strong> <input type="number" id="editRoomNumber" value="${data.roomNumber || ''}" min="1" max="25" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Reputation:</strong> <input type="number" id="editReputation" value="${data.reputation || 0}" style="height:40px; font-size:16px;" /></p></div>`;
              statusHTML += `<div><strong>Background</strong><br>`;
              statusHTML += `<p><strong>Reason:</strong> <textarea id="editReason" style="height:80px; font-size:16px;">${data.reason}</textarea></p>`;
              statusHTML += `<p><strong>Backstory:</strong> <textarea id="editBackstory" style="height:80px; font-size:16px;">${data.backstory || ""}</textarea></p>`;
              statusHTML += `<p><strong>Skills:</strong> <input type="text" id="editSkills" value="${data.skills ? data.skills.join(", ") : ""}" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Alliances:</strong> <input type="text" id="editAlliances" value="${data.alliances ? data.alliances.join(", ") : ""}" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Rivalries:</strong> <input type="text" id="editRivalries" value="${data.rivalries ? data.rivalries.join(", ") : ""}" style="height:40px; font-size:16px;" /></p></div>`;
              statusHTML += `<button onclick="saveBiodata()">Save Changes</button>`;
              statusHTML += `<button onclick="cancelEdit()">Cancel</button>`;
            }
            statusHTML += `<p><strong>Money:</strong> $${localStorage.getItem('money') || 50}</p>`;
            statusHTML += `<p><strong>Seeds:</strong> ${localStorage.getItem('seeds') || 0}</p>`;
            statusHTML += `<p><strong>Mushroom Seeds:</strong> ${localStorage.getItem('mushroomSeeds') || 0}</p>`;
            document.getElementById('playerStatus').innerHTML = statusHTML;
            updateHarvestInventoryUI();
          }
        }, (error) => {
          console.error("Error getting player status:", error);
        });
    }
    function toggleNarrative() {
      const narrativeDiv = document.getElementById('narrativeStats');
      const toggleButton = document.getElementById('toggleNarrative');
      if (narrativeDiv.style.display === "none") {
        narrativeDiv.style.display = "block";
        toggleButton.textContent = "Hide Narrative";
      } else {
        narrativeDiv.style.display = "none";
        toggleButton.textContent = "Show Narrative";
      }
    }
    function saveBiodata() {
      const playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      const updatedData = {
        name: document.getElementById('editName').value,
        roomNumber: document.getElementById('editRoomNumber').value,
        reputation: parseInt(document.getElementById('editReputation').value) || 0,
        reason: document.getElementById('editReason').value,
        backstory: document.getElementById('editBackstory').value,
        skills: document.getElementById('editSkills').value.split(',').map(s => s.trim()),
        alliances: document.getElementById('editAlliances').value.split(',').map(a => a.trim()),
        rivalries: document.getElementById('editRivalries').value.split(',').map(r => r.trim()),
        lastUpdated: Date.now()
      };
      db.collection('players').doc(safePlayerName).set(updatedData, { merge: true })
        .then(() => {
          isEditing = false;
          updatePlayerStatus();
        })
        .catch(error => {
          console.error("Error saving biodata:", error);
        });
    }
  
    // ----------------------------
    // Community Kitchen Chat & Cooking Functions
    // ----------------------------
    function sendKitchenChat() {
      const msg = document.getElementById('kitchenChatInput').value;
      if (msg.trim() !== "") {
        db.collection("messages").add({
          room: "Community Kitchen",
          sender: localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown",
          content: msg,
          chatType: "kitchen",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('kitchenChatInput').value = "";
      }
    }
    function listenForKitchenChat() {
      const chatLog = document.getElementById('kitchenChatLog');
      db.collection("messages")
        .where("room", "==", "Community Kitchen")
        .where("chatType", "==", "kitchen")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    function openRecipePanel() {
      const container = document.getElementById('recipeListContainer');
      container.innerHTML = "";
      recipes.forEach((r, index) => {
        const div = document.createElement('div');
        div.style.borderBottom = "1px solid #555";
        div.style.padding = "5px 0";
        div.innerHTML = `<strong>${index+1}: ${r.title}</strong><br>
                         ${r.description}<br>
                         <em>Ingredients:</em> ${r.ingredients.map(i => `${i.name} (${i.amount})`).join(", ")}<br>
                         <em>Water:</em> ${r.water}<br>
                         <em>Benefits:</em> ${r.benefits} &nbsp;&nbsp; <em>Setbacks:</em> ${r.setbacks}<br>
                         <button onclick="cookRecipe(recipes[${index}])">Cook</button>`;
        container.appendChild(div);
      });
      document.getElementById('recipePanel').style.display = 'block';
      document.getElementById('kitchen-panel').style.display = 'none';
    }
    function cookRecipe(recipe) {
      document.getElementById('recipePanel').style.display = 'none';
      let missingIngredients = [];
      recipe.ingredients.forEach(ing => {
        if (!harvestInventory[ing.name] || harvestInventory[ing.name] < ing.amount) {
          missingIngredients.push(`${ing.name} (need ${ing.amount}, have ${harvestInventory[ing.name] || 0})`);
        }
      });
      if (missingIngredients.length > 0) {
        alert("Cannot cook recipe. Missing ingredients:\n" + missingIngredients.join("\n"));
        openRecipePanel();
        return;
      }
      recipe.ingredients.forEach(ing => {
        removeItem(ing.name, ing.amount);
      });
      document.getElementById("stoveStatus").textContent = "Stove: In Use";
      document.getElementById("cookingProcess").style.display = "block";
      setTimeout(() => {
        document.getElementById("cookingProcess").style.display = "none";
        document.getElementById("stoveStatus").textContent = "Stove: Available";
        alert("Cooking complete! You made: " + recipe.title);
        addItem("Cooked: " + recipe.title, 1);
      }, 60000);
    }
  
    // ----------------------------
    // Water Supplies Chat & Washing Machine Functions
    // ----------------------------
    function sendLaundryChat() {
      const msg = document.getElementById('laundryChatInput').value;
      if (msg.trim() !== "") {
        db.collection("messages").add({
          room: "Water Supplies",
          sender: localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown",
          content: msg,
          chatType: "laundry",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('laundryChatInput').value = "";
      }
    }
    function listenForLaundryChat() {
      const chatLog = document.getElementById('laundryChatLog');
      db.collection("messages")
        .where("room", "==", "Water Supplies")
        .where("chatType", "==", "laundry")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    function washClothes() {
      alert("You washed your clothes. Your health improves slightly.");
      updateMood(3);
    }
  
    // ----------------------------
    // Room Interaction & Chat Functions
    // ----------------------------
    function openRoomInteraction(roomName) {
      currentRoom = roomName;
      db.collection("rooms").doc(roomName).get().then(doc => {
        if (doc.exists) {
          const roomData = doc.data();
          const currentPlayer = localStorage.getItem("playerName");
          if (currentPlayer === roomData.owner) {
            openRoomChat(roomName);
          } else {
            showDoorModal(roomName);
          }
        } else {
          alert("Room " + roomName + " does not exist. Please contact support.");
        }
      }).catch(error => {
        console.error("Error fetching room data:", error);
        alert("Error fetching room data for " + roomName);
      });
    }
    function openRoomChat(roomName) {
      doorChatMode = false;
      document.getElementById('chatRoomTitle').textContent = roomName + " Chat (Inside)";
      document.getElementById('chatLog').innerHTML = "";
      document.getElementById('chatPanel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      listenForMessages(roomName);
    }
    function openDoorChat(roomName) {
      doorChatMode = true;
      document.getElementById('chatRoomTitle').textContent = roomName + " Door Chat (Visitor)";
      document.getElementById('chatLog').innerHTML = "";
      document.getElementById('chatPanel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      listenForMessages(roomName);
    }
    function listenForMessages(roomName) {
      const chatLog = document.getElementById('chatLog');
      const messagesRef = db.collection("messages");
      messagesRef
        .where("room", "==", roomName)
        .where("chatType", "==", doorChatMode ? "door" : "room")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    function closeChat() {
      document.getElementById('chatPanel').style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';
      currentRoom = "";
    }
    async function sendChatMessage() {
      const msg = document.getElementById('chatInput').value;
      if (msg.trim() !== "") {
        const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
        try {
          await db.collection("messages").add({
            room: currentRoom,
            sender: characterName,
            content: msg,
            chatType: doorChatMode ? "door" : "room",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById('chatInput').value = "";
        } catch (error) {
          console.error("Error sending message:", error);
        }
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendChatMessage();
          }
        });
      }
    });
  
    // ----------------------------
    // Door Modal Functions
    // ----------------------------
    function showDoorModal(roomName) {
      currentRoom = roomName;
      document.getElementById('doorTitle').textContent = "You are at the door of " + roomName;
      document.getElementById('doorModal').style.display = 'block';
      document.getElementById('passwordDiv').style.display = 'none';
      document.getElementById('doorPassword').value = "";
    }
    function closeDoorModal() {
      document.getElementById('doorModal').style.display = 'none';
    }
    function showPasswordInput() {
      document.getElementById('passwordDiv').style.display = 'block';
    }
    function verifyPassword() {
      const enteredPassword = document.getElementById('doorPassword').value;
      const correctPassword = roomPasswords[currentRoom];
      if (enteredPassword === correctPassword) {
        alert("Password correct. You now enter the room.");
        closeDoorModal();
        openRoomChat(currentRoom);
      } else {
        alert("Incorrect password. Please try again or choose to knock.");
      }
    }
    function handleKnock() {
      alert("You knocked on the door. Please wait for the owner’s response.");
      db.collection("rooms").doc(currentRoom).get().then(doc => {
        if (doc.exists) {
          const owner = doc.data().owner;
          const visitor = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "A visitor";
          db.collection("notifications").add({
            owner: owner,
            room: currentRoom,
            message: `${visitor} knocked on your door of ${currentRoom}.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }).catch(error => {
        console.error("Error sending knock notification:", error);
      });
      closeDoorModal();
      openDoorChat(currentRoom);
    }
  
    // ----------------------------
    // New Power Panel Simulation Functions & Controls
    // ----------------------------
    let windSpeed = localStorage.getItem('windSpeed') || 50;
    let electricalOutput = false;
    let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
    let garbageLevel = localStorage.getItem('garbageLevel') || 0;
    let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
    let powerStatus = "Unknown";
  
    function updateWindSpeed() {
      windSpeed = document.getElementById('windSpeedSlider').value;
      document.getElementById('windSpeedValue').textContent = windSpeed;
      localStorage.setItem('windSpeed', windSpeed);
      updateVoltage();
      updateLastInteraction();
      updateElectricalStatus();
    }
  
    function toggleElectricalOutput() {
      electricalOutput = !electricalOutput;
      document.getElementById('outputLeverButton').textContent = electricalOutput ? "Output On" : "Output Off";
      updateLastInteraction();
      updateElectricalStatus();
    }
  
    function checkWaterPressure() {
      const pressure = Math.floor(Math.random() * 41) + 80;
      alert("Current Water Pressure: " + pressure + " PSI.\nOptimal is above 90 PSI.");
      updateLastInteraction();
      updateElectricalStatus();
    }
  
    function checkHeaterLevel() {
      const heater = Math.floor(Math.random() * 41) + 80;
      alert("Current Heater Level: " + heater + ".\nOptimal is above 90.");
      updateLastInteraction();
      updateElectricalStatus();
    }
  
    function updateElectricalStatus() {
      if (windSpeed >= 40 && windSpeed <= 70 && electricalOutput) {
        powerStatus = "On";
        document.getElementById('lightStatusDisplay').textContent = "Lights On";
      } else {
        powerStatus = "Off";
        document.getElementById('lightStatusDisplay').textContent = "Lights Off";
      }
      document.getElementById('powerStatusDisplay').textContent = powerStatus;
    }
  
    function updateVoltage() {
      let factor = electricalOutput ? 1.0 : 0.5;
      let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
      voltage = Math.max(0, voltage);
      const voltageDisplayElement = document.getElementById('voltageDisplay');
      if (voltageDisplayElement) {
        voltageDisplayElement.textContent = voltage.toFixed(1);
      }
      localStorage.setItem('voltage', voltage);
    }
  
    function simulatePowerEvent() {
      if (Date.now() - lastInteractionTime > 60000) {
        const malfunctionType = Math.floor(Math.random() * 5);
        let malfunctionMessage = "";
        switch(malfunctionType) {
          case 0:
            malfunctionMessage = "Wind calibration error: Re-adjust the wind speed slider to bring it into the optimal range (40–70).";
            break;
          case 1:
            malfunctionMessage = "Electrical output fluctuation: Toggle the electrical output lever to stabilize the system.";
            break;
          case 2:
            malfunctionMessage = "Water pressure drop: Press 'Check Water' to review and fix water pressure issues.";
            break;
          case 3:
            malfunctionMessage = "Heater level fluctuation: Press 'Check Heater' to ensure heater levels are optimal.";
            break;
          case 4:
            malfunctionMessage = "Sensor error: Re-check all controls (wind speed, output lever, water, heater) to recalibrate the system.";
            break;
        }
        alert("Malfunction Detected!\n" + malfunctionMessage);
        const playerEmail = localStorage.getItem('playerName');
        if (playerEmail) {
          const safePlayerName = sanitizePlayerName(playerEmail);
          db.collection('players').doc(safePlayerName).get().then(doc => {
            if (doc.exists) {
              let currentHealth = doc.data().health || 100;
              let newHealth = Math.max(0, currentHealth - 5);
              db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
              if (newHealth === 0) {
                playerDied();
              }
            }
          });
        }
        updateLastInteraction();
      }
    }
  
    function updateGarbageDisplay() {
      document.getElementById('garbageDisplay').textContent = garbageLevel;
      const now = Date.now();
      const elapsedMinutes = Math.floor((now - lastGarbageUpdate) / 60000);
      if (elapsedMinutes > 0) {
        garbageLevel = Math.min(100, Number(garbageLevel) + elapsedMinutes);
        lastGarbageUpdate = now;
        localStorage.setItem('garbageLevel', garbageLevel);
        localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
        document.getElementById('garbageDisplay').textContent = garbageLevel;
        if (garbageLevel > 80) {
          alert("High garbage levels detected! The community is getting sick.");
        }
      }
    }
  
    function logPowerMessage(message) {
      const logDiv = document.getElementById('minigameLog');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  
    function toggleInstructions() {
      const instrDiv = document.getElementById("instructions");
      instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
    }
  
    function updateLastInteraction() {
      lastInteractionTime = Date.now();
      localStorage.setItem('lastInteractionTime', lastInteractionTime);
    }
  
    function simulateHealthDecline() {
      if (garbageLevel > 80) {
        const playerEmail = localStorage.getItem('playerName');
        if (!playerEmail) return;
        const safePlayerName = sanitizePlayerName(playerEmail);
        db.collection('players').doc(safePlayerName).get().then((doc) => {
          if (doc.exists) {
            let data = doc.data();
            let currentHealth = data.health || 100;
            let extraDecline = 0;
            if (data.hunger > 70) extraDecline += 1;
            if (data.mood < 30) extraDecline += 1;
            let newHealth = Math.max(0, currentHealth - 1 - extraDecline);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
            if (newHealth === 0) {
              playerDied();
            }
          }
        }).catch((error) => {
          console.error("Error decreasing health: ", error);
        });
      }
    }
  
    function playerDied() {
      alert("Your health has reached zero. You have died.");
      clearGameState();
      window.location.href = "index.html";
    }
  
    function toggleMusicPlayer() {
      var player = document.getElementById("bgMusic");
      if (player.style.display === "none" || player.style.display === "" || player.style.width === "0px") {
        player.style.display = "block";
        player.style.width = "300px";
        player.style.height = "200px";
        player.style.position = "relative";
        player.style.left = "0";
      } else {
        player.style.display = "none";
        player.style.width = "0";
        player.style.height = "0";
        player.style.position = "absolute";
        player.style.left = "-9999px";
      }
    }
  
    function collectWater() {
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const pressure = Math.round(voltage * 0.8);
      if (pressure >= 90) {
        waterInventory += 5;
        localStorage.setItem('water', waterInventory);
        alert("Collected 5 water units! Your water inventory is now " + waterInventory + ".");
      } else {
        alert("Water pressure too low to collect water. Ensure the power panel is operating properly.");
      }
      document.getElementById('waterInventoryDisplay').textContent = waterInventory;
    }
  
    function renderGardenSlots() {
      const container = document.getElementById('plantSlots');
      container.innerHTML = "";
      gardenSlots.forEach(slot => {
        let slotDiv = document.createElement("div");
        slotDiv.className = "slot";
        slotDiv.id = "slot" + slot.slot;
        if (!slot.type) {
          slotDiv.innerHTML = 'Slot ' + slot.slot + ': <span class="status">Empty</span> <button onclick="openPlantSelectionModal(' + slot.slot + ')">Plant Seed</button>';
        } else {
          let statusText = slot.watered ? "Watered, growing..." : "Planted: " + slot.type + " (needs water)";
          slotDiv.innerHTML = 'Slot ' + slot.slot + ': <span class="status">' + statusText + '</span>';
          if (!slot.watered) {
            slotDiv.innerHTML += ' <button onclick="waterPlant(' + slot.slot + ')">Water Plant</button>';
          }
        }
        container.appendChild(slotDiv);
      });
    }
  
    function openPlantSelectionModal(slotNumber) {
      const seedType = prompt("Enter the seed type to plant (choose one of the following seeds:\n" +
        seedTypes.join(", ") +
        "\nOR one of the mushroom types:\n" +
        mushroomTypes.join(", ") +
        ")");
      if (!seedType) return;
      if (!harvestInventory[seedType] || harvestInventory[seedType] < 1) {
        alert("You do not have any " + seedType + " in your inventory.");
        return;
      }
      removeItem(seedType, 1);
      gardenSlots[slotNumber - 1] = {
        slot: slotNumber,
        type: seedType,
        watered: false,
        timer: null
      };
      renderGardenSlots();
    }
  
    function waterPlant(slotNumber) {
      if (waterInventory < 1) {
        alert("No water available. Please collect water from the Water Supplies panel.");
        return;
      }
      waterInventory -= 1;
      localStorage.setItem('water', waterInventory);
      document.getElementById('waterInventoryDisplay').textContent = waterInventory;
      gardenSlots[slotNumber - 1].watered = true;
      renderGardenSlots();
      gardenSlots[slotNumber - 1].timer = setTimeout(() => {
        const matureType = gardenSlots[slotNumber - 1].type;
        alert("Your " + matureType + " has matured!");
        addItem(matureType, 1);
        gardenSlots[slotNumber - 1] = { slot: slotNumber, type: null, watered: false, timer: null };
        renderGardenSlots();
      }, 300000);
    }
  
    function generateGroceryItems() {
      let seedContainer = document.getElementById("seedList");
      seedContainer.innerHTML = "";
      seedTypes.forEach(seed => {
        let div = document.createElement("div");
        div.className = "grocery-item";
        div.innerHTML = `<p><strong>${seed}</strong> - $2<br><em>${seed} is ideal for growing nutrient-rich produce.</em></p>
                         <button onclick="buyItem('${seed}')">Buy ${seed}</button>`;
        seedContainer.appendChild(div);
      });
      let mushroomContainer = document.getElementById("mushroomList");
      mushroomContainer.innerHTML = "";
      mushroomTypes.forEach(mushroom => {
        let div = document.createElement("div");
        div.className = "grocery-item";
        div.innerHTML = `<p><strong>${mushroom}</strong> - $2<br><em>${mushroom} adds unique flavor and nutrients.</em></p>
                         <button onclick="buyItem('${mushroom}')">Buy ${mushroom}</button>`;
        mushroomContainer.appendChild(div);
      });
      // NEW: Add Health Items (First Aid Kit) – Only one instance now
      let healthContainer = document.getElementById("healthItemList");
      if (!healthContainer) {
        healthContainer = document.createElement("div");
        healthContainer.id = "healthItemList";
        healthContainer.innerHTML = `<h4>Health Items</h4>`;
        document.getElementById("grocery-panel").appendChild(healthContainer);
      } else {
        healthContainer.innerHTML = `<h4>Health Items</h4>`; // Clear duplicates
      }
      let div = document.createElement("div");
      div.className = "grocery-item";
      div.innerHTML = `<p><strong>First Aid Kit</strong> - $8<br><em>Restores 20 health.</em></p>
                       <button onclick="buyItem('First Aid Kit')">Buy First Aid Kit</button>`;
      healthContainer.appendChild(div);
    }
  
    function clearGarbage() {
      garbageLevel = 0;
      localStorage.setItem('garbageLevel', garbageLevel);
      document.getElementById('garbageDisplay').textContent = garbageLevel;
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      const logDiv = document.getElementById('garbageLog');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<p>[${timestamp}] ${characterName} cleared the garbage.</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  
    window.onload = function() {
      var roomSelect = document.getElementById('roomNumber');
      if (roomSelect) {
        for (let i = 1; i <= 25; i++) {
          let option = document.createElement('option');
          option.value = i;
          option.textContent = "Room " + i;
          roomSelect.appendChild(option);
        }
      }
      var gridContainer = document.querySelector(".grid");
      if (gridContainer) {
        const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
        rooms.forEach(function(room) {
          let btn = document.createElement("button");
          btn.textContent = "Room " + room;
          btn.onclick = function() { openRoomInteraction("Room " + room); };
          gridContainer.appendChild(btn);
        });
      }
      var plantSlotsDiv = document.getElementById("plantSlots");
      if (plantSlotsDiv) {
        renderGardenSlots();
      }
      document.getElementById('windSpeedSlider').value = windSpeed;
      document.getElementById('windSpeedValue').textContent = windSpeed;
      updateVoltage();
      updateGarbageDisplay();
      if (localStorage.getItem('playerName')) {
        checkCharacterExistence();
      }
      harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
      waterInventory = parseInt(localStorage.getItem('water')) || 0;
      generateGroceryItems();
      setInterval(simulatePowerEvent, 60000);
      setInterval(updateGarbageDisplay, 60000);
      setInterval(updateVoltage, 5000);
      setInterval(simulateHealthDecline, 60000);
      listenForKitchenChat();
      listenForLaundryChat();
    };
  
    function plantMushroomTree() {
      alert("Planting a mushroom tree. (Functionality to be implemented similarly to seeds.)");
    }
    function harvestProduce() {
      alert("Harvesting produce from the Community Garden. Mature produce will be harvested automatically once grown.");
    }
    function sellHarvest() {
      // This function sells selected items from the sell section.
      const checkboxes = document.querySelectorAll('.sell-checkbox:checked');
      if (checkboxes.length === 0) {
        alert("Please select at least one item to sell.");
        return;
      }
      // Define sell prices (example: half the buy price)
      const sellPrices = {
        'Food Staples': 5,
        'Lubricant Oil': 2.5,
        'Alcohol': 1.5,
        'Cigarettes': 2
        // For seeds and mushrooms, default sell price is $1 each
      };
      checkboxes.forEach(checkbox => {
        const item = checkbox.getAttribute('data-item');
        const qty = harvestInventory[item];
        const price = sellPrices[item] || 1;
        let money = parseInt(localStorage.getItem('money')) || 50;
        money += price * qty;
        localStorage.setItem('money', money);
        removeItem(item, qty);
        alert(`Sold ${qty} ${item}(s) for $${price * qty}.`);
      });
      updateSellInventory();
      updatePlayerStatus();
    }
  
    // Toggle between Buy and Sell sections in Grocery Stand
    function toggleBuySell(mode) {
      if (mode === 'buy') {
        document.getElementById('buySection').style.display = 'grid';
        document.getElementById('sellSection').style.display = 'none';
      } else if (mode === 'sell') {
        document.getElementById('buySection').style.display = 'none';
        document.getElementById('sellSection').style.display = 'block';
        updateSellInventory();
      }
    }
  
    // Populate the sell inventory based on the player's inventory
    function updateSellInventory() {
      const sellDiv = document.getElementById('sellInventory');
      sellDiv.innerHTML = "";
      for (const item in harvestInventory) {
        const qty = harvestInventory[item];
        if (qty > 0) {
          const div = document.createElement('div');
          div.className = "sell-item";
          div.innerHTML = `
            <label>
              <input type="checkbox" class="sell-checkbox" data-item="${item}" data-qty="${qty}">
              ${item} - Quantity: ${qty}
            </label>
          `;
          sellDiv.appendChild(div);
        }
      }
      if (sellDiv.innerHTML === "") {
        sellDiv.innerHTML = "<p>You have no items to sell.</p>";
      }
    }
  
    // Tab functionality for Grocery Stand
    function openTab(evt, tabName) {
      var i, tabcontent, tabbuttons;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }
  </script>
</body>
</html>
