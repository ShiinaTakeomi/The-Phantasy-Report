<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <!-- Google Font for Soviet-style signage -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    /* Global Styles & Eastern European Snowy Theme */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Russo One', Arial, sans-serif;
      /* Background image evokes a snowy urban block flat house with a concrete/frost overlay */
      background: 
        linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)),
        url('https://images.unsplash.com/photo-1601758123927-8b973eb4c74f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1500&q=80') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      background: rgba(20, 20, 20, 0.7);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(180, 180, 180, 0.2);
      border: 1px solid #555;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(180, 180, 180, 0.4);
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211, 211, 211, 0.3);
      border: 2px solid #888;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(150, 150, 200, 0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(178, 34, 34, 0.7); /* rusty red tone */
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
      transition: background-color 0.3s;
    }
    .facilities button:hover {
      background-color: rgba(178, 34, 34, 0.9);
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
    }
    .panel h2 {
      text-align: center;
      color: #fff;
    }
    .control {
      margin-bottom: 15px;
    }
    .control label {
      display: inline-block;
      width: 200px;
      color: #fff;
    }
    .control input[type="range"] {
      width: 200px;
    }
    #minigameLog, #garbageLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-radius: 4px;
    }
    /* Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 400px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Character Status Box */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
    }
    #characterCreation input, 
    #characterCreation select, 
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<!-- Character Creation Section (shown if no character exists) -->
<div id="characterCreation">
  <h3>Create Your Character</h3>
  <p>Welcome, <span id="displayName"></span>!</p>
  <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
    <input type="text" id="charName" placeholder="Name" required>
    <input type="number" id="charAge" placeholder="Age" required>
    <select id="charGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
    <button type="submit">Create Character</button>
  </form>
</div>

<!-- Main Game Section -->
<div id="mainGame" style="display: none;">
  <!-- Main Screen -->
  <div id="main-screen">
    <div class="container">
      <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
      <div class="grid">
        <!-- 25 Room Buttons -->
        <button onclick="openRoomChat('Room 21')">Room 21</button>
        <button onclick="openRoomChat('Room 22')">Room 22</button>
        <button onclick="openRoomChat('Room 23')">Room 23</button>
        <button onclick="openRoomChat('Room 24')">Room 24</button>
        <button onclick="openRoomChat('Room 25')">Room 25</button>
        <button onclick="openRoomChat('Room 16')">Room 16</button>
        <button onclick="openRoomChat('Room 17')">Room 17</button>
        <button onclick="openRoomChat('Room 18')">Room 18</button>
        <button onclick="openRoomChat('Room 19')">Room 19</button>
        <button onclick="openRoomChat('Room 20')">Room 20</button>
        <button onclick="openRoomChat('Room 11')">Room 11</button>
        <button onclick="openRoomChat('Room 12')">Room 12</button>
        <button onclick="openRoomChat('Room 13')">Room 13</button>
        <button onclick="openRoomChat('Room 14')">Room 14</button>
        <button onclick="openRoomChat('Room 15')">Room 15</button>
        <button onclick="openRoomChat('Room 6')">Room 6</button>
        <button onclick="openRoomChat('Room 7')">Room 7</button>
        <button onclick="openRoomChat('Room 8')">Room 8</button>
        <button onclick="openRoomChat('Room 9')">Room 9</button>
        <button onclick="openRoomChat('Room 10')">Room 10</button>
        <button onclick="openRoomChat('Room 1')">Room 1</button>
        <button onclick="openRoomChat('Room 2')">Room 2</button>
        <button onclick="openRoomChat('Room 3')">Room 3</button>
        <button onclick="openRoomChat('Room 4')">Room 4</button>
        <button onclick="openRoomChat('Room 5')">Room 5</button>
      </div>
      <button class="power-room" onclick="showPowerPanel()">Power Room</button>
    </div>
    <div class="facilities">
      <button onclick="handleClick('Community Kitchen')">Community Kitchen</button>
      <button onclick="handleClick('Groceries Stand')">Groceries Stand</button>
      <button onclick="handleClick('Water Supplies (Laundry)')">Water Supplies (Laundry)</button>
      <!-- Toggle Status Button -->
      <button onclick="togglePlayerStatus()">Toggle Status</button>
    </div>
    <!-- Character Status Box -->
    <div id="playerStatus">
      <h3>Character Status</h3>
      <p>Your character data will appear here.</p>
    </div>
  </div>

  <!-- Power Source Panel -->
  <div id="minigame-panel" class="panel">
    <h2>Wind Turbine Control Panel</h2>
    <p><strong>Objective:</strong> Ensure the turbine remains stable and provides electricity (affecting water and heating) to the flats.</p>
    <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    <div id="instructions" style="display: none;">
      <p>Adjust the wind speed, engage brakes when needed, lubricate the turbine, and confirm power output.</p>
    </div>
    <div class="control">
      <label for="windSpeedSlider">Wind Speed Regulator:</label>
      <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
      <span id="windSpeedValue"></span>
    </div>
    <div class="control">
      <label for="brakeButton">Brake System:</label>
      <button id="brakeButton" onclick="toggleBrake()">Engage Brake</button>
    </div>
    <div class="control">
      <label>Voltage Monitor:</label>
      <span id="voltageDisplay"></span> V
    </div>
    <div class="control">
      <label for="lubricateButton">Lubrication Check:</label>
      <button id="lubricateButton" onclick="lubricate()">Lubricate</button>
    </div>
    <div class="control">
      <label for="powerOutputConfirm">Power Output Confirm:</label>
      <button id="powerOutputConfirm" onclick="togglePowerOutput()">Confirm Output</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('minigame-panel')">Return to Main Screen</button>
    </div>
    <h3>System Log:</h3>
    <div id="minigameLog"></div>
  </div>

  <!-- Garbage Chute Panel -->
  <div id="garbage-panel" class="panel">
    <h2>Garbage Chute Control</h2>
    <p><strong>Objective:</strong> Clear the accumulated garbage before it piles up too high.</p>
    <div class="control">
      <label>Garbage Level:</label>
      <span id="garbageDisplay"></span> / 100
    </div>
    <div class="control">
      <button onclick="clearGarbage()">Clear Garbage</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('garbage-panel')">Return to Main Screen</button>
    </div>
    <h3>Garbage Log:</h3>
    <div id="garbageLog"></div>
  </div>

  <!-- Chat Panel -->
  <div id="chatPanel" class="panel">
    <h2 id="chatRoomTitle"></h2>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="closeChat()">Close Chat</button>
  </div>
</div>

<script>
  // ----------------------------
  // Firebase Initialization
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
    authDomain: "thephantasyreport.firebaseapp.com",
    projectId: "thephantasyreport",
    storageBucket: "thephantasyreport.firebasestorage.app",
    messagingSenderId: "887983841070",
    appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
    measurementId: "G-9MS36H0YV4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ----------------------------
  // Navigation Functions
  // ----------------------------
  function showPowerPanel() {
    document.getElementById('minigame-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function showGarbagePanel() {
    updateGarbageDisplay();
    document.getElementById('garbage-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function hidePanel(panelId) {
    document.getElementById(panelId).style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }
  function handleClick(label) {
    alert("Facility: " + label);
  }
  function togglePlayerStatus() {
    const statusBox = document.getElementById('playerStatus');
    statusBox.style.display = (statusBox.style.display === "none" || statusBox.style.display === "") ? "block" : "none";
  }

  // ----------------------------
  // Chat Functions using Firestore
  // ----------------------------
  let currentRoom = "";
  function openRoomChat(roomName) {
    currentRoom = roomName;
    document.getElementById('chatRoomTitle').textContent = roomName + " Chat";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function listenForMessages(roomName) {
    const chatLog = document.getElementById('chatLog');
    const messagesRef = db.collection("messages");
    messagesRef
      .where("room", "==", roomName)
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  function closeChat() {
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    currentRoom = "";
  }
  async function sendChatMessage() {
    const msg = document.getElementById('chatInput').value;
    if (msg.trim() !== "") {
      // Use the stored characterName if set; otherwise fallback to playerName
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      try {
        await db.collection("messages").add({
          room: currentRoom,
          sender: characterName,
          content: msg,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('chatInput').value = "";
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ----------------------------
  // Power Source Simulation Functions
  // ----------------------------
  let windSpeed = localStorage.getItem('windSpeed') || 50;
  let brakeEngaged = JSON.parse(localStorage.getItem('brakeEngaged')) || false;
  let powerOutputConfirmed = JSON.parse(localStorage.getItem('powerOutputConfirmed')) || false;
  let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
  let garbageLevel = localStorage.getItem('garbageLevel') || 0;
  let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();

  function updateWindSpeed() {
    windSpeed = document.getElementById('windSpeedSlider').value;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    localStorage.setItem('windSpeed', windSpeed);
    updateVoltage();
    updateLastInteraction();
  }
  function toggleBrake() {
    brakeEngaged = !brakeEngaged;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    localStorage.setItem('brakeEngaged', brakeEngaged);
    updateVoltage();
    updateLastInteraction();
  }
  function togglePowerOutput() {
    powerOutputConfirmed = !powerOutputConfirmed;
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    localStorage.setItem('powerOutputConfirmed', powerOutputConfirmed);
    updateLastInteraction();
  }
  function lubricate() {
    logPowerMessage("Lubrication complete. Moving parts are now well-oiled.");
    updateLastInteraction();
  }
  function updateVoltage() {
    let factor = brakeEngaged ? 0.5 : 1.0;
    let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
    voltage = Math.max(0, voltage);
    document.getElementById('voltageDisplay').textContent = voltage.toFixed(1);
    localStorage.setItem('voltage', voltage);
  }
  function simulateRandomEvent() {
    if (Date.now() - lastInteractionTime > 30000) {
      logPowerMessage("System overload due to inactivity! Flats experience a blackout for 1-2 days.");
    }
    const events = [
      "Sudden strong winds detected! Adjust wind speed or engage brakes.",
      "Low energy output observed! Check lubrication or adjust controls.",
      "Minor electrical fault occurred! Reset the circuit breaker.",
      "Dust accumulation detected! Perform a quick maintenance check."
    ];
    logPowerMessage(events[Math.floor(Math.random() * events.length)]);
  }
  function logPowerMessage(message) {
    const logDiv = document.getElementById('minigameLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  function toggleInstructions() {
    const instrDiv = document.getElementById("instructions");
    instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
  }
  function updateLastInteraction() {
    lastInteractionTime = Date.now();
    localStorage.setItem('lastInteractionTime', lastInteractionTime);
  }

  // ----------------------------
  // Garbage Chute Simulation Functions
  // ----------------------------
  function updateGarbageDisplay() {
    const now = Date.now();
    const elapsedHours = Math.floor((now - lastGarbageUpdate) / 3600000);
    garbageLevel = Math.min(100, Number(garbageLevel) + elapsedHours * 10);
    lastGarbageUpdate = now;
    localStorage.setItem('garbageLevel', garbageLevel);
    localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
  }
  function clearGarbage() {
    garbageLevel = 0;
    localStorage.setItem('garbageLevel', garbageLevel);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    logGarbageMessage("Garbage cleared by player.");
  }
  function logGarbageMessage(message) {
    const logDiv = document.getElementById('garbageLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // ----------------------------
  // Firebase: Player Status & Character Management
  // ----------------------------
  function updatePlayerStatus() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    db.collection('players').doc(playerName)
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          localStorage.setItem('characterName', data.name);
          let statusHTML = `<h3>Character Status</h3>`;
          statusHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
          statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
          statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
          statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
          statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
          statusHTML += `<p><strong>Gender:</strong> ${data.gender || "N/A"}</p>`;
          statusHTML += `<p><strong>Age:</strong> ${data.age || "N/A"}</p>`;
          statusHTML += `<p><strong>Reason:</strong> ${data.reason || "N/A"}</p>`;
          statusHTML += `<p><strong>Physical:</strong> ${data.conditions.physical}</p>`;
          statusHTML += `<p><strong>Mental:</strong> ${data.conditions.mental}</p>`;
          statusHTML += `<p><strong>Activity:</strong> ${data.conditions.activity}</p>`;
          statusHTML += `<p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString()}</p>`;
          document.getElementById('playerStatus').innerHTML = statusHTML;
        }
      }, (error) => {
        console.error("Error getting player status:", error);
      });
  }

  function checkCharacterExistence() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    db.collection('players').doc(playerName).get().then((doc) => {
      if (doc.exists) {
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      } else {
        document.getElementById('characterCreation').style.display = 'block';
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('displayName').innerText = playerName;
        document.getElementById('charName').value = playerName;
      }
    }).catch((error) => {
      console.error("Error checking character existence:", error);
    });
  }

  function createCharacter() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const charName = document.getElementById('charName').value;
    const charAge = document.getElementById('charAge').value;
    const charGender = document.getElementById('charGender').value;
    const charReason = document.getElementById('charReason').value;
    const playerData = {
      name: charName,
      age: charAge,
      gender: charGender,
      reason: charReason,
      health: 100,
      hunger: 0,
      injury: 0,
      mood: 100,
      conditions: {
        physical: "Healthy",
        mental: "Content",
        activity: "Idle"
      },
      lastUpdated: Date.now()
    };
    db.collection('players').doc(playerName).set(playerData, { merge: true })
      .then(() => {
        localStorage.setItem('characterName', charName);
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      })
      .catch((error) => {
        console.error("Error creating character:", error);
      });
  }

  // ----------------------------
  // Initialization
  // ----------------------------
  window.onload = function() {
    // Set initial values for power simulation
    document.getElementById('windSpeedSlider').value = windSpeed;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    updateVoltage();
    updateGarbageDisplay();
    // Check if a player is signed in and then check for their character document
    if (localStorage.getItem('playerName')) {
      checkCharacterExistence();
    }
    setInterval(updateVoltage, 5000);
    setInterval(simulateRandomEvent, 3600000);
    setInterval(updateGarbageDisplay, 3600000);
  };
</script>
</body>
</html>
