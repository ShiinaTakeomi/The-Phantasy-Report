<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    /* Global Styles & Eastern European Snowy Minimal Theme */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      /* Background with dark overlay for a gloomy, wintery feel, plus a concrete texture overlay */
      background: 
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
        url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
    }
    /* Use Russo One for headings to evoke Soviet-era signage */
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    /* A subtle concrete texture overlay for containers and panels */
    .container, .panel, #characterCreation {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    /* The grid container for room buttons */
    .grid {
      position: relative; /* So that absolute children are relative to this container */
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211, 211, 211, 0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    /* Updated Exit Button Style */
    .exit-button {
      position: absolute;
      left: 0;
      top: 530px; /* Positioned just below the garbage chute */
      width: 70px;
      height: 40px;
      background-color: #FF4136; /* Bright red background */
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192, 192, 255, 0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(200, 150, 130, 0.7); /* muted, aged color hint */
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      /* Background image inherited from container style */
    }
    .panel h2 {
      text-align: center;
      color: #fff;
    }
    .control {
      margin-bottom: 15px;
    }
    .control label {
      display: inline-block;
      width: 200px;
      color: #fff;
    }
    .control input[type="range"] {
      width: 200px;
    }
    /* Grocery Store Panel */
    #grocery-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.7);
      color: #eee;
    }
    #grocery-panel h2 {
      margin-bottom: 20px;
    }
    #grocery-panel .grocery-item {
      margin: 10px 0;
    }
    #grocery-panel .grocery-item p {
      font-size: 16px;
      margin-bottom: 5px;
    }
    /* Community Garden Panel */
    #garden-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.7);
      color: #eee;
    }
    #garden-panel h2 {
      margin-bottom: 20px;
    }
    #garden-panel .slot {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #777;
      border-radius: 4px;
    }
    #garden-panel .slot button {
      margin-left: 10px;
      padding: 3px 6px;
      font-size: 14px;
    }
    /* Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 400px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Biodata Panel (formerly Character Status) */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
    }
    #characterCreation input, 
    #characterCreation select, 
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
  <!-- Firebase SDKs: Auth and Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- Character Creation Section -->
<div id="characterCreation">
  <h3>Create Your Character</h3>
  <p>Welcome, <span id="displayName"></span>!</p>
  <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
    <input type="text" id="charName" placeholder="Name" required>
    <input type="number" id="charAge" placeholder="Age" required>
    <select id="charGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
    <button type="submit">Create Character</button>
  </form>
</div>

<!-- Main Game Section -->
<div id="mainGame" style="display: none;">
  <!-- Main Screen -->
  <div id="main-screen">
    <div class="container">
      <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
      <!-- Exit Button -->
      <button class="exit-button" onclick="signOutUser()">Exit</button>
      <!-- The grid container now holds the room buttons -->
      <div class="grid">
        <!-- 25 Room Buttons -->
        <button onclick="openRoomChat('Room 21')">Room 21</button>
        <button onclick="openRoomChat('Room 22')">Room 22</button>
        <button onclick="openRoomChat('Room 23')">Room 23</button>
        <button onclick="openRoomChat('Room 24')">Room 24</button>
        <button onclick="openRoomChat('Room 25')">Room 25</button>
        <button onclick="openRoomChat('Room 16')">Room 16</button>
        <button onclick="openRoomChat('Room 17')">Room 17</button>
        <button onclick="openRoomChat('Room 18')">Room 18</button>
        <button onclick="openRoomChat('Room 19')">Room 19</button>
        <button onclick="openRoomChat('Room 20')">Room 20</button>
        <button onclick="openRoomChat('Room 11')">Room 11</button>
        <button onclick="openRoomChat('Room 12')">Room 12</button>
        <button onclick="openRoomChat('Room 13')">Room 13</button>
        <button onclick="openRoomChat('Room 14')">Room 14</button>
        <button onclick="openRoomChat('Room 15')">Room 15</button>
        <button onclick="openRoomChat('Room 6')">Room 6</button>
        <button onclick="openRoomChat('Room 7')">Room 7</button>
        <button onclick="openRoomChat('Room 8')">Room 8</button>
        <button onclick="openRoomChat('Room 9')">Room 9</button>
        <button onclick="openRoomChat('Room 10')">Room 10</button>
        <button onclick="openRoomChat('Room 1')">Room 1</button>
        <button onclick="openRoomChat('Room 2')">Room 2</button>
        <button onclick="openRoomChat('Room 3')">Room 3</button>
        <button onclick="openRoomChat('Room 4')">Room 4</button>
        <button onclick="openRoomChat('Room 5')">Room 5</button>
        <!-- The Community Garden button is not part of the normal flow;
             it is absolutely positioned within the grid container so that it appears above Room 23 -->
        <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
      </div>
      <button class="power-room" onclick="showPowerPanel()">Power Room</button>
    </div>
    <div class="facilities">
      <button onclick="handleClick('Community Kitchen')">Community Kitchen</button>
      <button onclick="openGroceryPanel()">Groceries Stand</button>
      <button onclick="handleClick('Water Supplies (Laundry)')">Water Supplies (Laundry)</button>
      <button onclick="togglePlayerStatus()">Biodata</button>
    </div>
    <!-- Biodata Panel -->
    <div id="playerStatus">
      <!-- Populated by updatePlayerStatus() -->
    </div>
  </div>

  <!-- Power Source Panel -->
  <div id="minigame-panel" class="panel">
    <h2>Wind Turbine Control Panel</h2>
    <p><strong>Objective:</strong> Ensure the turbine remains stable and provides electricity (affecting water and heating) to the flats.</p>
    <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    <div id="instructions" style="display: none;">
      <p>Adjust the wind speed, engage brakes when needed, lubricate the turbine, and confirm power output.</p>
    </div>
    <div class="control">
      <label for="windSpeedSlider">Wind Speed Regulator:</label>
      <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
      <span id="windSpeedValue"></span>
    </div>
    <div class="control">
      <label for="brakeButton">Brake System:</label>
      <button id="brakeButton" onclick="toggleBrake()">Engage Brake</button>
    </div>
    <div class="control">
      <label>Voltage Monitor:</label>
      <span id="voltageDisplay"></span> V
    </div>
    <div class="control">
      <label for="lubricateButton">Lubrication Check:</label>
      <button id="lubricateButton" onclick="lubricate()">Lubricate</button>
    </div>
    <div class="control">
      <label for="powerOutputConfirm">Power Output Confirm:</label>
      <button id="powerOutputConfirm" onclick="togglePowerOutput()">Confirm Output</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('minigame-panel')">Return to Main Screen</button>
    </div>
    <h3>System Log:</h3>
    <div id="minigameLog"></div>
  </div>

  <!-- Garbage Chute Panel -->
  <div id="garbage-panel" class="panel">
    <h2>Garbage Chute Control</h2>
    <p><strong>Objective:</strong> Clear the accumulated garbage before it piles up too high.</p>
    <div class="control">
      <label>Garbage Level:</label>
      <span id="garbageDisplay"></span> / 100
    </div>
    <div class="control">
      <button onclick="clearGarbage()">Clear Garbage</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('garbage-panel')">Return to Main Screen</button>
    </div>
    <h3>Garbage Log:</h3>
    <div id="garbageLog"></div>
  </div>

  <!-- Grocery Store Panel -->
  <div id="grocery-panel" class="panel">
    <h2>Grocery Store</h2>
    <p>Purchase essential items to ensure survival. Note: Without proper electricity, prices may increase.</p>
    <div class="grocery-item">
      <p><strong>Food Staples</strong> (Bread, Meat, Vegetables, etc.)</p>
      <button onclick="buyItem('Food Staples')">Buy Food</button>
    </div>
    <div class="grocery-item">
      <p><strong>Seeds</strong> (For your community garden)</p>
      <button onclick="buyItem('Seeds')">Buy Seeds</button>
    </div>
    <div class="grocery-item">
      <p><strong>Maintenance Essentials</strong> (For wind turbine repairs)</p>
      <button onclick="buyItem('Maintenance Essentials')">Buy Maintenance</button>
    </div>
    <div class="grocery-item">
      <p><strong>Room Decorations</strong> (10 types available to boost mood)</p>
      <button onclick="buyItem('Room Decoration')">Buy Decoration</button>
    </div>
    <div class="grocery-item">
      <p><strong>Alcohol</strong> (Boosts mood temporarily but slows work)</p>
      <button onclick="buyItem('Alcohol')">Buy Alcohol</button>
    </div>
    <div class="grocery-item">
      <p><strong>Cigarettes</strong> (50/50 chance to boost mood but harm health over time)</p>
      <button onclick="buyItem('Cigarettes')">Buy Cigarettes</button>
    </div>
    <button onclick="closeGroceryPanel()">Return to Main Screen</button>
  </div>

  <!-- Community Garden Panel -->
  <div id="garden-panel" class="panel">
    <h2>Community Garden</h2>
    <p>Manage your rooftop garden. Plants need water every 5 minutes and mature in 1 hour. Seeds can be obtained from the grocery store or by chance.</p>
    <div id="plantSlots">
      <!-- 10 Plant Slots -->
      <div class="slot" id="slot1">Slot 1: <span class="status">Empty</span> <button onclick="plantSeed(1)">Plant Seed</button></div>
      <div class="slot" id="slot2">Slot 2: <span class="status">Empty</span> <button onclick="plantSeed(2)">Plant Seed</button></div>
      <div class="slot" id="slot3">Slot 3: <span class="status">Empty</span> <button onclick="plantSeed(3)">Plant Seed</button></div>
      <div class="slot" id="slot4">Slot 4: <span class="status">Empty</span> <button onclick="plantSeed(4)">Plant Seed</button></div>
      <div class="slot" id="slot5">Slot 5: <span class="status">Empty</span> <button onclick="plantSeed(5)">Plant Seed</button></div>
      <div class="slot" id="slot6">Slot 6: <span class="status">Empty</span> <button onclick="plantSeed(6)">Plant Seed</button></div>
      <div class="slot" id="slot7">Slot 7: <span class="status">Empty</span> <button onclick="plantSeed(7)">Plant Seed</button></div>
      <div class="slot" id="slot8">Slot 8: <span class="status">Empty</span> <button onclick="plantSeed(8)">Plant Seed</button></div>
      <div class="slot" id="slot9">Slot 9: <span class="status">Empty</span> <button onclick="plantSeed(9)">Plant Seed</button></div>
      <div class="slot" id="slot10">Slot 10: <span class="status">Empty</span> <button onclick="plantSeed(10)">Plant Seed</button></div>
      <!-- Special Mushroom Tree Slot -->
      <div class="slot" id="mushroomTree">Mushroom Tree: <span class="status">Empty</span> <button onclick="plantMushroomTree()">Plant Tree</button></div>
    </div>
    <button onclick="closeGardenPanel()">Return to Main Screen</button>
  </div>

  <!-- Chat Panel -->
  <div id="chatPanel" class="panel">
    <h2 id="chatRoomTitle"></h2>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="closeChat()">Close Chat</button>
  </div>
</div>

<script>
  // ----------------------------
  // Global Editing State
  // ----------------------------
  let isEditing = false;
  
  // ----------------------------
  // Garden State (Local Simulation)
  // ----------------------------
  let garden = {};
  for (let i = 1; i <= 10; i++) {
    garden[i] = { plantedTime: null, wateredTime: null, mature: false };
  }
  // Mushroom tree slot is index 11
  garden[11] = { plantedTime: null, wateredTime: null, mature: false, mushrooms: 0 };
  
  function updateGardenUI() {
    for (let i = 1; i <= 10; i++) {
      let slot = document.getElementById('slot' + i);
      let statusSpan = slot.querySelector('.status');
      if (garden[i].plantedTime === null) {
        statusSpan.textContent = "Empty";
      } else {
        let elapsed = (Date.now() - garden[i].plantedTime) / 60000;
        if (elapsed >= 60 && !garden[i].mature) {
          garden[i].mature = true;
          statusSpan.textContent = "Mature";
          slot.querySelector('button').style.display = 'none';
        } else if (!garden[i].mature) {
          statusSpan.textContent = "Growing (" + Math.floor(elapsed) + " min)";
        }
      }
    }
    let treeSlot = document.getElementById('mushroomTree');
    let treeStatus = treeSlot.querySelector('.status');
    if (garden[11].plantedTime === null) {
      treeStatus.textContent = "Empty";
    } else {
      let elapsed = (Date.now() - garden[11].plantedTime) / 60000;
      if (elapsed >= 60 && !garden[11].mature) {
        garden[11].mature = true;
        garden[11].mushrooms = 5;
        treeStatus.textContent = "Mature (" + garden[11].mushrooms + " mushrooms)";
        treeSlot.querySelector('button').style.display = 'none';
      } else if (!garden[11].mature) {
        treeStatus.textContent = "Growing (" + Math.floor(elapsed) + " min)";
      }
    }
  }
  
  function plantSeed(slotNumber) {
    if (garden[slotNumber].plantedTime === null) {
      garden[slotNumber].plantedTime = Date.now();
      garden[slotNumber].wateredTime = Date.now();
      updateGardenUI();
    } else {
      alert("A seed is already planted in Slot " + slotNumber + ".");
    }
  }
  
  function plantMushroomTree() {
    if (garden[11].plantedTime === null) {
      garden[11].plantedTime = Date.now();
      garden[11].wateredTime = Date.now();
      updateGardenUI();
    } else {
      alert("The mushroom tree is already planted.");
    }
  }
  
  setInterval(function() {
    for (let i = 1; i <= 11; i++) {
      if (garden[i].plantedTime !== null) {
        garden[i].wateredTime = Date.now();
      }
    }
    updateGardenUI();
  }, 300000); // Every 5 minutes
  
  // ----------------------------
  // Helper: Sanitize Player Name
  // ----------------------------
  function sanitizePlayerName(name) {
    return name.replace(/[\/\\]/g, '_');
  }

  // ----------------------------
  // Firebase Initialization
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
    authDomain: "thephantasyreport.firebaseapp.com",
    projectId: "thephantasyreport",
    storageBucket: "thephantasyreport.firebasestorage.app",
    messagingSenderId: "887983841070",
    appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
    measurementId: "G-9MS36H0YV4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ----------------------------
  // Navigation Functions
  // ----------------------------
  function showPowerPanel() {
    document.getElementById('minigame-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function showGarbagePanel() {
    updateGarbageDisplay();
    document.getElementById('garbage-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function hidePanel(panelId) {
    document.getElementById(panelId).style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }
  function handleClick(label) {
    alert("Facility: " + label);
  }
  function togglePlayerStatus() {
    const statusBox = document.getElementById('playerStatus');
    statusBox.style.display = (statusBox.style.display === "none" || statusBox.style.display === "") ? "block" : "none";
  }

  // ----------------------------
  // Chat Functions using Firestore
  // ----------------------------
  let currentRoom = "";
  function openRoomChat(roomName) {
    currentRoom = roomName;
    document.getElementById('chatRoomTitle').textContent = roomName + " Chat";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function listenForMessages(roomName) {
    const chatLog = document.getElementById('chatLog');
    const messagesRef = db.collection("messages");
    messagesRef
      .where("room", "==", roomName)
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  function closeChat() {
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    currentRoom = "";
  }
  async function sendChatMessage() {
    const msg = document.getElementById('chatInput').value;
    if (msg.trim() !== "") {
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      try {
        await db.collection("messages").add({
          room: currentRoom,
          sender: characterName,
          content: msg,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('chatInput').value = "";
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ----------------------------
  // Power Source Simulation Functions
  // ----------------------------
  let windSpeed = localStorage.getItem('windSpeed') || 50;
  let brakeEngaged = JSON.parse(localStorage.getItem('brakeEngaged')) || false;
  let powerOutputConfirmed = JSON.parse(localStorage.getItem('powerOutputConfirmed')) || false;
  let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
  let garbageLevel = localStorage.getItem('garbageLevel') || 0;
  let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
  
  function updateWindSpeed() {
    windSpeed = document.getElementById('windSpeedSlider').value;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    localStorage.setItem('windSpeed', windSpeed);
    updateVoltage();
    updateLastInteraction();
  }
  function toggleBrake() {
    brakeEngaged = !brakeEngaged;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    localStorage.setItem('brakeEngaged', brakeEngaged);
    updateVoltage();
    updateLastInteraction();
  }
  function togglePowerOutput() {
    powerOutputConfirmed = !powerOutputConfirmed;
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    localStorage.setItem('powerOutputConfirmed', powerOutputConfirmed);
    updateLastInteraction();
  }
  function lubricate() {
    logPowerMessage("Lubrication complete. Moving parts are now well-oiled.");
    updateLastInteraction();
  }
  function updateVoltage() {
    let factor = brakeEngaged ? 0.5 : 1.0;
    let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
    voltage = Math.max(0, voltage);
    document.getElementById('voltageDisplay').textContent = voltage.toFixed(1);
    localStorage.setItem('voltage', voltage);
  }
  function simulateRandomEvent() {
    if (Date.now() - lastInteractionTime > 30000) {
      logPowerMessage("System overload due to inactivity! Flats experience a blackout for 1-2 days.");
    }
    const events = [
      "Sudden strong winds detected! Adjust wind speed or engage brakes.",
      "Low energy output observed! Check lubrication or adjust controls.",
      "Minor electrical fault occurred! Reset the circuit breaker.",
      "Dust accumulation detected! Perform a quick maintenance check."
    ];
    logPowerMessage(events[Math.floor(Math.random() * events.length)]);
  }
  function logPowerMessage(message) {
    const logDiv = document.getElementById('minigameLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  function toggleInstructions() {
    const instrDiv = document.getElementById("instructions");
    instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
  }
  function updateLastInteraction() {
    lastInteractionTime = Date.now();
    localStorage.setItem('lastInteractionTime', lastInteractionTime);
  }

  // ----------------------------
  // Garbage Chute Simulation Functions
  // ----------------------------
  function updateGarbageDisplay() {
    const now = Date.now();
    const elapsedHours = Math.floor((now - lastGarbageUpdate) / 3600000);
    garbageLevel = Math.min(100, Number(garbageLevel) + elapsedHours * 10);
    lastGarbageUpdate = now;
    localStorage.setItem('garbageLevel', garbageLevel);
    localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
  }
  function clearGarbage() {
    garbageLevel = 0;
    localStorage.setItem('garbageLevel', garbageLevel);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    logGarbageMessage("Garbage cleared by player.");
  }
  function logGarbageMessage(message) {
    const logDiv = document.getElementById('garbageLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // ----------------------------
  // Firebase: Player Status & Character Management
  // ----------------------------
  function updatePlayerStatus() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    db.collection('players').doc(safePlayerName)
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          localStorage.setItem('characterName', data.name);
          let statusHTML = `<h3>Biodata</h3>`;
          if (!isEditing) {
            statusHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
            statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
            statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
            statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
            statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
            statusHTML += `<p><strong>Gender:</strong> ${data.gender || "N/A"}</p>`;
            statusHTML += `<p><strong>Age:</strong> ${data.age}</p>`;
            statusHTML += `<p><strong>Reason:</strong> ${data.reason}</p>`;
            statusHTML += `<p><strong>Physical:</strong> ${data.conditions.physical}</p>`;
            statusHTML += `<p><strong>Mental:</strong> ${data.conditions.mental}</p>`;
            statusHTML += `<p><strong>Activity:</strong> ${data.conditions.activity}</p>`;
            statusHTML += `<p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString()}</p>`;
            statusHTML += `<button onclick="enableEdit()">Edit</button>`;
          } else {
            statusHTML += `<p><strong>Name:</strong> <input type="text" id="editName" value="${data.name}" /></p>`;
            statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
            statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
            statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
            statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
            statusHTML += `<p><strong>Gender:</strong> ${data.gender || "N/A"}</p>`;
            statusHTML += `<p><strong>Age:</strong> <input type="number" id="editAge" value="${data.age}" /></p>`;
            statusHTML += `<p><strong>Reason:</strong> <textarea id="editReason">${data.reason}</textarea></p>`;
            statusHTML += `<p><strong>Physical:</strong> ${data.conditions.physical}</p>`;
            statusHTML += `<p><strong>Mental:</strong> ${data.conditions.mental}</p>`;
            statusHTML += `<p><strong>Activity:</strong> ${data.conditions.activity}</p>`;
            statusHTML += `<p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString()}</p>`;
            statusHTML += `<button onclick="saveBiodata()">Save Changes</button> `;
            statusHTML += `<button onclick="cancelEdit()">Cancel</button>`;
          }
          document.getElementById('playerStatus').innerHTML = statusHTML;
        }
      }, (error) => {
        console.error("Error getting player status:", error);
      });
  }
  function checkCharacterExistence() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    db.collection('players').doc(safePlayerName).get().then((doc) => {
      if (doc.exists) {
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      } else {
        document.getElementById('characterCreation').style.display = 'block';
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('displayName').innerText = playerName;
        document.getElementById('charName').value = playerName;
      }
    }).catch((error) => {
      console.error("Error checking character existence:", error);
    });
  }
  function createCharacter() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    const charName = document.getElementById('charName').value;
    const charAge = document.getElementById('charAge').value;
    const charGender = document.getElementById('charGender').value;
    const charReason = document.getElementById('charReason').value;
    const playerData = {
      name: charName,
      age: charAge,
      gender: charGender,
      reason: charReason,
      health: 100,
      hunger: 0,
      injury: 0,
      mood: 100,
      conditions: {
        physical: "Healthy",
        mental: "Content",
        activity: "Idle"
      },
      lastUpdated: Date.now()
    };
    db.collection('players').doc(safePlayerName).set(playerData, { merge: true })
      .then(() => {
        localStorage.setItem('characterName', charName);
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      })
      .catch((error) => {
        console.error("Error creating character:", error);
      });
  }

  // ----------------------------
  // New: Editing Functions
  // ----------------------------
  function enableEdit() {
    isEditing = true;
    updatePlayerStatus();
  }
  function cancelEdit() {
    isEditing = false;
    updatePlayerStatus();
  }
  function saveBiodata() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    const newName = document.getElementById('editName').value;
    const newAge = document.getElementById('editAge').value;
    const newReason = document.getElementById('editReason').value;
    db.collection('players').doc(safePlayerName).set({
       name: newName,
       age: newAge,
       reason: newReason,
       lastUpdated: Date.now()
    }, { merge: true })
    .then(() => {
       localStorage.setItem('characterName', newName);
       isEditing = false;
       alert('Biodata updated successfully.');
    })
    .catch((error) => {
       console.error("Error updating biodata:", error);
    });
  }

  // ----------------------------
  // New: Grocery Store Functions
  // ----------------------------
  function openGroceryPanel() {
    document.getElementById('grocery-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function closeGroceryPanel() {
    document.getElementById('grocery-panel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }
  function buyItem(item) {
    alert("You purchased " + item + ".");
  }

  // ----------------------------
  // New: Community Garden Functions
  // ----------------------------
  function openGardenPanel() {
    document.getElementById('garden-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    updateGardenUI();
  }
  function closeGardenPanel() {
    document.getElementById('garden-panel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }
  
  // ----------------------------
  // New: Exit / Sign Out Function
  // ----------------------------
  function signOutUser() {
    firebase.auth().signOut().then(() => {
      localStorage.removeItem('playerName');
      localStorage.removeItem('characterName');
      window.location.href = "index.html";
    }).catch((error) => {
      console.error("Error signing out:", error);
    });
  }

  // ----------------------------
  // Initialization
  // ----------------------------
  window.onload = function() {
    document.getElementById('windSpeedSlider').value = windSpeed;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    updateVoltage();
    updateGarbageDisplay();
    if (localStorage.getItem('playerName')) {
      checkCharacterExistence();
    }
    setInterval(updateVoltage, 5000);
    setInterval(simulateRandomEvent, 3600000);
    setInterval(updateGarbageDisplay, 3600000);
    setInterval(updateGardenUI, 60000);
  };
</script>
</body>
</html>
