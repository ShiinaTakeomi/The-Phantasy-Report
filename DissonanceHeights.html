<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    /* Set body background with full image */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
      position: relative;
    }
    /* Apply full-page dark overlay using a pseudo-element */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5));
      z-index: -1;
      pointer-events: none;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .container, .panel, #characterCreation, .modal {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    /* Grid of Rooms */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* Buttons */
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    /* Re-added Exit Button below Garbage Chute per request */
    .exit-button {
      position: absolute;
      left: 0;
      top: 530px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(200,150,130,0.7);
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
    }
    /* Character Creation Section â€“ REMOVED authentication parts per requirements */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Enlarged editing fields for Biodata */
    #playerStatus input,
    #playerStatus textarea {
      width: 100% !important;
      font-size: 16px;
      padding: 8px;
      margin-bottom: 10px;
    }
    /* Modal Styles (for plant selection, door interaction) */
    .modal, #doorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea,
    #doorModal button, #doorModal input {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    /* Responsive Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    /* Responsive Chat Log */
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Biodata Panel */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Harvest Inventory Display */
    #harvestInventory {
      margin-top: 10px;
      padding: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
    }
    /* Garden Slots */
    #garden-panel .slot {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #777;
      border-radius: 4px;
    }
    #garden-panel .slot button {
      margin-left: 5px;
      padding: 3px 6px;
      font-size: 12px;
    }
    /* In-App Notification Panel */
    #notificationPanel {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px;
      border: 1px solid #fff;
      border-radius: 4px;
      z-index: 1002;
      display: none;
      max-width: 300px;
      font-size: 14px;
    }
    /* Community Kitchen Panel with Tabs */
    #kitchen-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .tab-headers {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .tab-button {
      background-color: #444;
      border: 1px solid #999;
      border-radius: 4px;
      color: #eee;
      cursor: pointer;
      padding: 10px;
      margin: 0 5px;
    }
    .tab-button:hover {
      background-color: #555;
    }
    .tab-button.active {
      background-color: #00bfff;
      color: #222;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Grocery Stand Styles */
    .grocery-items-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .grocery-item {
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      color: #e0e0e0;
    }
    .grocery-item:hover {
      transform: scale(1.03);
      box-shadow: 0 0 10px #00bfff;
    }
    .grocery-item p {
      margin: 0 0 8px;
      font-size: 15px;
      font-weight: bold;
    }
    .grocery-item button {
      background-color: #00bfff;
      border: none;
      border-radius: 5px;
      padding: 8px;
      color: #222;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    .grocery-item button:hover {
      background-color: #009acd;
    }
    /* Environmental Status Panel */
    #envStatus {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
      margin: 10px auto;
      max-width: 600px;
    }
    /* Spelunking Game Styles */
    #spelunkingGame {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 1100;
    }
    #spelunkingCanvas {
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, #444 0%, #000 70%);
    }
    #exitSpelunking {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #FF4136;
      color: #fff;
      cursor: pointer;
      z-index: 1200;
    }
    /* Recipe Book Cooking Indicator */
    #cookingProcess {
      display: none;
      background: #222;
      color: #fff;
      padding: 10px;
      margin-top: 10px;
      text-align: center;
      border-radius: 4px;
    }
  </style>
  <!-- Firebase SDKs: Auth, Firestore, and Storage -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="wrapper">
    <!-- Music Player Container (hidden by default) -->
    <div id="musicPlayerContainer" style="position:absolute; left:-9999px;">
      <iframe id="bgMusic" width="300" height="200"
        src="https://www.youtube.com/embed/A6WJVzEIQa4?autoplay=1&loop=1&playlist=A6WJVzEIQa4"
        frameborder="0"
        allow="autoplay; encrypted-media"
        allowfullscreen>
      </iframe>
    </div>

    <!-- Music Controls -->
    <div style="text-align:center; margin-top:10px;">
      <button onclick="toggleMusicPlayer()">Toggle Music Player</button>
    </div>

    <!-- Music Player JavaScript (Consolidated) -->
    <script>
      // Toggle the music player without resetting the current song.
      function toggleMusicPlayer() {
        const container = document.getElementById("musicPlayerContainer");
        console.log("Toggle Music Player invoked. Current container.left:", container.style.left);
        if (container.style.left === "-9999px" || container.style.left === "") {
          container.style.left = "0";
          console.log("Music player shown");
        } else {
          container.style.left = "-9999px";
          console.log("Music player hidden");
        }
      }

      // Function to switch to the next song manually (if needed in the future).
      const playlist = ["A6WJVzEIQa4", "LmwfxVrbyGw", "DP3rDP02lE0", "r9k74AGYZoU", "kQk5fO3YZ9c", "LlN8MPS7KQs"];
      let currentSongIndex = 0;
      function nextSong() {
        currentSongIndex = (currentSongIndex + 1) % playlist.length;
        const videoId = playlist[currentSongIndex];
        const iframe = document.getElementById("bgMusic");
        iframe.src = "https://www.youtube.com/embed/" + videoId + "?autoplay=1&loop=1&playlist=" + videoId;
      }
    </script>

    <!-- Character Creation Section (optional; you may auto-assign a default guest name) -->
    <div id="characterCreation">
      <h3>Create Your Character</h3>
      <p>Welcome, <span id="displayName"></span>!</p>
      <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
        <input type="text" id="charName" placeholder="Name" required>
        <input type="number" id="charAge" placeholder="Age" required>
        <select id="charGender" required>
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
        <textarea id="charBackstory" placeholder="Backstory" required></textarea>
        <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
        <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
        <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
        <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
        <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
        <select id="roomNumber" required>
          <option value="">Select Room Number</option>
        </select>
        <button type="submit">Create Character</button>
      </form>
    </div>
    <!-- Main Game Section -->
    <div id="mainGame" style="display: none;">
      <!-- Notification Panel -->
      <div id="notificationPanel"></div>
      <!-- Main Screen -->
      <div id="main-screen">
        <div class="container">
          <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
          <!-- Re-added Exit Button below Garbage Chute -->
          <button class="exit-button" onclick="signOutUser()">Exit</button>
          <script>
            function signOutUser() {
              firebase.auth().signOut().then(() => {
                clearGameState();
                window.location.href = 'index.html';
              }).catch((error) => {
                console.error("Error signing out: ", error);
              });
            }
          </script>
          <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
          <div class="grid">
            <!-- Room buttons generated dynamically -->
          </div>
          <button class="power-room" onclick="showPowerPanel()">
            Power Room <span id="powerAlert" style="display:none; font-size:1.2em; color:red;">!</span>
          </button>
        </div>
        <div class="facilities">
          <button onclick="openKitchenPanel()">Community Kitchen</button>
          <button onclick="openGroceryPanel()">Groceries Stand</button>
          <button onclick="openWaterPanel()">Water Supplies (Laundry)</button>
          <button onclick="togglePlayerStatus()">Biodata</button>
        </div>
        <!-- New Environmental Status Panel -->
        <div id="envStatus"></div>
        <div id="playerStatus">
          <!-- Biodata dynamically updated -->
        </div>
      </div>
      <!-- Panels -->
      <!-- Power Panel -->
      <div id="minigame-panel" class="panel">
        <h2>Wind Turbine Control Panel</h2>
        <p><strong>Objective:</strong> Ensure the turbine provides electricity, water heating, and lighting.</p>
        <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
        <div id="instructions" style="display: none;">
          <p>
            <strong>Step 1:</strong> Adjust the wind speed slider (optimal range: 40â€“70).<br>
            <strong>Step 2:</strong> Pull the electrical output lever to toggle power supply.<br>
            <strong>Step 3:</strong> Check water pressure and heater levels by pressing the corresponding buttons.<br>
            <strong>Step 4:</strong> Ensure the overall light status is "On".<br><br>
            <em>Note:</em> Every minute one of five malfunctions may occur. Follow the on-screen instructions to fix them; failure will negatively affect your biodata.
          </p>
        </div>
        <div class="control">
          <label for="windSpeedSlider">Wind Speed:</label>
          <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
          <span id="windSpeedValue"></span>
        </div>
        <div class="control">
          <label>Electrical Output:</label>
          <button id="outputLeverButton" onclick="toggleElectricalOutput()">Toggle Output</button>
        </div>
        <div class="control">
          <label>Water Pressure:</label>
          <button id="checkWaterPressureButton" onclick="checkWaterPressure()">Check Water</button>
        </div>
        <div class="control">
          <label>Heater Level:</label>
          <button id="checkHeaterLevelButton" onclick="checkHeaterLevel()">Check Heater</button>
        </div>
        <div class="control">
          <label>Light Status:</label>
          <span id="lightStatusDisplay">Unknown</span>
        </div>
        <div class="control">
          <label>Voltage:</label>
          <span id="voltageDisplay">0.0</span>
        </div>
        <div class="control">
          <button onclick="hidePanel('minigame-panel')">Return to Main Menu</button>
        </div>
        <h3>System Log:</h3>
        <div id="minigameLog"></div>
        <div class="control">
          <label>Power Status:</label>
          <span id="powerStatusDisplay">Unknown</span>
        </div>
      </div>
      <!-- Garbage Chute Panel -->
      <div id="garbage-panel" class="panel">
        <h2>Garbage Chute Control</h2>
        <p><strong>Objective:</strong> Clear accumulated garbage before it causes a community health crisis.</p>
        <div class="control">
          <label>Garbage Level:</label>
          <span id="garbageDisplay"></span> / 100
        </div>
        <div class="control">
          <button onclick="clearGarbage()">Clear Garbage</button>
        </div>
        <div class="control">
          <button onclick="hidePanel('garbage-panel')">Return to Main Menu</button>
        </div>
        <h3>Garbage Log:</h3>
        <div id="garbageLog"></div>
      </div>
      <!-- Grocery Stand Panel -->
      <div id="grocery-panel" class="panel">
        <h2>Grocery Store</h2>
        <p>Purchase essential items. Prices may vary with electricity availability.</p>
        <!-- Tab Headers -->
        <div class="tab-headers">
          <button class="tab-button active" onclick="openTab(event, 'buyTab')">Buy Items</button>
          <button class="tab-button" onclick="openTab(event, 'sellTab')">Sell Items</button>
        </div>
        <!-- Tab Content -->
        <div id="buyTab" class="tab-content" style="display: block;">
          <div id="buySection" class="grocery-items-container">
            <!-- Basic Food Group -->
            <h4>Basic Food</h4>
            <div id="basicFoodContainer" class="grocery-items-container">
              <div class="grocery-item">
                <p>
                  <strong>Food Staples</strong> - $10<br>
                  <em>Basic nourishment to reduce hunger.</em>
                </p>
                <button onclick="buyItem('Food Staples')">Buy Food</button>
              </div>
            </div>
            <!-- Seeds Group -->
            <h4>Seeds for Community Garden</h4>
            <div id="seedList"></div>
            <!-- Mushrooms Group -->
            <h4>Mushrooms for Cultivation</h4>
            <div id="mushroomList"></div>
            <!-- Maintenance Items Group -->
            <h4>Maintenance Items</h4>
            <div id="maintenanceContainer" class="grocery-items-container">
              <div class="grocery-item">
                <p>
                  <strong>Lubricant Oil</strong> - $5<br>
                  <em>Essential for keeping the power panel running smoothly.</em>
                </p>
                <button onclick="buyItem('Lubricant Oil')">Buy Lubricant Oil</button>
              </div>
              <div class="grocery-item">
                <p>
                  <strong>Alcohol</strong> - $3<br>
                  <em>Boosts mood but may have minor setbacks on health.</em>
                </p>
                <button onclick="buyItem('Alcohol')">Buy Alcohol</button>
              </div>
              <div class="grocery-item">
                <p>
                  <strong>Cigarettes</strong> - $4<br>
                  <em>Temporarily improves mood but reduces health over time.</em>
                </p>
                <button onclick="buyItem('Cigarettes')">Buy Cigarettes</button>
              </div>
            </div>
            <!-- Baking Supplies Group -->
            <h4>Baking Supplies</h4>
            <div id="bakingContainer" class="grocery-items-container"></div>
            <!-- Health Items Group -->
            <h4>Health Items</h4>
            <div id="healthItemList"></div>
          </div>
        </div>
        <div id="sellTab" class="tab-content" style="display: none;">
          <div id="sellSection">
            <h3>Sell Your Harvest</h3>
            <div id="sellInventory">
              <!-- Dynamically generated sell inventory list -->
            </div>
            <button onclick="sellHarvest()">Sell Selected Items</button>
          </div>
        </div>
        <button onclick="hidePanel('grocery-panel')">Return to Main Menu</button>
      </div>
      <!-- Community Garden Panel (Updated Layout) -->
      <div id="garden-panel" class="panel">
        <h2>Community Garden</h2>
        <p>Manage your rooftop garden. Plant your essential seeds in <strong>Soil</strong> slots and mushrooms in <strong>Tree Stump</strong> slots. Each plant takes 5 minutes to mature and needs water to grow.</p>
        <div id="plantSlots"></div>
        <button onclick="harvestProduce()">Harvest Produce</button>
        <button onclick="hidePanel('garden-panel')">Return to Main Menu</button>
      </div>
      <!-- Community Kitchen Panel with Tabs for Chat and Cookbook -->
      <div id="kitchen-panel" class="panel">
        <h2>Community Kitchen</h2>
        <div class="tab-headers">
          <button class="tab-button active" onclick="openKitchenTab(event, 'kitchenChatTab')">Chat</button>
          <button class="tab-button" onclick="openKitchenTab(event, 'cookbookTab')">Cookbook</button>
        </div>
        <div id="kitchenChatTab" class="tab-content active">
          <div id="kitchenChatLog" class="chatArea" style="height:150px; overflow-y:auto; background: rgba(255,255,255,0.1); color:#fff; border:1px solid #ccc; padding:10px; border-radius:4px;"></div>
          <input type="text" id="kitchenChatInput" placeholder="Type a message...">
          <button onclick="sendKitchenChat()">Send</button>
        </div>
        <div id="cookbookTab" class="tab-content">
          <div id="recipeContainer"></div>
          <!-- Cooking Process Indicator -->
          <div id="cookingProcess">Cooking in progress... Please wait 1 minute.</div>
        </div>
        <button onclick="hidePanel('kitchen-panel')">Return to Main Menu</button>
      </div>
      <!-- Water Supplies Panel (Chat area styling updated to match Community Kitchen) -->
      <div id="water-panel" class="panel">
        <h2>Water Supplies (Laundry)</h2>
        <p>Water pressure is directly linked to the performance of the power panel and environmental efficiency (affected by garbage levels). Use the washing machine to clean clothes â€“ remember, low power output or high garbage may result in lower water pressure.</p>
        <div>
          <p>
            <strong>Water Pressure:</strong> 
            <span id="waterPressureDisplay">Calculating...</span> PSI
          </p>
          <p>
            <strong>Water Inventory:</strong> 
            <span id="waterInventoryDisplay">0</span> units
          </p>
          <button onclick="collectWater()">Collect Water</button>
        </div>
        <div>
          <h4>Washing Machine</h4>
          <button onclick="washClothes()">Wash Clothes</button>
          <!-- Updated chat area styling to match Community Kitchen -->
          <div class="chatArea" id="laundryChatLog" style="height:150px; overflow-y:auto; background: rgba(255,255,255,0.1); color:#fff; border:1px solid #ccc; padding:10px; border-radius:4px;"></div>
          <input type="text" id="laundryChatInput" placeholder="Type a message...">
          <button onclick="sendLaundryChat()">Send</button>
        </div>
        <button onclick="hidePanel('water-panel')">Return to Main Menu</button>
      </div>
      <!-- Chat Panel -->
      <div id="chatPanel" class="panel">
        <h2 id="chatRoomTitle"></h2>
        <div id="chatLog"></div>
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button onclick="sendChatMessage()">Send</button>
        <button onclick="closeChat()">Close Chat</button>
        <div id="restContainer" style="margin-top:10px;"></div>
      </div>
    </div>
    <!-- Door Modal -->
    <div id="doorModal">
      <h2 id="doorTitle">Door Interaction</h2>
      <div id="doorOptions">
        <button onclick="handleKnock()">Knock</button>
        <button onclick="showPasswordInput()">Enter Password</button>
      </div>
      <div id="passwordDiv" style="display:none;">
        <input type="text" id="doorPassword" placeholder="Enter 4-digit password">
        <button onclick="verifyPassword()">Submit Password</button>
      </div>
      <button onclick="closeDoorModal()">Cancel</button>
    </div>
    <!-- Spelunking Game Container -->
    <div id="spelunkingGame">
      <canvas id="spelunkingCanvas"></canvas>
      <button id="exitSpelunking" onclick="exitSpelunkingGame()">Exit Cave</button>
    </div>
  </div>
  <script>
    // Store original background settings (main menu background)
    const originalBackground = "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed";
    
    // Firebase Initialization & Config
    const firebaseConfig = {
      apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
      authDomain: "thephantasyreport.firebaseapp.com",
      projectId: "thephantasyreport",
      storageBucket: "thephantasyreport.firebasestorage.app",
      messagingSenderId: "887983841070",
      appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
      measurementId: "G-9MS36H0YV4"
    };
    firebase.initializeApp(firebaseConfig);
    // Authentication functions removed per requirement.
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Room Password Mapping
    const roomPasswords = {
      "Room 1": "0001",
      "Room 2": "1414",
      "Room 3": "0003",
      "Room 4": "0004",
      "Room 5": "0005",
      "Room 6": "0006",
      "Room 7": "0007",
      "Room 8": "0008",
      "Room 9": "0009",
      "Room 10": "0010",
      "Room 11": "0011",
      "Room 12": "0715",
      "Room 13": "0013",
      "Room 14": "0014",
      "Room 15": "0015",
      "Room 16": "0016",
      "Room 17": "0017",
      "Room 18": "0018",
      "Room 19": "0019",
      "Room 20": "0020",
      "Room 21": "0021",
      "Room 22": "0022",
      "Room 23": "0023",
      "Room 24": "0024",
      "Room 25": "0025"
    };

    // Global variables
    let currentRoom = "";
    let doorChatMode = false;
    let harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
    let waterInventory = parseInt(localStorage.getItem('water')) || 0;

    // --- Community Garden: Two separate arrays (Soil for seeds, Tree Stump for mushrooms) ---
    let soilSlots = Array.from({length: 5}, (_, i) => ({
      slot: i + 1,
      type: null,
      watered: false,
      timer: null
    }));
    let stumpSlots = Array.from({length: 5}, (_, i) => ({
      slot: i + 1,
      type: null,
      watered: false,
      timer: null
    }));

    // Seeds and Mushrooms (exactly 5 each)
    const seedTypes = [
      "Sunflower Seed", "Pumpkin Seed", "Corn Seed", "Wheat Seed", "Rice Seed"
    ];
    const mushroomTypes = [
      "Button Mushroom", "Portobello Mushroom", "Shiitake Mushroom", "Oyster Mushroom", "Enoki Mushroom"
    ];

    // Cookie Recipes (exactly 4 types)
    const recipes = [
      {
        name: "Vitality Cookie",
        ingredients: { "Flour": 2, "Egg": 1, "Butter": 1, "Sugar": 1 },
        benefits: { health: 20 },
        cons: { hunger: 5 }
      },
      {
        name: "Cheer Cookie",
        ingredients: { "Flour": 1, "Egg": 1, "Butter": 1, "Sugar": 2 },
        benefits: { mood: 20 },
        cons: { health: -5 }
      },
      {
        name: "Sustenance Cookie",
        ingredients: { "Flour": 1, "Egg": 2, "Sugar": 1 },
        benefits: { hunger: -20 },
        cons: { mood: -5 }
      },
      {
        name: "Ambition Cookie",
        ingredients: { "Flour": 2, "Egg": 1, "Butter": 1, "Sugar": 2 },
        benefits: { reputation: 10 },
        cons: { health: -10 }
      }
    ];

    // Helper Functions: Update Mood, Hunger, Health, Reputation
    function updateMood(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentMood = doc.data().mood || 100;
          let newMood = Math.max(0, currentMood + delta);
          db.collection('players').doc(safePlayerName).set({ mood: newMood, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
    function updateHunger(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentHunger = doc.data().hunger || 0;
          let newHunger = Math.max(0, currentHunger + delta);
          db.collection('players').doc(safePlayerName).set({ hunger: newHunger, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
    function updateHealth(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentHealth = doc.data().health || 100;
          let newHealth = Math.min(100, Math.max(0, currentHealth + delta));
          db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
    function updateReputation(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentRep = doc.data().reputation || 0;
          let newRep = currentRep + delta;
          db.collection('players').doc(safePlayerName).set({ reputation: newRep, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }

    // Inventory Functions
    function addItem(item, qty = 1) {
      harvestInventory[item] = (harvestInventory[item] || 0) + qty;
      localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
      updateHarvestInventoryUI();
    }
    function removeItem(item, qty = 1) {
      if (harvestInventory[item]) {
        harvestInventory[item] = Math.max(0, harvestInventory[item] - qty);
        if (harvestInventory[item] === 0) delete harvestInventory[item];
      }
      localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
      updateHarvestInventoryUI();
    }
    function updateHarvestInventoryUI() {
      const invDiv = document.getElementById('harvestInventory');
      let html = "";
      for (let item in harvestInventory) {
        html += `<p>${item}: ${harvestInventory[item]}</p>`;
      }
      invDiv.innerHTML = html || "<p>None</p>";
    }

    // In-App Notification Listener
    function listenForNotifications() {
      let playerName = localStorage.getItem('playerName') || "Guest";
      if (!playerName) return;
      db.collection("notifications")
        .where("owner", "==", playerName)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          let notifications = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            notifications += `<p>${data.message}</p>`;
          });
          const panel = document.getElementById("notificationPanel");
          if (notifications) {
            panel.innerHTML = notifications;
            panel.style.display = "block";
          } else {
            panel.style.display = "none";
          }
        });
    }

    // Utility: Clear All Game State
    function clearGameState() {
      const keys = ['playerName', 'characterName', 'money', 'seeds', 'mushroomSeeds', 'windSpeed', 'lastInteractionTime', 'garbageLevel', 'lastGarbageUpdate', 'harvestInventory', 'water'];
      keys.forEach(key => localStorage.removeItem(key));
    }

    // Panel Navigation Functions
    function showGarbagePanel() {
      document.getElementById('garbage-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
    }
    function showPowerPanel() {
      document.body.style.backgroundImage = "url('https://i.pinimg.com/736x/2d/d9/76/2dd9762815138628d3c380fe097241d2.jpg')";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
      document.getElementById('minigame-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
    }
    function openGroceryPanel() {
      document.getElementById('grocery-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      generateGroceryItems();
      updateHarvestInventoryUI();
    }
    function openGardenPanel() {
      document.body.style.backgroundImage = "url('https://i.pinimg.com/736x/1a/97/af/1a97af089b326864a32ddb9f788c7c2d.jpg')";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
      document.getElementById('garden-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      renderGardenSlots();
    }
    function openKitchenPanel() {
      document.getElementById('kitchen-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      openKitchenTab(null, 'kitchenChatTab');
      listenForKitchenChat();
    }
    function openWaterPanel() {
      document.getElementById('water-panel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      updateWaterPressure();
      document.getElementById('waterInventoryDisplay').textContent = waterInventory;
    }
    function hidePanel(panelId) {
      document.getElementById(panelId).style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';
      document.body.style.backgroundImage = "url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2')";
      document.body.style.backgroundRepeat = "no-repeat";
      document.body.style.backgroundAttachment = "fixed";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
    }

    // Purchase and Inventory Functions
    function buyItem(item) {
      const prices = {
        'Food Staples': 10,
        'Lubricant Oil': 5,
        'Alcohol': 3,
        'Cigarettes': 4,
        'Flour': 3,
        'Sugar': 2,
        'Egg': 1,
        'Butter': 4
      };
      let price = prices[item] || 2;
      let money = parseInt(localStorage.getItem('money')) || 50;
      if (money >= price) {
        money -= price;
        localStorage.setItem('money', money);
        alert("Purchased " + item + " for $" + price + ". Remaining money: $" + money);
        addItem(item, 1);
        applyItemEffects(item);
        updatePlayerStatus();
      } else {
        alert("Not enough money to purchase " + item);
      }
    }
    function applyItemEffects(item) {
      switch(item) {
        case "Food Staples":
          updateHunger(-5);
          updateMood(2);
          break;
        case "Lubricant Oil":
          updateMood(1);
          break;
        default:
          if(item.includes("Seed")) {
            updateMood(2);
          } else if(item.includes("Mushroom")) {
            updateMood(1);
            updateHunger(-1);
          } else if(item === "Alcohol") {
            updateMood(3);
            updateHunger(1);
          } else if(item === "Cigarettes") {
            updateMood(2);
            updateHunger(1);
          }
          break;
      }
    }
    function consumeFirstAidKit() {
      if (harvestInventory["First Aid Kit"] && harvestInventory["First Aid Kit"] > 0) {
        removeItem("First Aid Kit", 1);
        let playerName = localStorage.getItem('playerName') || "Guest";
        const safePlayerName = sanitizePlayerName(playerName);
        db.collection('players').doc(safePlayerName).get().then(doc => {
          if (doc.exists) {
            let currentHealth = doc.data().health || 100;
            let newHealth = Math.min(100, currentHealth + 20);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
            alert("You used a First Aid Kit. Your health is now " + newHealth + ".");
          }
        });
      } else {
        alert("You don't have any First Aid Kits to use.");
      }
    }

    if (!localStorage.getItem('playerName')) {
      localStorage.setItem('playerName', 'Guest');
    }
    
    function sanitizePlayerName(name) {
      return name.replace(/[\/\\]/g, '_');
    }
    function checkCharacterExistence() {
      let playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then((doc) => {
        if (doc.exists) {
          document.getElementById('characterCreation').style.display = 'none';
          document.getElementById('mainGame').style.display = 'block';
          updatePlayerStatus();
        } else {
          document.getElementById('characterCreation').style.display = 'block';
          document.getElementById('mainGame').style.display = 'none';
          document.getElementById('displayName').innerText = playerName;
          document.getElementById('charName').value = playerName;
        }
      }).catch((error) => {
        console.error("Error checking character existence:", error);
      });
    }
    function createCharacter() {
      let playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      const charName = document.getElementById('charName').value;
      const charAge = document.getElementById('charAge').value;
      const charGender = document.getElementById('charGender').value;
      const charReason = document.getElementById('charReason').value;
      const charBackstory = document.getElementById('charBackstory').value;
      const charSkills = document.getElementById('charSkills').value;
      const charInventory = document.getElementById('charInventory').value;
      const charAlliances = document.getElementById('charAlliances').value;
      const charRivalries = document.getElementById('charRivalries').value;
      const charReputation = document.getElementById('charReputation').value;
      const roomNumber = document.getElementById('roomNumber').value;
      const playerData = {
        name: charName,
        age: charAge,
        gender: charGender,
        reason: charReason,
        backstory: charBackstory,
        skills: charSkills.split(',').map(s => s.trim()),
        inventory: charInventory.split(',').map(i => i.trim()),
        alliances: charAlliances ? charAlliances.split(',').map(a => a.trim()) : [],
        rivalries: charRivalries ? charRivalries.split(',').map(r => r.trim()) : [],
        reputation: parseInt(charReputation) || 0,
        roomNumber: roomNumber,
        health: 100,
        hunger: 0,
        injury: 0,
        mood: 100,
        conditions: {
          physical: "Healthy",
          mental: "Content",
          activity: "Idle"
        },
        lastUpdated: Date.now()
      };
      db.collection('players').doc(safePlayerName).set(playerData, { merge: true })
        .then(() => {
          localStorage.setItem('characterName', charName);
          document.getElementById('characterCreation').style.display = 'none';
          document.getElementById('mainGame').style.display = 'block';
          updatePlayerStatus();
          db.collection('rooms').doc('Room ' + roomNumber).set({ owner: playerName }, { merge: true });
        })
        .catch((error) => {
          console.error("Error creating character:", error);
        });
    }
    let isEditing = false;
    function enableEdit() {
      isEditing = true;
      updatePlayerStatus();
    }
    function cancelEdit() {
      isEditing = false;
      updatePlayerStatus();
    }
    function togglePlayerStatus() {
      const biodataDiv = document.getElementById('playerStatus');
      biodataDiv.style.display = (biodataDiv.style.display === "none" || biodataDiv.style.display === "") ? "block" : "none";
    }
    function updatePlayerStatus() {
      let playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName)
        .onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            localStorage.setItem('characterName', data.name);
            let statusHTML = `<h3>Biodata</h3>`;
            if (!isEditing) {
              let coreStatsHTML = `<h4>Core Stats</h4>`;
              coreStatsHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
              coreStatsHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
              coreStatsHTML += `<div style="background:#444; border:1px solid #222; width:100%; height:20px; border-radius:5px; margin:5px 0;">
                   <div style="background:#4CAF50; width:${data.health}%; height:100%; border-radius:5px;"></div>
                  </div>`;
              coreStatsHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
              coreStatsHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
              coreStatsHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
              coreStatsHTML += `<p><strong>Room:</strong> ${data.roomNumber ? "Room " + data.roomNumber : "Not set"}</p>`;
              coreStatsHTML += `<p><strong>Reputation:</strong> ${data.reputation || 0}</p>`;
              let narrativeHTML = `<h4>Background</h4>`;
              narrativeHTML += `<p><strong>Reason:</strong> ${data.reason || "N/A"}</p>`;
              narrativeHTML += `<p><strong>Backstory:</strong> ${data.backstory || "N/A"}</p>`;
              narrativeHTML += `<p><strong>Skills:</strong> ${data.skills ? data.skills.join(", ") : "N/A"}</p>`;
              narrativeHTML += `<p><strong>Alliances:</strong> ${data.alliances ? data.alliances.join(", ") : "None"}</p>`;
              narrativeHTML += `<p><strong>Rivalries:</strong> ${data.rivalries ? data.rivalries.join(", ") : "None"}</p>`;
              let inventoryHTML = `<h4>Inventory</h4>`;
              for (let item in harvestInventory) {
                inventoryHTML += `<p>${item}: ${harvestInventory[item]}</p>`;
              }
              if (!inventoryHTML) inventoryHTML += `<p>None</p>`;
              statusHTML += `<div id="coreStats">${coreStatsHTML}</div>`;
              statusHTML += `<div id="narrativeStats" style="display:none;">${narrativeHTML}</div>`;
              statusHTML += `<button id="toggleNarrative" onclick="toggleNarrative()">Show Narrative</button>`;
              statusHTML += `<button onclick="enableEdit()">Edit Biodata</button>`;
              statusHTML += inventoryHTML;
            } else {
              statusHTML += `<h3>Edit Character</h3>`;
              statusHTML += `<div><strong>Core Stats</strong><br>`;
              statusHTML += `<p><strong>Name:</strong> <input type="text" id="editName" value="${data.name}" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
              statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
              statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
              statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
              statusHTML += `<p><strong>Room:</strong> <input type="number" id="editRoomNumber" value="${data.roomNumber || ''}" min="1" max="25" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Reputation:</strong> <input type="number" id="editReputation" value="${data.reputation || 0}" style="height:40px; font-size:16px;" /></p></div>`;
              statusHTML += `<div><strong>Background</strong><br>`;
              statusHTML += `<p><strong>Reason:</strong> <textarea id="editReason" style="height:80px; font-size:16px;">${data.reason}</textarea></p>`;
              statusHTML += `<p><strong>Backstory:</strong> <textarea id="editBackstory" style="height:80px; font-size:16px;">${data.backstory || ""}</textarea></p>`;
              statusHTML += `<p><strong>Skills:</strong> <input type="text" id="editSkills" value="${data.skills ? data.skills.join(", ") : ""}" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Alliances:</strong> <input type="text" id="editAlliances" value="${data.alliances ? data.alliances.join(", ") : ""}" style="height:40px; font-size:16px;" /></p>`;
              statusHTML += `<p><strong>Rivalries:</strong> <input type="text" id="editRivalries" value="${data.rivalries ? data.rivalries.join(", ") : ""}" style="height:40px; font-size:16px;" /></p></div>`;
              statusHTML += `<button onclick="saveBiodata()">Save Changes</button>`;
              statusHTML += `<button onclick="cancelEdit()">Cancel</button>`;
            }
            statusHTML += `<p><strong>Money:</strong> $${localStorage.getItem('money') || 50}</p>`;
            statusHTML += `<p><strong>Seeds:</strong> ${localStorage.getItem('seeds') || 0}</p>`;
            statusHTML += `<p><strong>Mushroom Seeds:</strong> ${localStorage.getItem('mushroomSeeds') || 0}</p>`;
            document.getElementById('playerStatus').innerHTML = statusHTML;
            updateHarvestInventoryUI();
          }
        }, (error) => {
          console.error("Error getting player status:", error);
        });
    }
    function toggleNarrative() {
      const narrativeDiv = document.getElementById('narrativeStats');
      const toggleButton = document.getElementById('toggleNarrative');
      if (narrativeDiv.style.display === "none") {
        narrativeDiv.style.display = "block";
        toggleButton.textContent = "Hide Narrative";
      } else {
        narrativeDiv.style.display = "none";
        toggleButton.textContent = "Show Narrative";
      }
    }
    function saveBiodata() {
      let playerName = localStorage.getItem('playerName');
      if (!playerName) return;
      const safePlayerName = sanitizePlayerName(playerName);
      const updatedData = {
        name: document.getElementById('editName').value,
        roomNumber: document.getElementById('editRoomNumber').value,
        reputation: parseInt(document.getElementById('editReputation').value) || 0,
        reason: document.getElementById('editReason').value,
        backstory: document.getElementById('editBackstory').value,
        skills: document.getElementById('editSkills').value.split(',').map(s => s.trim()),
        alliances: document.getElementById('editAlliances').value.split(',').map(a => a.trim()),
        rivalries: document.getElementById('editRivalries').value.split(',').map(r => r.trim()),
        lastUpdated: Date.now()
      };
      db.collection('players').doc(safePlayerName).set(updatedData, { merge: true })
        .then(() => { isEditing = false; updatePlayerStatus(); })
        .catch(error => {
          console.error("Error saving biodata:", error);
        });
    }

    // Recipe Book Functions (Community Kitchen)
    function renderRecipes() {
      const container = document.getElementById('recipeContainer');
      container.innerHTML = "";
      recipes.forEach((recipe, index) => {
        let ingredientList = "";
        for (let ingredient in recipe.ingredients) {
          ingredientList += `${ingredient}: ${recipe.ingredients[ingredient]}<br>`;
        }
        let benefitsText = "";
        for (let stat in recipe.benefits) {
          benefitsText += `+${recipe.benefits[stat]} ${stat}<br>`;
        }
        let consText = "";
        for (let stat in recipe.cons) {
          consText += `${recipe.cons[stat] >= 0 ? "+" : ""}${recipe.cons[stat]} ${stat}<br>`;
        }
        const recipeHTML = `
          <h4>${recipe.name}</h4>
          <p><strong>Ingredients Required:</strong><br>${ingredientList}</p>
          <p><strong>Benefits:</strong><br>${benefitsText}</p>
          <p><strong>Cons:</strong><br>${consText}</p>
          <button id="createBtn${index}" onclick="createRecipe(${index})">Create ${recipe.name}</button>
        `;
        let recipeDiv = document.createElement('div');
        recipeDiv.className = "recipe";
        recipeDiv.innerHTML = recipeHTML;
        container.appendChild(recipeDiv);
      });
    }
    function createRecipe(index) {
      const recipe = recipes[index];
      for (let ingredient in recipe.ingredients) {
        if (!harvestInventory[ingredient] || harvestInventory[ingredient] < recipe.ingredients[ingredient]) {
          alert(`You are missing enough ${ingredient} to make ${recipe.name}.`);
          return;
        }
      }
      for (let ingredient in recipe.ingredients) {
        removeItem(ingredient, recipe.ingredients[ingredient]);
      }
      document.getElementById("cookingProcess").style.display = "block";
      const btn = document.getElementById(`createBtn${index}`);
      btn.disabled = true;
      btn.textContent = "Creating... (1 min wait)";
      setTimeout(() => {
        if (recipe.benefits.health) updateHealth(recipe.benefits.health);
        if (recipe.benefits.mood) updateMood(recipe.benefits.mood);
        if (recipe.benefits.hunger) updateHunger(recipe.benefits.hunger);
        if (recipe.benefits.reputation) updateReputation(recipe.benefits.reputation);
        if (recipe.cons.health) updateHealth(recipe.cons.health);
        if (recipe.cons.mood) updateMood(recipe.cons.mood);
        if (recipe.cons.hunger) updateHunger(recipe.cons.hunger);
        if (recipe.cons.reputation) updateReputation(recipe.cons.reputation);
        alert(`${recipe.name} has been created and its effects applied!`);
        btn.disabled = false;
        btn.textContent = `Create ${recipe.name}`;
        document.getElementById("cookingProcess").style.display = "none";
        updatePlayerStatus();
      }, 60000);
    }

    // Community Kitchen Chat Functions
    function sendKitchenChat() {
      const msg = document.getElementById('kitchenChatInput').value;
      if (msg.trim() !== "") {
        db.collection("messages").add({
          room: "Community Kitchen",
          sender: localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Guest",
          content: msg,
          chatType: "kitchen",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('kitchenChatInput').value = "";
      }
    }
    function listenForKitchenChat() {
      const chatLog = document.getElementById('kitchenChatLog');
      db.collection("messages")
        .where("room", "==", "Community Kitchen")
        .where("chatType", "==", "kitchen")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
      const kitchenChatInput = document.getElementById('kitchenChatInput');
      if (kitchenChatInput) {
        kitchenChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendKitchenChat();
          }
        });
      }
    });

    // Water Supplies Chat Functions
    function sendLaundryChat() {
      const msg = document.getElementById('laundryChatInput').value;
      if (msg.trim() !== "") {
        db.collection("messages").add({
          room: "Water Supplies",
          sender: localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Guest",
          content: msg,
          chatType: "laundry",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('laundryChatInput').value = "";
      }
    }
    function listenForLaundryChat() {
      const chatLog = document.getElementById('laundryChatLog');
      db.collection("messages")
        .where("room", "==", "Water Supplies")
        .where("chatType", "==", "laundry")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
      const laundryChatInput = document.getElementById('laundryChatInput');
      if (laundryChatInput) {
        laundryChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendLaundryChat();
          }
        });
      }
    });

    function washClothes() {
      alert("You washed your clothes. Your health improves slightly.");
      updateMood(3);
    }

    // Room Interaction & Chat Functions
    function openRoomInteraction(roomName) {
      currentRoom = roomName;
      if (roomName === "Room 5") {
        initSpelunkingGame();
        return;
      }
      db.collection("rooms").doc(roomName).get().then(doc => {
        if (doc.exists) {
          const roomData = doc.data();
          const currentPlayer = localStorage.getItem("playerName") || "Guest";
          if (currentPlayer === roomData.owner) {
            openRoomChat(roomName);
          } else {
            showDoorModal(roomName);
          }
        } else {
          alert("Room " + roomName + " does not exist. Please contact support.");
        }
      }).catch(error => {
        console.error("Error fetching room data:", error);
        alert("Error fetching room data for " + roomName);
      });
    }
    function openRoomChat(roomName) {
      doorChatMode = false;
      document.getElementById('chatRoomTitle').textContent = roomName + " Chat (Inside)";
      document.getElementById('chatLog').innerHTML = "";
      document.getElementById('chatPanel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      listenForMessages(roomName);
      document.getElementById('restContainer').innerHTML = '<button onclick="restInRoom()" id="restButton">Rest (Recover Health)</button>';
    }
    function openDoorChat(roomName) {
      doorChatMode = true;
      document.getElementById('chatRoomTitle').textContent = roomName + " Door Chat (Visitor)";
      document.getElementById('chatLog').innerHTML = "";
      document.getElementById('chatPanel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      document.getElementById('restContainer').innerHTML = '';
      listenForMessages(roomName);
    }
    function listenForMessages(roomName) {
      const chatLog = document.getElementById('chatLog');
      const messagesRef = db.collection("messages");
      messagesRef
        .where("room", "==", roomName)
        .where("chatType", "==", doorChatMode ? "door" : "room")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    function closeChat() {
      document.getElementById('chatPanel').style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';
      currentRoom = "";
    }
    async function sendChatMessage() {
      const msg = document.getElementById('chatInput').value;
      if (msg.trim() !== "") {
        const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Guest";
        try {
          await db.collection("messages").add({
            room: currentRoom,
            sender: characterName,
            content: msg,
            chatType: doorChatMode ? "door" : "room",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById('chatInput').value = "";
        } catch (error) {
          console.error("Error sending message:", error);
        }
      }
    }
    // Door Modal Functions
    function showDoorModal(roomName) {
      currentRoom = roomName;
      document.getElementById('doorTitle').textContent = "You are at the door of " + roomName;
      document.getElementById('doorModal').style.display = 'block';
      document.getElementById('passwordDiv').style.display = 'none';
      document.getElementById('doorPassword').value = "";
    }
    function closeDoorModal() {
      document.getElementById('doorModal').style.display = 'none';
    }
    function showPasswordInput() {
      document.getElementById('passwordDiv').style.display = 'block';
    }
    function verifyPassword() {
      const enteredPassword = document.getElementById('doorPassword').value;
      const correctPassword = roomPasswords[currentRoom];
      if (enteredPassword === correctPassword) {
        alert("Password correct. You now enter the room.");
        closeDoorModal();
        openRoomChat(currentRoom);
      } else {
        alert("Incorrect password. Please try again or choose to knock.");
      }
    }
    function handleKnock() {
      alert("You knocked on the door. Please wait for the ownerâ€™s response.");
      db.collection("rooms").doc(currentRoom).get().then(doc => {
        if (doc.exists) {
          const owner = doc.data().owner;
          const visitor = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Guest";
          db.collection("notifications").add({
            owner: owner,
            room: currentRoom,
            message: `${visitor} knocked on your door of ${currentRoom}.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }).catch(error => {
        console.error("Error sending knock notification:", error);
      });
      closeDoorModal();
      openDoorChat(currentRoom);
    }

    // Power Panel Functions
    let windSpeed = localStorage.getItem('windSpeed') || 50;
    let electricalOutput = false;
    let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
    let garbageLevel = localStorage.getItem('garbageLevel') || 0;
    let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
    let powerStatus = "Unknown";
    function updateWindSpeed() {
      windSpeed = document.getElementById('windSpeedSlider').value;
      document.getElementById('windSpeedValue').textContent = windSpeed;
      localStorage.setItem('windSpeed', windSpeed);
      updateVoltage();
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function toggleElectricalOutput() {
      electricalOutput = !electricalOutput;
      document.getElementById('outputLeverButton').textContent = electricalOutput ? "Output On" : "Output Off";
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function checkWaterPressure() {
      const pressure = Math.floor(Math.random() * 41) + 80;
      alert("Current Water Pressure: " + pressure + " PSI.\nOptimal is above 90 PSI.");
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function checkHeaterLevel() {
      const heater = Math.floor(Math.random() * 41) + 80;
      alert("Current Heater Level: " + heater + ".\nOptimal is above 90.");
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function updateElectricalStatus() {
      if (windSpeed >= 40 && windSpeed <= 70 && electricalOutput) {
        powerStatus = "On";
        document.getElementById('lightStatusDisplay').textContent = "Lights On";
      } else {
        powerStatus = "Off";
        document.getElementById('lightStatusDisplay').textContent = "Lights Off";
      }
      document.getElementById('powerStatusDisplay').textContent = powerStatus;
    }
    function updateVoltage() {
      let factor = electricalOutput ? 1.0 : 0.5;
      let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
      voltage = Math.max(0, voltage);
      const voltageDisplayElement = document.getElementById('voltageDisplay');
      if (voltageDisplayElement) {
        voltageDisplayElement.textContent = voltage.toFixed(1);
      }
      localStorage.setItem('voltage', voltage);
      updateWaterPressure();
    }
    function updateWaterPressure() {
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const efficiency = Math.max(0.5, 1 - (garbageLevel / 200));
      const minVoltageThreshold = 20;
      const basePressure = voltage >= minVoltageThreshold ? voltage * 0.8 : 0;
      const pressure = Math.round(basePressure * efficiency);
      const wpDisplay = document.getElementById('waterPressureDisplay');
      if (wpDisplay) {
        wpDisplay.textContent = pressure;
        wpDisplay.style.color = pressure < 50 ? "red" : "#fff";
      }
    }
    function simulatePowerEvent() {
      if (Date.now() - lastInteractionTime > 60000) {
        const malfunctionType = Math.floor(Math.random() * 5);
        let malfunctionMessage = "";
        switch(malfunctionType) {
          case 0:
            malfunctionMessage = "Wind calibration error: Re-adjust the wind speed slider to bring it into the optimal range (40â€“70).";
            break;
          case 1:
            malfunctionMessage = "Electrical output fluctuation: Toggle the electrical output lever to stabilize the system.";
            break;
          case 2:
            malfunctionMessage = "Water pressure drop: Press 'Check Water' to review and fix water pressure issues.";
            break;
          case 3:
            malfunctionMessage = "Heater level fluctuation: Press 'Check Heater' to ensure heater levels are optimal.";
            break;
          case 4:
            malfunctionMessage = "Sensor error: Re-check all controls (wind speed, output lever, water, heater) to recalibrate the system.";
            break;
        }
        alert("Malfunction Detected!\n" + malfunctionMessage);
        let playerEmail = localStorage.getItem('playerName') || "Guest";
        const safePlayerName = sanitizePlayerName(playerEmail);
        db.collection('players').doc(safePlayerName).get().then(doc => {
          if (doc.exists) {
            let currentHealth = doc.data().health || 100;
            let newHealth = Math.max(0, currentHealth - 5);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
            if (newHealth === 0) {
              playerDied();
            }
          }
        });
        updateLastInteraction();
        updateWaterPressure();
      }
    }
    function updateGarbageDisplay() {
      document.getElementById('garbageDisplay').textContent = garbageLevel;
      const now = Date.now();
      const elapsedMinutes = Math.floor((now - lastGarbageUpdate) / 60000);
      if (elapsedMinutes > 0) {
        garbageLevel = Math.min(100, Number(garbageLevel) + elapsedMinutes);
        lastGarbageUpdate = now;
        localStorage.setItem('garbageLevel', garbageLevel);
        localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
        document.getElementById('garbageDisplay').textContent = garbageLevel;
        const logDiv = document.getElementById('garbageLog');
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `<p>[${timestamp}] Garbage level updated to ${garbageLevel}</p>`;
        logDiv.innerHTML = logMessage + logDiv.innerHTML;
        if (garbageLevel > 80) {
          alert("High garbage levels detected! The community is getting sick.");
        }
      }
    }
    function logPowerMessage(message) {
      const logDiv = document.getElementById('minigameLog');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    function toggleInstructions() {
      const instrDiv = document.getElementById("instructions");
      instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
    }
    function updateLastInteraction() {
      lastInteractionTime = Date.now();
      localStorage.setItem('lastInteractionTime', lastInteractionTime);
    }
    function simulateHealthDecline() {
      if (garbageLevel > 80) {
        let playerEmail = localStorage.getItem('playerName') || "Guest";
        const safePlayerName = sanitizePlayerName(playerEmail);
        db.collection('players').doc(safePlayerName).get().then((doc) => {
          if (doc.exists) {
            let data = doc.data();
            let currentHealth = data.health || 100;
            let extraDecline = 0;
            if (data.hunger > 70) extraDecline += 1;
            if (data.mood < 30) extraDecline += 1;
            let newHealth = Math.max(0, currentHealth - 1 - extraDecline);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
            if (newHealth === 0) {
              playerDied();
            }
          }
        }).catch((error) => {
          console.error("Error decreasing health: ", error);
        });
      }
    }
    function playerDied() {
      alert("Your health has reached zero. You have died.");
      clearGameState();
      window.location.href = "index.html";
    }

    // Rest Functionality: 1 minute total (using 12 iterations of 5 seconds)
    function restInRoom() {
      let restButton = document.getElementById("restButton");
      if (!restButton) return;
      restButton.disabled = true;
      restButton.textContent = "Resting...";
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      let iterations = 12;
      let interval = setInterval(() => {
        iterations--;
        db.collection('players').doc(safePlayerName).get().then(doc => {
          if (doc.exists) {
            let currentHealth = doc.data().health || 100;
            let newHealth = Math.min(100, currentHealth + 2);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
          }
        });
        if (iterations <= 0) {
          clearInterval(interval);
          restButton.disabled = false;
          restButton.textContent = "Rest (Recover Health)";
          alert("Rest complete! Your health has improved.");
        }
      }, 5000);
    }

    // Single toggleMusicPlayer() function (duplicate removed and updated)
    function toggleMusicPlayer() {
      const container = document.getElementById("musicPlayerContainer");
      console.log("Toggle Music Player invoked. Current container.left:", container.style.left);
      if (container.style.left === "-9999px" || container.style.left === "") {
        container.style.left = "0";
        console.log("Music player shown");
      } else {
        container.style.left = "-9999px";
        console.log("Music player hidden");
      }
    }

    function updateEnvironmentStatus() {
      const envDiv = document.getElementById('envStatus');
      const currentWind = windSpeed;
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const efficiency = Math.max(0.5, 1 - (garbageLevel / 200));
      const minVoltageThreshold = 20;
      const basePressure = voltage >= minVoltageThreshold ? voltage * 0.8 : 0;
      const waterPressure = Math.round(basePressure * efficiency);
      const currentGarbage = garbageLevel;
      envDiv.innerHTML = `Wind Speed: ${currentWind} | Voltage: ${voltage}V | Water Pressure: ${waterPressure} PSI | Garbage Level: ${currentGarbage}/100`;
    }

    // Community Garden Functions: Render two sections (Soil and Tree Stump)
    function renderGardenSlots() {
      const container = document.getElementById("plantSlots");
      container.innerHTML = "";
      container.innerHTML += "<h4>Soil (Seeds)</h4>";
      soilSlots.forEach(slot => {
        let div = document.createElement("div");
        div.className = "slot";
        if (!slot.type) {
          div.innerHTML = `Slot ${slot.slot}: <span class="status">Empty</span> <button onclick="openPlantSelection(${slot.slot}, 'soil')">Plant Seed</button>`;
        } else {
          let status = slot.watered ? "Watered, growing..." : "Planted: " + slot.type + " (needs water)";
          div.innerHTML = `Slot ${slot.slot}: <span class="status">${status}</span>`;
          if (!slot.watered) {
            div.innerHTML += ` <button onclick="waterPlant(${slot.slot}, 'soil')">Water Plant</button>`;
          }
        }
        container.appendChild(div);
      });
      container.innerHTML += "<h4>Tree Stump (Mushrooms)</h4>";
      stumpSlots.forEach(slot => {
        let div = document.createElement("div");
        div.className = "slot";
        if (!slot.type) {
          div.innerHTML = `Slot ${slot.slot}: <span class="status">Empty</span> <button onclick="openPlantSelection(${slot.slot}, 'stump')">Plant Mushroom</button>`;
        } else {
          let status = slot.watered ? "Watered, growing..." : "Planted: " + slot.type + " (needs water)";
          div.innerHTML = `Slot ${slot.slot}: <span class="status">${status}</span>`;
          if (!slot.watered) {
            div.innerHTML += ` <button onclick="waterPlant(${slot.slot}, 'stump')">Water Plant</button>`;
          }
        }
        container.appendChild(div);
      });
    }
    function openPlantSelection(slotNum, category) {
      let available = (category === 'soil') ? seedTypes : mushroomTypes;
      let inventoryOptions = available.filter(type => harvestInventory[type] && harvestInventory[type] > 0);
      if (inventoryOptions.length === 0) {
        alert("You do not have any " + (category === 'soil' ? "seeds" : "mushrooms") + " in your inventory.");
        return;
      }
      let selectedType = inventoryOptions[0];
      removeItem(selectedType, 1);
      if (category === 'soil') {
        soilSlots[slotNum - 1] = { slot: slotNum, type: selectedType, watered: false, timer: null };
      } else {
        stumpSlots[slotNum - 1] = { slot: slotNum, type: selectedType, watered: false, timer: null };
      }
      renderGardenSlots();
    }
    function waterPlant(slotNum, category) {
      if (waterInventory < 1) {
        alert("No water available. Please collect water.");
        return;
      }
      waterInventory--;
      localStorage.setItem('water', waterInventory);
      document.getElementById('waterInventoryDisplay').textContent = waterInventory;
      let slotArray = (category === 'soil') ? soilSlots : stumpSlots;
      slotArray[slotNum - 1].watered = true;
      renderGardenSlots();
      slotArray[slotNum - 1].timer = setTimeout(() => {
        const matureType = slotArray[slotNum - 1].type;
        alert("Your " + matureType + " has matured!");
        addItem(matureType, 1);
        slotArray[slotNum - 1] = { slot: slotNum, type: null, watered: false, timer: null };
        renderGardenSlots();
      }, 300000);
    }

    // Grocery Stand Functions
    function generateGroceryItems() {
      let seedContainer = document.getElementById("seedList");
      seedContainer.innerHTML = "";
      seedTypes.forEach(seed => {
        let div = document.createElement("div");
        div.className = "grocery-item";
        div.innerHTML = `<p><strong>${seed}</strong> - $2<br><em>${seed} is essential for growth.</em></p>
                         <button onclick="buyItem('${seed}')">Buy ${seed}</button>`;
        seedContainer.appendChild(div);
      });
      let mushroomContainer = document.getElementById("mushroomList");
      mushroomContainer.innerHTML = "";
      mushroomTypes.forEach(mushroom => {
        let div = document.createElement("div");
        div.className = "grocery-item";
        div.innerHTML = `<p><strong>${mushroom}</strong> - $2<br><em>${mushroom} adds flavor and nutrients.</em></p>
                         <button onclick="buyItem('${mushroom}')">Buy ${mushroom}</button>`;
        mushroomContainer.appendChild(div);
      });
      let healthContainer = document.getElementById("healthItemList");
      if (!healthContainer) {
        healthContainer = document.createElement("div");
        healthContainer.id = "healthItemList";
        healthContainer.innerHTML = `<h4>Health Items</h4>`;
        document.getElementById("grocery-panel").appendChild(healthContainer);
      } else {
        healthContainer.innerHTML = `<h4>Health Items</h4>`;
      }
      let div = document.createElement("div");
      div.className = "grocery-item";
      div.innerHTML = `<p><strong>First Aid Kit</strong> - $8<br><em>Restores 20 health.</em></p>
                       <button onclick="buyItem('First Aid Kit')">Buy First Aid Kit</button>`;
      healthContainer.appendChild(div);
    }
    function sellHarvest() {
      const checkboxes = document.querySelectorAll('.sell-checkbox:checked');
      if (!checkboxes.length) {
        alert("Select at least one item to sell.");
        return;
      }
      const sellPrices = { 'Food Staples': 5, 'Lubricant Oil': 2.5, 'Alcohol': 1.5, 'Cigarettes': 2 };
      checkboxes.forEach(cb => {
        const item = cb.getAttribute('data-item');
        const qty = harvestInventory[item];
        const price = sellPrices[item] || 1;
        let money = parseInt(localStorage.getItem('money')) || 50;
        money += price * qty;
        localStorage.setItem('money', money);
        removeItem(item, qty);
        alert(`Sold ${qty} ${item}(s) for $${price * qty}.`);
      });
      updateSellInventory();
      updatePlayerStatus();
    }
    function toggleBuySell(mode) {
      if (mode === 'buy') {
        document.getElementById('buySection').style.display = 'grid';
        document.getElementById('sellSection').style.display = 'none';
      } else {
        document.getElementById('buySection').style.display = 'none';
        document.getElementById('sellSection').style.display = 'block';
        updateSellInventory();
      }
    }
    function updateSellInventory() {
      const sellDiv = document.getElementById('sellInventory');
      sellDiv.innerHTML = "";
      for (let item in harvestInventory) {
        const qty = harvestInventory[item];
        if (qty > 0) {
          let div = document.createElement('div');
          div.className = "sell-item";
          div.innerHTML = `<label>
                            <input type="checkbox" class="sell-checkbox" data-item="${item}" data-qty="${qty}">
                            ${item} - Quantity: ${qty}
                           </label>`;
          sellDiv.appendChild(div);
        }
      }
      if (!sellDiv.innerHTML) sellDiv.innerHTML = "<p>You have no items to sell.</p>";
    }
    function openTab(evt, tabName) {
      const tabs = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabs.length; i++) { tabs[i].style.display = "none"; }
      const btns = document.getElementsByClassName("tab-button");
      for (let i = 0; i < btns.length; i++) { btns[i].classList.remove("active"); }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }

    // Community Kitchen Tab Functions (Cookbook and Chat)
    function openKitchenTab(evt, tabName) {
      const tabcontents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontents.length; i++) {
        tabcontents[i].classList.remove("active");
      }
      const tabbuttons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
      }
      document.getElementById(tabName).classList.add("active");
      if (evt) {
        evt.currentTarget.classList.add("active");
      }
      if (tabName === 'cookbookTab') {
        renderRecipes();
      }
    }

    // Stub functions for missing features
    function collectWater() {
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const efficiency = Math.max(0.5, 1 - (garbageLevel / 200));
      const minVoltageThreshold = 20;
      const basePressure = voltage >= minVoltageThreshold ? voltage * 0.8 : 0;
      const pressure = Math.round(basePressure * efficiency);
      const waterCollected = Math.floor(pressure / 10) + 5;
      waterInventory += waterCollected;
      localStorage.setItem('water', waterInventory);
      const waterInvDisplay = document.getElementById('waterInventoryDisplay');
      if (waterInvDisplay) {
        waterInvDisplay.textContent = waterInventory;
      }
      alert("You collected " + waterCollected + " units of water!");
    }
    function harvestProduce() {
      alert("harvestProduce() function is not implemented yet.");
    }

    // Single window.onload initialization
    window.onload = function() {
      var roomSelect = document.getElementById('roomNumber');
      if (roomSelect) {
        for (let i = 1; i <= 25; i++) {
          let option = document.createElement('option');
          option.value = i;
          option.textContent = "Room " + i;
          roomSelect.appendChild(option);
        }
      }
      var gridContainer = document.querySelector(".grid");
      if (gridContainer) {
        const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
        rooms.forEach(function(room) {
          let btn = document.createElement("button");
          btn.textContent = "Room " + room;
          btn.onclick = function() { openRoomInteraction("Room " + room); };
          gridContainer.appendChild(btn);
        });
      }
      var plantSlotsDiv = document.getElementById("plantSlots");
      if (plantSlotsDiv) {
        renderGardenSlots();
      }
      document.getElementById('windSpeedSlider').value = windSpeed;
      document.getElementById('windSpeedValue').textContent = windSpeed;
      updateVoltage();
      updateGarbageDisplay();
      updateEnvironmentStatus();
      checkCharacterExistence();
      harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
      waterInventory = parseInt(localStorage.getItem('water')) || 0;
      generateGroceryItems();
      setInterval(simulatePowerEvent, 60000);
      setInterval(updateGarbageDisplay, 60000);
      setInterval(updateVoltage, 5000);
      setInterval(simulateHealthDecline, 60000);
      setInterval(updateEnvironmentStatus, 5000);
      listenForKitchenChat();
      listenForLaundryChat();
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendChatMessage();
          }
        });
      }
      const kitchenChatInput = document.getElementById('kitchenChatInput');
      if (kitchenChatInput) {
        kitchenChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendKitchenChat();
          }
        });
      }
      const laundryChatInput = document.getElementById('laundryChatInput');
      if (laundryChatInput) {
        laundryChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendLaundryChat();
          }
        });
      }
    };
  </script>
</body>
</html>
