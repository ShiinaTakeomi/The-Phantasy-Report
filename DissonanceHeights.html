<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    /* Set body background with full image */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
      position: relative;
    }
    /* Apply full-page dark overlay using a pseudo-element */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5));
      z-index: -1;
      pointer-events: none;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    /* Shared container style */
    .container, .panel, #characterCreation, .modal {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    /* Grid of Rooms */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* --- Absolute Positioned Buttons (restored) --- */
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    .exit-button {
      position: absolute;
      left: 0;
      top: 530px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    /* --- End Absolute Positioned Buttons --- */

    /* Navigation Links – these link to the modular pages */
    .nav-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      max-width: 800px;
    }
    .nav-links a {
      text-decoration: none;
    }
    .nav-links button {
      padding: 10px 20px;
      font-size: 16px;
      border: 2px solid #fff;
      border-radius: 4px;
      background-color: #5DADE2;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .nav-links button:hover {
      background-color: #4a90e2;
    }
    /* Grid of Rooms (if you want some interactive room buttons in the hub) */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Chat Panel (if you need in-hub chat functionality) */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Player Biodata Panel */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Door Modal (for knocking and PIN system) */
    .modal, #doorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea,
    #doorModal button, #doorModal input {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    /* Environmental Status Panel */
    #envStatus {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
      margin: 10px auto;
      max-width: 600px;
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="wrapper">
    <!-- Hidden YouTube Player for Ambient Music -->
    <iframe id="bgMusic" width="0" height="0" src="https://www.youtube.com/embed/gSwi1Tk1gV8?autoplay=1&loop=1&playlist=gSwi1Tk1gV8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position:absolute; left:-9999px;"></iframe>
    <!-- Toggle Music Player Button -->
    <div style="text-align:center; margin-top:10px;">
      <button onclick="toggleMusicPlayer()">Toggle Music Player</button>
    </div>
    
    <!-- Character Creation Section -->
    <div id="characterCreation">
      <h3>Create Your Character</h3>
      <p>Welcome, <span id="displayName"></span>!</p>
      <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
        <input type="text" id="charName" placeholder="Name" required>
        <input type="number" id="charAge" placeholder="Age" required>
        <select id="charGender" required>
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
        <textarea id="charBackstory" placeholder="Backstory" required></textarea>
        <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
        <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
        <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
        <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
        <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
        <select id="roomNumber" required>
          <option value="">Select Room Number</option>
        </select>
        <button type="submit">Create Character</button>
      </form>
    </div>
    
    <!-- Main Game Section -->
    <div id="mainGame" style="display: none;">
      <!-- Notification Panel -->
      <div id="notificationPanel"></div>
      <!-- Main Screen -->
      <div id="main-screen">
        <div class="container">
          <!-- Absolute Positioned Buttons -->
          <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
          <button class="exit-button" onclick="signOutUser()">Exit</button>
          <script>
            function signOutUser() {
              firebase.auth().signOut().then(() => {
                clearGameState();
                window.location.href = 'index.html';
              }).catch((error) => {
                console.error("Error signing out: ", error);
              });
            }
          </script>
          <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
          <!-- Navigation Links to Modular Pages -->
          <div class="nav-links">
            <a href="community-kitchen.html"><button>Community Kitchen</button></a>
            <a href="groceries-stand.html"><button>Groceries Stand</button></a>
            <a href="water-supplies.html"><button>Water Supplies (Laundry)</button></a>
            <a href="power-room.html"><button>Power Room</button></a>
            <a href="room5.html"><button>Room 5</button></a>
            <a href="room14.html"><button>Room 14</button></a>
          </div>
          <!-- Optional: Grid of Room Buttons for additional interactions -->
          <div class="grid">
            <!-- Room buttons generated dynamically -->
          </div>
        </div>
        <div class="facilities">
          <!-- Quick access for biodata -->
          <button onclick="togglePlayerStatus()">Biodata</button>
        </div>
        <!-- Environmental Status Panel -->
        <div id="envStatus"></div>
        <!-- Biodata Panel -->
        <div id="playerStatus">
          <!-- Biodata dynamically updated -->
        </div>
      </div>
      
      <!-- Chat Modal (if inline room chat is needed) -->
      <div id="chatPanel">
        <h2 id="chatRoomTitle"></h2>
        <div id="chatLog"></div>
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button onclick="sendChatMessage()">Send</button>
        <button onclick="closeChat()">Close Chat</button>
        <div id="restContainer" style="margin-top:10px;"></div>
      </div>
    </div>
    
    <!-- Door Modal (Knocking & PIN system) -->
    <div id="doorModal">
      <h2 id="doorTitle">Door Interaction</h2>
      <div id="doorOptions">
        <button onclick="handleKnock()">Knock</button>
        <button onclick="showPasswordInput()">Enter Password</button>
      </div>
      <div id="passwordDiv" style="display:none;">
        <input type="text" id="doorPassword" placeholder="Enter 4-digit password">
        <button onclick="verifyPassword()">Submit Password</button>
      </div>
      <button onclick="closeDoorModal()">Cancel</button>
    </div>
    
    <!-- Spelunking Game Container (for Room 5) -->
    <div id="spelunkingGame">
      <canvas id="spelunkingCanvas"></canvas>
      <button id="exitSpelunking" onclick="exitSpelunkingGame()">Exit Cave</button>
    </div>
  </div>

  <script>
    // Store original background settings
    const originalBackground = "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed";

    // Firebase Initialization & Config
    const firebaseConfig = {
      apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
      authDomain: "thephantasyreport.firebaseapp.com",
      projectId: "thephantasyreport",
      storageBucket: "thephantasyreport.firebasestorage.app",
      messagingSenderId: "887983841070",
      appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
      measurementId: "G-9MS36H0YV4"
    };
    firebase.initializeApp(firebaseConfig);
    // Authentication functions removed per requirement.
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Room Password Mapping
    const roomPasswords = {
      "Room 1": "0001",
      "Room 2": "1414",
      "Room 3": "0003",
      "Room 4": "0004",
      "Room 5": "0005",
      "Room 6": "0006",
      "Room 7": "0007",
      "Room 8": "0008",
      "Room 9": "0009",
      "Room 10": "0010",
      "Room 11": "0011",
      "Room 12": "0715",
      "Room 13": "0013",
      "Room 14": "0014",
      "Room 15": "0015",
      "Room 16": "0016",
      "Room 17": "0017",
      "Room 18": "0018",
      "Room 19": "0019",
      "Room 20": "0020",
      "Room 21": "0021",
      "Room 22": "0022",
      "Room 23": "0023",
      "Room 24": "0024",
      "Room 25": "0025"
    };

    // Global variables
    let currentRoom = "";
    let doorChatMode = false;
    let harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
    let waterInventory = parseInt(localStorage.getItem('water')) || 0;

    // Community Garden Arrays (Soil and Tree Stump)
    let soilSlots = Array.from({length: 5}, (_, i) => ({
      slot: i + 1,
      type: null,
      watered: false,
      timer: null
    }));
    let stumpSlots = Array.from({length: 5}, (_, i) => ({
      slot: i + 1,
      type: null,
      watered: false,
      timer: null
    }));

    // Seeds and Mushrooms (exactly 5 each)
    const seedTypes = [
      "Sunflower Seed", "Pumpkin Seed", "Corn Seed", "Wheat Seed", "Rice Seed"
    ];
    const mushroomTypes = [
      "Button Mushroom", "Portobello Mushroom", "Shiitake Mushroom", "Oyster Mushroom", "Enoki Mushroom"
    ];

    // Cookie Recipes (exactly 4 types)
    const recipes = [
      {
        name: "Vitality Cookie",
        ingredients: { "Flour": 2, "Egg": 1, "Butter": 1, "Sugar": 1 },
        benefits: { health: 20 },
        cons: { hunger: 5 }
      },
      {
        name: "Cheer Cookie",
        ingredients: { "Flour": 1, "Egg": 1, "Butter": 1, "Sugar": 2 },
        benefits: { mood: 20 },
        cons: { health: -5 }
      },
      {
        name: "Sustenance Cookie",
        ingredients: { "Flour": 1, "Egg": 2, "Sugar": 1 },
        benefits: { hunger: -20 },
        cons: { mood: -5 }
      },
      {
        name: "Ambition Cookie",
        ingredients: { "Flour": 2, "Egg": 1, "Butter": 1, "Sugar": 2 },
        benefits: { reputation: 10 },
        cons: { health: -10 }
      }
    ];

    // Helper Functions: Update Mood, Hunger, Health, Reputation
    function updateMood(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentMood = doc.data().mood || 100;
          let newMood = Math.max(0, currentMood + delta);
          db.collection('players').doc(safePlayerName).set({ mood: newMood, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
    function updateHunger(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentHunger = doc.data().hunger || 0;
          let newHunger = Math.max(0, currentHunger + delta);
          db.collection('players').doc(safePlayerName).set({ hunger: newHunger, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
    function updateHealth(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentHealth = doc.data().health || 100;
          let newHealth = Math.min(100, Math.max(0, currentHealth + delta));
          db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }
    function updateReputation(delta) {
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      db.collection('players').doc(safePlayerName).get().then(doc => {
        if (doc.exists) {
          let currentRep = doc.data().reputation || 0;
          let newRep = currentRep + delta;
          db.collection('players').doc(safePlayerName).set({ reputation: newRep, lastUpdated: Date.now() }, { merge: true });
        }
      });
    }

    // Inventory Functions
    function addItem(item, qty = 1) {
      harvestInventory[item] = (harvestInventory[item] || 0) + qty;
      localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
      updateHarvestInventoryUI();
    }
    function removeItem(item, qty = 1) {
      if (harvestInventory[item]) {
        harvestInventory[item] = Math.max(0, harvestInventory[item] - qty);
        if (harvestInventory[item] === 0) delete harvestInventory[item];
      }
      localStorage.setItem('harvestInventory', JSON.stringify(harvestInventory));
      updateHarvestInventoryUI();
    }
    function updateHarvestInventoryUI() {
      const invDiv = document.getElementById('harvestInventory');
      if (invDiv) {
        let html = "";
        for (let item in harvestInventory) {
          html += `<p>${item}: ${harvestInventory[item]}</p>`;
        }
        invDiv.innerHTML = html || "<p>None</p>";
      }
    }

    // In-App Notification Listener
    function listenForNotifications() {
      let playerName = localStorage.getItem('playerName') || "Guest";
      if (!playerName) return;
      db.collection("notifications")
        .where("owner", "==", playerName)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          let notifications = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            notifications += `<p>${data.message}</p>`;
          });
          const panel = document.getElementById("notificationPanel");
          if (panel) {
            if (notifications) {
              panel.innerHTML = notifications;
              panel.style.display = "block";
            } else {
              panel.style.display = "none";
            }
          }
        });
    }

    // Utility: Clear Game State
    function clearGameState() {
      const keys = ['playerName', 'characterName', 'money', 'seeds', 'mushroomSeeds', 'windSpeed', 'lastInteractionTime', 'garbageLevel', 'lastGarbageUpdate', 'harvestInventory', 'water'];
      keys.forEach(key => localStorage.removeItem(key));
    }

    // Panel Navigation Functions (modified to redirect to separate pages)
    function showGarbagePanel() {
      window.location.href = "garbage-chute.html";
    }
    function openGardenPanel() {
      window.location.href = "community-garden.html";
    }
    function openKitchenPanel() {
      window.location.href = "community-kitchen.html";
    }
    function openGroceryPanel() {
      window.location.href = "groceries-stand.html";
    }
    function openWaterPanel() {
      window.location.href = "water-supplies.html";
    }
    function showPowerPanel() {
      window.location.href = "power-room.html";
    }

    // Room Interaction Functions
    function openRoomInteraction(roomName) {
      currentRoom = roomName;
      if (roomName === "Room 5") {
        window.location.href = "room5.html";
        return;
      }
      if (roomName === "Room 14") {
        window.location.href = "room14.html";
        return;
      }
      db.collection("rooms").doc(roomName).get().then(doc => {
        if (doc.exists) {
          const roomData = doc.data();
          const currentPlayer = localStorage.getItem("playerName") || "Guest";
          if (currentPlayer === roomData.owner) {
            openRoomChat(roomName);
          } else {
            showDoorModal(roomName);
          }
        } else {
          alert("Room " + roomName + " does not exist. Please contact support.");
        }
      }).catch(error => {
        console.error("Error fetching room data:", error);
        alert("Error fetching room data for " + roomName);
      });
    }
    function openRoomChat(roomName) {
      doorChatMode = false;
      document.getElementById('chatRoomTitle').textContent = roomName + " Chat (Inside)";
      document.getElementById('chatLog').innerHTML = "";
      document.getElementById('chatPanel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      listenForMessages(roomName);
      document.getElementById('restContainer').innerHTML = '<button onclick="restInRoom()" id="restButton">Rest (Recover Health)</button>';
    }
    function openDoorChat(roomName) {
      doorChatMode = true;
      document.getElementById('chatRoomTitle').textContent = roomName + " Door Chat (Visitor)";
      document.getElementById('chatLog').innerHTML = "";
      document.getElementById('chatPanel').style.display = 'block';
      document.getElementById('main-screen').style.display = 'none';
      document.getElementById('restContainer').innerHTML = '';
      listenForMessages(roomName);
    }
    function listenForMessages(roomName) {
      const chatLog = document.getElementById('chatLog');
      const messagesRef = db.collection("messages");
      messagesRef
        .where("room", "==", roomName)
        .where("chatType", "==", doorChatMode ? "door" : "room")
        .orderBy("timestamp")
        .onSnapshot((querySnapshot) => {
          chatLog.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const message = doc.data();
            const p = document.createElement('p');
            p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            chatLog.appendChild(p);
          });
          chatLog.scrollTop = chatLog.scrollHeight;
        });
    }
    function closeChat() {
      document.getElementById('chatPanel').style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';
      currentRoom = "";
    }
    async function sendChatMessage() {
      const msg = document.getElementById('chatInput').value;
      if (msg.trim() !== "") {
        const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Guest";
        try {
          await db.collection("messages").add({
            room: currentRoom,
            sender: characterName,
            content: msg,
            chatType: doorChatMode ? "door" : "room",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById('chatInput').value = "";
        } catch (error) {
          console.error("Error sending message:", error);
        }
      }
    }

    // Door Modal Functions
    function showDoorModal(roomName) {
      currentRoom = roomName;
      document.getElementById('doorTitle').textContent = "You are at the door of " + roomName;
      document.getElementById('doorModal').style.display = 'block';
      document.getElementById('passwordDiv').style.display = 'none';
      document.getElementById('doorPassword').value = "";
    }
    function closeDoorModal() {
      document.getElementById('doorModal').style.display = 'none';
    }
    function showPasswordInput() {
      document.getElementById('passwordDiv').style.display = 'block';
    }
    function verifyPassword() {
      const enteredPassword = document.getElementById('doorPassword').value;
      const correctPassword = roomPasswords[currentRoom];
      if (enteredPassword === correctPassword) {
        alert("Password correct. You now enter the room.");
        closeDoorModal();
        openRoomChat(currentRoom);
      } else {
        alert("Incorrect password. Please try again or choose to knock.");
      }
    }
    function handleKnock() {
      alert("You knocked on the door. Please wait for the owner’s response.");
      db.collection("rooms").doc(currentRoom).get().then(doc => {
        if (doc.exists) {
          const owner = doc.data().owner;
          const visitor = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Guest";
          db.collection("notifications").add({
            owner: owner,
            room: currentRoom,
            message: `${visitor} knocked on your door of ${currentRoom}.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }).catch(error => {
        console.error("Error sending knock notification:", error);
      });
      closeDoorModal();
      openDoorChat(currentRoom);
    }

    // Power Panel Functions
    let windSpeed = localStorage.getItem('windSpeed') || 50;
    let electricalOutput = false;
    let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
    let garbageLevel = localStorage.getItem('garbageLevel') || 0;
    let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
    let powerStatus = "Unknown";
    function updateWindSpeed() {
      windSpeed = document.getElementById('windSpeedSlider').value;
      document.getElementById('windSpeedValue').textContent = windSpeed;
      localStorage.setItem('windSpeed', windSpeed);
      updateVoltage();
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function toggleElectricalOutput() {
      electricalOutput = !electricalOutput;
      document.getElementById('outputLeverButton').textContent = electricalOutput ? "Output On" : "Output Off";
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function checkWaterPressure() {
      const pressure = Math.floor(Math.random() * 41) + 80;
      alert("Current Water Pressure: " + pressure + " PSI.\nOptimal is above 90 PSI.");
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function checkHeaterLevel() {
      const heater = Math.floor(Math.random() * 41) + 80;
      alert("Current Heater Level: " + heater + ".\nOptimal is above 90.");
      updateLastInteraction();
      updateElectricalStatus();
      updateWaterPressure();
    }
    function updateElectricalStatus() {
      if (windSpeed >= 40 && windSpeed <= 70 && electricalOutput) {
        powerStatus = "On";
        document.getElementById('lightStatusDisplay').textContent = "Lights On";
      } else {
        powerStatus = "Off";
        document.getElementById('lightStatusDisplay').textContent = "Lights Off";
      }
      document.getElementById('powerStatusDisplay').textContent = powerStatus;
    }
    function updateVoltage() {
      let factor = electricalOutput ? 1.0 : 0.5;
      let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
      voltage = Math.max(0, voltage);
      const voltageDisplayElement = document.getElementById('voltageDisplay');
      if (voltageDisplayElement) {
        voltageDisplayElement.textContent = voltage.toFixed(1);
      }
      localStorage.setItem('voltage', voltage);
      updateWaterPressure();
    }
    function updateWaterPressure() {
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const efficiency = Math.max(0.5, 1 - (garbageLevel / 200));
      const minVoltageThreshold = 20;
      const basePressure = voltage >= minVoltageThreshold ? voltage * 0.8 : 0;
      const pressure = Math.round(basePressure * efficiency);
      const wpDisplay = document.getElementById('waterPressureDisplay');
      if (wpDisplay) {
        wpDisplay.textContent = pressure;
        wpDisplay.style.color = pressure < 50 ? "red" : "#fff";
      }
    }
    function simulatePowerEvent() {
      if (Date.now() - lastInteractionTime > 60000) {
        const malfunctionType = Math.floor(Math.random() * 5);
        let malfunctionMessage = "";
        switch(malfunctionType) {
          case 0:
            malfunctionMessage = "Wind calibration error: Re-adjust the wind speed slider to bring it into the optimal range (40–70).";
            break;
          case 1:
            malfunctionMessage = "Electrical output fluctuation: Toggle the electrical output lever to stabilize the system.";
            break;
          case 2:
            malfunctionMessage = "Water pressure drop: Press 'Check Water' to review and fix water pressure issues.";
            break;
          case 3:
            malfunctionMessage = "Heater level fluctuation: Press 'Check Heater' to ensure heater levels are optimal.";
            break;
          case 4:
            malfunctionMessage = "Sensor error: Re-check all controls (wind speed, output lever, water, heater) to recalibrate the system.";
            break;
        }
        alert("Malfunction Detected!\n" + malfunctionMessage);
        let playerEmail = localStorage.getItem('playerName') || "Guest";
        const safePlayerName = sanitizePlayerName(playerEmail);
        db.collection('players').doc(safePlayerName).get().then(doc => {
          if (doc.exists) {
            let currentHealth = doc.data().health || 100;
            let newHealth = Math.max(0, currentHealth - 5);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
            if (newHealth === 0) {
              playerDied();
            }
          }
        });
        updateLastInteraction();
        updateWaterPressure();
      }
    }
    function updateGarbageDisplay() {
      document.getElementById('garbageDisplay').textContent = garbageLevel;
      const now = Date.now();
      const elapsedMinutes = Math.floor((now - lastGarbageUpdate) / 60000);
      if (elapsedMinutes > 0) {
        garbageLevel = Math.min(100, Number(garbageLevel) + elapsedMinutes);
        lastGarbageUpdate = now;
        localStorage.setItem('garbageLevel', garbageLevel);
        localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
        document.getElementById('garbageDisplay').textContent = garbageLevel;
        const logDiv = document.getElementById('garbageLog');
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `<p>[${timestamp}] Garbage level updated to ${garbageLevel}</p>`;
        logDiv.innerHTML = logMessage + logDiv.innerHTML;
        if (garbageLevel > 80) {
          alert("High garbage levels detected! The community is getting sick.");
        }
      }
    }
    function logPowerMessage(message) {
      const logDiv = document.getElementById('minigameLog');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    function toggleInstructions() {
      const instrDiv = document.getElementById("instructions");
      instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
    }
    function updateLastInteraction() {
      lastInteractionTime = Date.now();
      localStorage.setItem('lastInteractionTime', lastInteractionTime);
    }
    function simulateHealthDecline() {
      if (garbageLevel > 80) {
        let playerEmail = localStorage.getItem('playerName') || "Guest";
        const safePlayerName = sanitizePlayerName(playerEmail);
        db.collection('players').doc(safePlayerName).get().then((doc) => {
          if (doc.exists) {
            let data = doc.data();
            let currentHealth = data.health || 100;
            let extraDecline = 0;
            if (data.hunger > 70) extraDecline += 1;
            if (data.mood < 30) extraDecline += 1;
            let newHealth = Math.max(0, currentHealth - 1 - extraDecline);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
            if (newHealth === 0) {
              playerDied();
            }
          }
        }).catch((error) => {
          console.error("Error decreasing health: ", error);
        });
      }
    }
    function playerDied() {
      alert("Your health has reached zero. You have died.");
      clearGameState();
      window.location.href = "index.html";
    }
    function restInRoom() {
      let restButton = document.getElementById("restButton");
      if (!restButton) return;
      restButton.disabled = true;
      restButton.textContent = "Resting...";
      let playerName = localStorage.getItem('playerName') || "Guest";
      const safePlayerName = sanitizePlayerName(playerName);
      let iterations = 12;
      let interval = setInterval(() => {
        iterations--;
        db.collection('players').doc(safePlayerName).get().then(doc => {
          if (doc.exists) {
            let currentHealth = doc.data().health || 100;
            let newHealth = Math.min(100, currentHealth + 2);
            db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
          }
        });
        if (iterations <= 0) {
          clearInterval(interval);
          restButton.disabled = false;
          restButton.textContent = "Rest (Recover Health)";
          alert("Rest complete! Your health has improved.");
        }
      }, 5000);
    }
    function toggleMusicPlayer() {
      var player = document.getElementById("bgMusic");
      if (player.style.display === "none" || player.style.display === "" || player.style.width === "0px") {
        player.style.display = "block";
        player.style.width = "300px";
        player.style.height = "200px";
        player.style.position = "relative";
        player.style.left = "0";
      } else {
        player.style.display = "none";
        player.style.width = "0";
        player.style.height = "0";
        player.style.position = "absolute";
        player.style.left = "-9999px";
      }
    }
    function updateEnvironmentStatus() {
      const envDiv = document.getElementById('envStatus');
      const currentWind = windSpeed;
      const voltage = parseFloat(localStorage.getItem('voltage')) || 0;
      const efficiency = Math.max(0.5, 1 - (garbageLevel / 200));
      const minVoltageThreshold = 20;
      const basePressure = voltage >= minVoltageThreshold ? voltage * 0.8 : 0;
      const waterPressure = Math.round(basePressure * efficiency);
      const currentGarbage = garbageLevel;
      if (envDiv) {
        envDiv.innerHTML = `Wind Speed: ${currentWind} | Voltage: ${voltage}V | Water Pressure: ${waterPressure} PSI | Garbage Level: ${currentGarbage}/100`;
      }
    }

    // Community Garden Functions
    function renderGardenSlots() {
      const container = document.getElementById("plantSlots");
      if (!container) return;
      container.innerHTML = "";
      container.innerHTML += "<h4>Soil (Seeds)</h4>";
      soilSlots.forEach(slot => {
        let div = document.createElement("div");
        div.className = "slot";
        if (!slot.type) {
          div.innerHTML = `Slot ${slot.slot}: <span class="status">Empty</span> <button onclick="openPlantSelection(${slot.slot}, 'soil')">Plant Seed</button>`;
        } else {
          let status = slot.watered ? "Watered, growing..." : "Planted: " + slot.type + " (needs water)";
          div.innerHTML = `Slot ${slot.slot}: <span class="status">${status}</span>`;
          if (!slot.watered) {
            div.innerHTML += ` <button onclick="waterPlant(${slot.slot}, 'soil')">Water Plant</button>`;
          }
        }
        container.appendChild(div);
      });
      container.innerHTML += "<h4>Tree Stump (Mushrooms)</h4>";
      stumpSlots.forEach(slot => {
        let div = document.createElement("div");
        div.className = "slot";
        if (!slot.type) {
          div.innerHTML = `Slot ${slot.slot}: <span class="status">Empty</span> <button onclick="openPlantSelection(${slot.slot}, 'stump')">Plant Mushroom</button>`;
        } else {
          let status = slot.watered ? "Watered, growing..." : "Planted: " + slot.type + " (needs water)";
          div.innerHTML = `Slot ${slot.slot}: <span class="status">${status}</span>`;
          if (!slot.watered) {
            div.innerHTML += ` <button onclick="waterPlant(${slot.slot}, 'stump')">Water Plant</button>`;
          }
        }
        container.appendChild(div);
      });
    }
    function openPlantSelection(slotNum, category) {
      let available = (category === 'soil') ? seedTypes : mushroomTypes;
      let inventoryOptions = available.filter(type => harvestInventory[type] && harvestInventory[type] > 0);
      if (inventoryOptions.length === 0) {
        alert("You do not have any " + (category === 'soil' ? "seeds" : "mushrooms") + " in your inventory.");
        return;
      }
      let selectedType = inventoryOptions[0];
      removeItem(selectedType, 1);
      if (category === 'soil') {
        soilSlots[slotNum - 1] = { slot: slotNum, type: selectedType, watered: false, timer: null };
      } else {
        stumpSlots[slotNum - 1] = { slot: slotNum, type: selectedType, watered: false, timer: null };
      }
      renderGardenSlots();
    }
    function waterPlant(slotNum, category) {
      if (waterInventory < 1) {
        alert("No water available. Please collect water.");
        return;
      }
      waterInventory--;
      localStorage.setItem('water', waterInventory);
      const waterInvDisplay = document.getElementById('waterInventoryDisplay');
      if (waterInvDisplay) {
        waterInvDisplay.textContent = waterInventory;
      }
      let slotArray = (category === 'soil') ? soilSlots : stumpSlots;
      slotArray[slotNum - 1].watered = true;
      renderGardenSlots();
      slotArray[slotNum - 1].timer = setTimeout(() => {
        const matureType = slotArray[slotNum - 1].type;
        alert("Your " + matureType + " has matured!");
        addItem(matureType, 1);
        slotArray[slotNum - 1] = { slot: slotNum, type: null, watered: false, timer: null };
        renderGardenSlots();
      }, 300000);
    }

    // Grocery Stand Functions
    function generateGroceryItems() {
      let seedContainer = document.getElementById("seedList");
      if (seedContainer) {
        seedContainer.innerHTML = "";
        seedTypes.forEach(seed => {
          let div = document.createElement("div");
          div.className = "grocery-item";
          div.innerHTML = `<p><strong>${seed}</strong> - $2<br><em>${seed} is essential for growth.</em></p>
                           <button onclick="buyItem('${seed}')">Buy ${seed}</button>`;
          seedContainer.appendChild(div);
        });
      }
      let mushroomContainer = document.getElementById("mushroomList");
      if (mushroomContainer) {
        mushroomContainer.innerHTML = "";
        mushroomTypes.forEach(mushroom => {
          let div = document.createElement("div");
          div.className = "grocery-item";
          div.innerHTML = `<p><strong>${mushroom}</strong> - $2<br><em>${mushroom} adds flavor and nutrients.</em></p>
                           <button onclick="buyItem('${mushroom}')">Buy ${mushroom}</button>`;
          mushroomContainer.appendChild(div);
        });
      }
      let healthContainer = document.getElementById("healthItemList");
      if (!healthContainer && document.getElementById("grocery-panel")) {
        healthContainer = document.createElement("div");
        healthContainer.id = "healthItemList";
        healthContainer.innerHTML = `<h4>Health Items</h4>`;
        document.getElementById("grocery-panel").appendChild(healthContainer);
      } else if (healthContainer) {
        healthContainer.innerHTML = `<h4>Health Items</h4>`;
      }
      let div = document.createElement("div");
      div.className = "grocery-item";
      div.innerHTML = `<p><strong>First Aid Kit</strong> - $8<br><em>Restores 20 health.</em></p>
                       <button onclick="buyItem('First Aid Kit')">Buy First Aid Kit</button>`;
      if (healthContainer) {
        healthContainer.appendChild(div);
      }
    }
    function sellHarvest() {
      const checkboxes = document.querySelectorAll('.sell-checkbox:checked');
      if (!checkboxes.length) {
        alert("Select at least one item to sell.");
        return;
      }
      const sellPrices = { 'Food Staples': 5, 'Lubricant Oil': 2.5, 'Alcohol': 1.5, 'Cigarettes': 2 };
      checkboxes.forEach(cb => {
        const item = cb.getAttribute('data-item');
        const qty = harvestInventory[item];
        const price = sellPrices[item] || 1;
        let money = parseInt(localStorage.getItem('money')) || 50;
        money += price * qty;
        localStorage.setItem('money', money);
        removeItem(item, qty);
        alert(`Sold ${qty} ${item}(s) for $${price * qty}.`);
      });
      updateSellInventory();
      updatePlayerStatus();
    }
    function toggleBuySell(mode) {
      if (mode === 'buy') {
        document.getElementById('buySection').style.display = 'grid';
        document.getElementById('sellSection').style.display = 'none';
      } else {
        document.getElementById('buySection').style.display = 'none';
        document.getElementById('sellSection').style.display = 'block';
        updateSellInventory();
      }
    }
    function updateSellInventory() {
      const sellDiv = document.getElementById('sellInventory');
      if (sellDiv) {
        sellDiv.innerHTML = "";
        for (let item in harvestInventory) {
          const qty = harvestInventory[item];
          if (qty > 0) {
            let div = document.createElement('div');
            div.className = "sell-item";
            div.innerHTML = `<label>
                              <input type="checkbox" class="sell-checkbox" data-item="${item}" data-qty="${qty}">
                              ${item} - Quantity: ${qty}
                             </label>`;
            sellDiv.appendChild(div);
          }
        }
        if (!sellDiv.innerHTML) sellDiv.innerHTML = "<p>You have no items to sell.</p>";
      }
    }
    function openTab(evt, tabName) {
      const tabs = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabs.length; i++) { tabs[i].style.display = "none"; }
      const btns = document.getElementsByClassName("tab-button");
      for (let i = 0; i < btns.length; i++) { btns[i].classList.remove("active"); }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }

    // Community Kitchen Tab Functions
    function openKitchenTab(evt, tabName) {
      const tabcontents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontents.length; i++) {
        tabcontents[i].classList.remove("active");
      }
      const tabbuttons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
      }
      document.getElementById(tabName).classList.add("active");
      if (evt) {
        evt.currentTarget.classList.add("active");
      }
      if (tabName === 'cookbookTab') {
        renderRecipes();
      }
    }

    // Spelunking Game Functions (for Room 5)
    function initSpelunkingGame() {
      window.location.href = "room5.html";
    }
    function exitSpelunkingGame() {
      window.location.href = "index.html";
    }

    // Onload Initialization
    window.onload = function() {
      // Populate room numbers for character creation
      var roomSelect = document.getElementById('roomNumber');
      if (roomSelect) {
        for (let i = 1; i <= 25; i++) {
          let option = document.createElement('option');
          option.value = i;
          option.textContent = "Room " + i;
          roomSelect.appendChild(option);
        }
      }
      // Generate Room buttons in the grid (if used)
      var gridContainer = document.querySelector(".grid");
      if (gridContainer) {
        const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
        rooms.forEach(function(room) {
          let btn = document.createElement("button");
          btn.textContent = "Room " + room;
          btn.onclick = function() { openRoomInteraction("Room " + room); };
          gridContainer.appendChild(btn);
        });
      }
      // Render Garden Slots if the element exists (for inline testing)
      var plantSlotsDiv = document.getElementById("plantSlots");
      if (plantSlotsDiv) {
        renderGardenSlots();
      }
      if (document.getElementById('windSpeedSlider')) {
        document.getElementById('windSpeedSlider').value = windSpeed;
        document.getElementById('windSpeedValue').textContent = windSpeed;
      }
      updateVoltage();
      // Only call updateGarbageDisplay if the element exists (it may be in a separate module)
      if (document.getElementById('garbageDisplay')) {
        updateGarbageDisplay();
      }
      updateEnvironmentStatus();
      checkCharacterExistence();
      harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
      waterInventory = parseInt(localStorage.getItem('water')) || 0;
      generateGroceryItems();
      setInterval(simulatePowerEvent, 60000);
      // Only update garbage display if the element exists
      if (document.getElementById('garbageDisplay')) {
        setInterval(updateGarbageDisplay, 60000);
      }
      setInterval(updateVoltage, 5000);
      setInterval(simulateHealthDecline, 60000);
      setInterval(updateEnvironmentStatus, 5000);
      listenForKitchenChat();
      listenForLaundryChat();
      
      // Chat input listeners
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendChatMessage();
          }
        });
      }
      const kitchenChatInput = document.getElementById('kitchenChatInput');
      if (kitchenChatInput) {
        kitchenChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendKitchenChat();
          }
        });
      }
      const laundryChatInput = document.getElementById('laundryChatInput');
      if (laundryChatInput) {
        laundryChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendLaundryChat();
          }
        });
      }
    };
  </script>
</body>
</html>
