<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    /* Set body background with full image */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
      position: relative;
    }
    /* Apply full-page dark overlay using a pseudo-element */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5));
      z-index: -1;
      pointer-events: none;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    /* Shared container style */
    .container, .panel, #characterCreation, .modal {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    /* Grid of Rooms */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* --- Absolute Positioned Buttons (restored) --- */
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    .exit-button {
      position: absolute;
      left: 0;
      top: 530px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    /* --- End Absolute Positioned Buttons --- */

    /* Navigation Links â€“ these link to the modular pages */
    .nav-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      max-width: 800px;
    }
    .nav-links a {
      text-decoration: none;
    }
    .nav-links button {
      padding: 10px 20px;
      font-size: 16px;
      border: 2px solid #fff;
      border-radius: 4px;
      background-color: #5DADE2;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .nav-links button:hover {
      background-color: #4a90e2;
    }
    /* Grid of Rooms (if you want some interactive room buttons in the hub) */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none; /* Hidden by default */
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Chat Panel (if you need in-hub chat functionality) */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Player Biodata Panel */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Door Modal (for knocking and PIN system) */
    .modal, #doorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea,
    #doorModal button, #doorModal input {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    /* Environmental Status Panel */
    #envStatus {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
      margin: 10px auto;
      max-width: 600px;
    }
    /* Hide spelunking game on the hub */
    #spelunkingGame {
      display: none;
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="wrapper">
    <!-- Hidden YouTube Player for Ambient Music -->
    <iframe id="bgMusic" width="0" height="0" src="https://www.youtube.com/embed/gSwi1Tk1gV8?autoplay=1&loop=1&playlist=gSwi1Tk1gV8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position:absolute; left:-9999px;"></iframe>
    <!-- Toggle Music Player Button -->
    <div style="text-align:center; margin-top:10px;">
      <button onclick="toggleMusicPlayer()">Toggle Music Player</button>
    </div>
    
    <!-- Character Creation Section -->
    <div id="characterCreation">
      <h3>Create Your Character</h3>
      <p>Welcome, <span id="displayName"></span>!</p>
      <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
        <input type="text" id="charName" placeholder="Name" required>
        <input type="number" id="charAge" placeholder="Age" required>
        <select id="charGender" required>
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
        <textarea id="charBackstory" placeholder="Backstory" required></textarea>
        <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
        <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
        <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
        <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
        <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
        <select id="roomNumber" required>
          <option value="">Select Room Number</option>
        </select>
        <button type="submit">Create Character</button>
      </form>
    </div>
    
    <!-- Main Game Section -->
    <div id="mainGame" style="display: none;">
      <!-- Notification Panel -->
      <div id="notificationPanel"></div>
      <!-- Main Screen -->
      <div id="main-screen">
        <div class="container">
          <!-- Absolute Positioned Buttons -->
          <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
          <button class="exit-button" onclick="signOutUser()">Exit</button>
          <script>
            function signOutUser() {
              firebase.auth().signOut().then(() => {
                clearGameState();
                window.location.href = 'index.html';
              }).catch((error) => {
                console.error("Error signing out: ", error);
              });
            }
          </script>
          <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
          <!-- Navigation Links to Modular Pages -->
          <div class="nav-links">
            <a href="community-kitchen.html"><button>Community Kitchen</button></a>
            <a href="groceries-stand.html"><button>Groceries Stand</button></a>
            <a href="water-supplies.html"><button>Water Supplies (Laundry)</button></a>
            <a href="power-room.html"><button>Power Room</button></a>
            <a href="room5.html"><button>Room 5</button></a>
            <a href="room14.html"><button>Room 14</button></a>
          </div>
          <!-- Optional: Grid of Room Buttons for additional interactions -->
          <div class="grid">
            <!-- Room buttons generated dynamically -->
          </div>
        </div>
        <div class="facilities">
          <!-- Quick access for biodata -->
          <button onclick="togglePlayerStatus()">Biodata</button>
        </div>
        <!-- Environmental Status Panel -->
        <div id="envStatus"></div>
        <!-- Biodata Panel -->
        <div id="playerStatus">
          <!-- Biodata dynamically updated -->
        </div>
      </div>
      
      <!-- Chat Modal (if inline room chat is needed) -->
      <div id="chatPanel">
        <h2 id="chatRoomTitle"></h2>
        <div id="chatLog"></div>
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button onclick="sendChatMessage()">Send</button>
        <button onclick="closeChat()">Close Chat</button>
        <div id="restContainer" style="margin-top:10px;"></div>
      </div>
    </div>
    
    <!-- Door Modal (Knocking & PIN system) -->
    <div id="doorModal">
      <h2 id="doorTitle">Door Interaction</h2>
      <div id="doorOptions">
        <button onclick="handleKnock()">Knock</button>
        <button onclick="showPasswordInput()">Enter Password</button>
      </div>
      <div id="passwordDiv" style="display:none;">
        <input type="text" id="doorPassword" placeholder="Enter 4-digit password">
        <button onclick="verifyPassword()">Submit Password</button>
      </div>
      <button onclick="closeDoorModal()">Cancel</button>
    </div>
    
    <!-- Spelunking Game Container (for Room 5) - now hidden on the hub -->
    <div id="spelunkingGame" style="display: none;">
      <canvas id="spelunkingCanvas"></canvas>
      <button id="exitSpelunking" onclick="exitSpelunkingGame()">Exit Cave</button>
    </div>
  </div>

  <script>
    // Dummy definitions for missing functions to prevent errors

    function updateVoltage() {
      // Dummy function: in a full implementation, this would update voltage-related UI
      console.log("updateVoltage called (dummy)");
    }

    function updateGarbageDisplay() {
      // Dummy function: update garbage display if needed
      console.log("updateGarbageDisplay called (dummy)");
    }

    function checkCharacterExistence() {
      // For testing, assume character exists and show the main game UI
      document.getElementById('mainGame').style.display = 'block';
      // Optionally, hide the character creation panel
      document.getElementById('characterCreation').style.display = 'none';
    }

    function listenForKitchenChat() { /* Dummy */ }
    function listenForLaundryChat() { /* Dummy */ }
    function sendChatMessage() { /* Dummy */ }
    function sendKitchenChat() { /* Dummy */ }
    function sendLaundryChat() { /* Dummy */ }
    function togglePlayerStatus() { /* Dummy toggle */ 
      var biodata = document.getElementById('playerStatus');
      biodata.style.display = (biodata.style.display === "block") ? "none" : "block";
    }
    function clearGameState() { /* Dummy: clear localStorage or game state */ }
    function handleKnock() { /* Dummy */ }
    function showPasswordInput() { /* Dummy */ }
    function verifyPassword() { /* Dummy */ }
    function closeDoorModal() { document.getElementById('doorModal').style.display = 'none'; }
    function openRoomInteraction(room) { /* Dummy */ }
    function exitSpelunkingGame() { 
      // For Room 5, redirect back to the hub
      window.location.href = "DissonanceHeights.html"; 
    }
    function createCharacter() { 
      // Dummy: on character creation, show the main game UI
      document.getElementById('characterCreation').style.display = 'none';
      document.getElementById('mainGame').style.display = 'block';
    }

    // Updated Panel Navigation Functions (redirecting to separate pages)
    function openGardenPanel() {
      window.location.href = "community-garden.html";
    }
    function showGarbagePanel() {
      window.location.href = "garbage-chute.html";
    }
    function openKitchenPanel() {
      window.location.href = "community-kitchen.html";
    }
    function openWaterPanel() {
      window.location.href = "water-supplies.html";
    }
    function openGroceryPanel() {
      window.location.href = "groceries-stand.html";
    }

    // Toggle Music Player (existing implementation)
    function toggleMusicPlayer() {
      var player = document.getElementById("bgMusic");
      if (player.style.display === "none" || player.style.display === "" || player.style.width === "0px") {
        player.style.display = "block";
        player.style.width = "300px";
        player.style.height = "200px";
        player.style.position = "relative";
        player.style.left = "0";
      } else {
        player.style.display = "none";
        player.style.width = "0";
        player.style.height = "0";
        player.style.position = "absolute";
        player.style.left = "-9999px";
      }
    }

    // Onload Initialization
    window.onload = function() {
      // Populate room numbers for character creation
      var roomSelect = document.getElementById('roomNumber');
      if (roomSelect) {
        for (let i = 1; i <= 25; i++) {
          let option = document.createElement('option');
          option.value = i;
          option.textContent = "Room " + i;
          roomSelect.appendChild(option);
        }
      }
      // Generate Room buttons in the grid (if used)
      var gridContainer = document.querySelector(".grid");
      if (gridContainer) {
        const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
        rooms.forEach(function(room) {
          let btn = document.createElement("button");
          btn.textContent = "Room " + room;
          btn.onclick = function() { openRoomInteraction("Room " + room); };
          gridContainer.appendChild(btn);
        });
      }
      // Render Garden Slots if the element exists (for inline testing)
      var plantSlotsDiv = document.getElementById("plantSlots");
      if (plantSlotsDiv) {
        // Assuming renderGardenSlots is defined in your full implementation
        if (typeof renderGardenSlots === "function") {
          renderGardenSlots();
        }
      }
      if (document.getElementById('windSpeedSlider')) {
        document.getElementById('windSpeedSlider').value = 50; // dummy value
        document.getElementById('windSpeedValue').textContent = 50;
      }
      updateVoltage();
      if (document.getElementById('garbageDisplay')) {
        updateGarbageDisplay();
      }
      // For testing, show the main game UI
      checkCharacterExistence();
      // Dummy initialization for inventories and intervals
      setInterval(updateVoltage, 5000);
      setInterval(updateGarbageDisplay, 60000);
      setInterval(function(){ console.log("updateEnvironmentStatus (dummy)"); }, 5000);
      listenForKitchenChat();
      listenForLaundryChat();
      
      // Chat input listeners
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendChatMessage();
          }
        });
      }
      const kitchenChatInput = document.getElementById('kitchenChatInput');
      if (kitchenChatInput) {
        kitchenChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendKitchenChat();
          }
        });
      }
      const laundryChatInput = document.getElementById('laundryChatInput');
      if (laundryChatInput) {
        laundryChatInput.addEventListener('keydown', function(event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendLaundryChat();
          }
        });
      }
    };
  </script>
</body>
</html>
