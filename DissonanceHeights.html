<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    /* Global Styles & Eastern European Snowy Minimal Theme */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: 
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
        url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .container, .panel, #characterCreation, .modal, #loginPanel {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    .exit-button {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(200,150,130,0.7);
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
    }
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 400px;
      margin: 20px auto;
      background: rgba(0,0,0,0.8);
      border-radius: 8px;
    }
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #garden-panel .slot {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #777;
      border-radius: 4px;
    }
    #garden-panel .slot button {
      margin-left: 5px;
      padding: 3px 6px;
      font-size: 12px;
    }
    #loginPanel {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
      display: none;
    }
  </style>
  <!-- Firebase SDKs: Auth and Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- Login Panel -->
<div id="loginPanel">
  <h3>Login / Register</h3>
  <input type="email" id="loginEmail" placeholder="Email" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button onclick="loginUser()">Login</button>
  <button onclick="registerUser()">Register</button>
  <button onclick="googleSignIn()">Sign in with Google</button>
</div>

<!-- Character Creation Section -->
<div id="characterCreation">
  <h3>Create Your Character</h3>
  <p>Welcome, <span id="displayName"></span>!</p>
  <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
    <input type="text" id="charName" placeholder="Name" required>
    <input type="number" id="charAge" placeholder="Age" required>
    <select id="charGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
    <textarea id="charBackstory" placeholder="Backstory" required></textarea>
    <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
    <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
    <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
    <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
    <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
    <select id="roomNumber" required>
      <option value="">Select Room Number</option>
    </select>
    <button type="submit">Create Character</button>
  </form>
</div>

<!-- Main Game Section -->
<div id="mainGame" style="display: none;">
  <div id="main-screen">
    <div class="container">
      <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
      <button class="exit-button" onclick="signOutUser()">Exit</button>
      <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
      <div class="grid">
        <!-- Dynamically generated room buttons -->
      </div>
      <button class="power-room" onclick="showPowerPanel()">Power Room</button>
    </div>
    <div class="facilities">
      <button onclick="handleClick('Community Kitchen')">Community Kitchen</button>
      <button onclick="openGroceryPanel()">Groceries Stand</button>
      <button onclick="handleClick('Water Supplies (Laundry)')">Water Supplies (Laundry)</button>
      <button onclick="togglePlayerStatus()">Biodata</button>
    </div>
    <div id="playerStatus">
      <!-- Biodata updated dynamically -->
    </div>
  </div>

  <!-- Power Source Panel -->
  <div id="minigame-panel" class="panel">
    <h2>Wind Turbine Control Panel</h2>
    <p><strong>Objective:</strong> Ensure the turbine provides electricity, water heating, and lighting.</p>
    <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    <div id="instructions" style="display: none;">
      <p>Adjust wind speed, engage brakes as needed, lubricate, and confirm power output.</p>
    </div>
    <div class="control">
      <label for="windSpeedSlider">Wind Speed Regulator:</label>
      <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
      <span id="windSpeedValue"></span>
    </div>
    <div class="control">
      <label for="brakeButton">Brake System:</label>
      <button id="brakeButton" onclick="toggleBrake()">Engage Brake</button>
    </div>
    <div class="control">
      <label>Voltage Monitor:</label>
      <span id="voltageDisplay"></span> V
    </div>
    <div class="control">
      <label for="lubricateButton">Lubrication Check:</label>
      <button id="lubricateButton" onclick="lubricate()">Lubricate</button>
    </div>
    <div class="control">
      <label for="powerOutputConfirm">Power Output Confirm:</label>
      <button id="powerOutputConfirm" onclick="togglePowerOutput()">Confirm Output</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('minigame-panel')">Return to Main Screen</button>
    </div>
    <h3>System Log:</h3>
    <div id="minigameLog"></div>
    <div class="control">
      <label>Power Status:</label>
      <span id="powerStatusDisplay">Unknown</span>
    </div>
  </div>

  <!-- Garbage Chute Panel -->
  <div id="garbage-panel" class="panel">
    <h2>Garbage Chute Control</h2>
    <p><strong>Objective:</strong> Clear accumulated garbage before it causes a community health crisis.</p>
    <div class="control">
      <label>Garbage Level:</label>
      <span id="garbageDisplay"></span> / 100
    </div>
    <div class="control">
      <button onclick="clearGarbage()">Clear Garbage</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('garbage-panel')">Return to Main Screen</button>
    </div>
    <h3>Garbage Log:</h3>
    <div id="garbageLog"></div>
  </div>

  <!-- Grocery Store Panel -->
  <div id="grocery-panel" class="panel">
    <h2>Grocery Store</h2>
    <p>Purchase essential items. Prices may vary with electricity availability.</p>
    <div class="grocery-item">
      <p><strong>Food Staples</strong> - $10</p>
      <button onclick="buyItem('Food Staples')">Buy Food</button>
    </div>
    <div class="grocery-item">
      <p><strong>Seeds</strong> (for Community Garden) - $2 each</p>
      <button onclick="buyItem('Seeds')">Buy Seeds</button>
    </div>
    <div class="grocery-item">
      <p><strong>Maintenance Essentials</strong> - $5</p>
      <button onclick="buyItem('Maintenance Essentials')">Buy Maintenance</button>
    </div>
    <div class="grocery-item">
      <p><strong>Room Decorations</strong> - $7</p>
      <button onclick="buyItem('Room Decoration')">Buy Decoration</button>
    </div>
    <div class="grocery-item">
      <p><strong>Alcohol</strong> - $3</p>
      <button onclick="buyItem('Alcohol')">Buy Alcohol</button>
    </div>
    <div class="grocery-item">
      <p><strong>Cigarettes</strong> - $4</p>
      <button onclick="buyItem('Cigarettes')">Buy Cigarettes</button>
    </div>
    <button onclick="hidePanel('grocery-panel')">Return to Main Screen</button>
  </div>

  <!-- Community Garden Panel -->
  <div id="garden-panel" class="panel">
    <h2>Community Garden</h2>
    <p>Manage your rooftop garden. Plants need watering, fertilizing, and must be harvested manually when mature. Seasonal changes affect growth.</p>
    <div id="plantSlots">
      <!-- Plant slots will be generated dynamically -->
    </div>
    <button onclick="sellProduce()">Sell All Mature Produce</button>
    <button onclick="hidePanel('garden-panel')">Return to Main Screen</button>
  </div>

  <!-- Chat Panel (Room Chat) -->
  <div id="chatPanel" class="panel">
    <h2 id="chatRoomTitle"></h2>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="closeChat()">Close Chat</button>
  </div>

  <!-- Modal: Room Interaction Options -->
  <div id="roomInteractionModal" class="modal">
    <h2>Room Interaction</h2>
    <p>How do you want to interact with <span id="interactionRoomName"></span>?</p>
    <button onclick="chooseKnock()">Knock on Door</button>
    <button onclick="closeRoomInteractionModal()">Cancel</button>
  </div>

  <!-- Modal: Knock Chat -->
  <div id="knockModal" class="modal">
    <h2>Knock Request</h2>
    <p>Type a brief message (max 50 characters):</p>
    <input type="text" id="knockMessage" maxlength="50" placeholder="Your knock message...">
    <button onclick="sendKnock()">Send Knock</button>
    <button onclick="closeKnockModal()">Cancel</button>
  </div>

  <!-- Modal: Plant Selection -->
  <div id="plantSelectionModal" class="modal">
    <h2>Select Plant Type</h2>
    <select id="plantTypeSelect">
      <!-- Options populated dynamically -->
    </select>
    <button onclick="confirmPlantSelection()">Plant</button>
    <button onclick="closePlantSelectionModal()">Cancel</button>
  </div>
</div>

<script>
  // ----------------------------
  // Firebase Initialization & Config
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
    authDomain: "thephantasyreport.firebaseapp.com",
    projectId: "thephantasyreport",
    storageBucket: "thephantasyreport.firebasestorage.app",
    messagingSenderId: "887983841070",
    appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
    measurementId: "G-9MS36H0YV4"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ----------------------------
  // Utility: Clear All Game State from localStorage
  // ----------------------------
  function clearGameState() {
    const keys = ['playerName', 'characterName', 'money', 'seeds', 'mushroomSeeds', 'windSpeed', 'brakeEngaged', 'powerOutputConfirmed', 'lastInteractionTime', 'garbageLevel', 'lastGarbageUpdate'];
    keys.forEach(key => localStorage.removeItem(key));
  }

  // ----------------------------
  // Gardening System Enhancements
  // ----------------------------
  // Define growth thresholds (in minutes) and seasonal growth factors.
  const growthThresholds = {
    seed: 0,         // 0+
    sprout: 10,      // from 10 minutes
    young: 30,       // from 30 minutes
    mature: 60       // from 60 minutes onward
  };
  // Seasonal growth factors: Spring and Summer: faster; Autumn and Winter: slower.
  function getGrowthFactor() {
    if (currentSeason === "Spring" || currentSeason === "Summer") {
      return 1.5;
    } else {
      return 0.75;
    }
  }
  // Instead of a simple "mature" flag, we store the current stage.
  // When a plant is created, add a "stage" property (initially "Seed").
  // Modify updateGardenUI to update based on elapsed time * growth factor.
  function updateGardenUI() {
    const factor = getGrowthFactor();
    for (let i = 1; i <= 10; i++) {
      let slot = document.getElementById('slot' + i);
      let statusSpan = slot.querySelector('.status');
      if (garden[i].plantedTime === null) {
        statusSpan.textContent = "Empty";
        // Remove any existing harvest button if present.
        let existingBtn = slot.querySelector('.harvestBtn');
        if (existingBtn) existingBtn.remove();
      } else {
        let elapsed = ((Date.now() - garden[i].plantedTime) / 60000) * factor;
        let stage = "Seed";
        if (elapsed >= growthThresholds.sprout && elapsed < growthThresholds.young) {
          stage = "Sprout";
        } else if (elapsed >= growthThresholds.young && elapsed < growthThresholds.mature) {
          stage = "Young";
        } else if (elapsed >= growthThresholds.mature) {
          stage = "Mature";
        }
        garden[i].stage = stage;
        statusSpan.textContent = stage + (garden[i].produceType ? ": " + garden[i].produceType.name : "");
        // If mature, show a harvest button if not already added.
        if (stage === "Mature" && !slot.querySelector('.harvestBtn')) {
          let harvestBtn = document.createElement('button');
          harvestBtn.className = 'harvestBtn';
          harvestBtn.textContent = "Harvest";
          harvestBtn.onclick = function() { harvestPlant(i); };
          slot.appendChild(harvestBtn);
        }
      }
    }
    // For the mushroom tree (slot 11)
    let treeSlot = document.getElementById('mushroomTree');
    let treeStatus = treeSlot.querySelector('.status');
    if (garden[11].plantedTime === null) {
      treeStatus.textContent = "Empty";
      let existingBtn = treeSlot.querySelector('.harvestBtn');
      if (existingBtn) existingBtn.remove();
    } else {
      let elapsed = ((Date.now() - garden[11].plantedTime) / 60000) * factor;
      let stage = "Seed";
      if (elapsed >= growthThresholds.sprout && elapsed < growthThresholds.young) {
        stage = "Sprout";
      } else if (elapsed >= growthThresholds.young && elapsed < growthThresholds.mature) {
        stage = "Young";
      } else if (elapsed >= growthThresholds.mature) {
        stage = "Mature";
      }
      garden[11].stage = stage;
      treeStatus.textContent = stage + (garden[11].produceType ? ": " + garden[11].produceType.name : "");
      if (stage === "Mature" && !treeSlot.querySelector('.harvestBtn')) {
        let harvestBtn = document.createElement('button');
        harvestBtn.className = 'harvestBtn';
        harvestBtn.textContent = "Harvest";
        harvestBtn.onclick = function() { harvestPlant(11); };
        treeSlot.appendChild(harvestBtn);
      }
    }
  }
  // Harvest function: When a plant is harvested, add money based on produce price.
  function harvestPlant(slotNumber) {
    let plant = garden[slotNumber];
    if (!plant || plant.stage !== "Mature" || !plant.produceType) {
      alert("This plant is not ready for harvest.");
      return;
    }
    // Example: yield value = produce price × 2 (you can adjust this as needed)
    let yieldValue = plant.produceType.price * 2;
    let currentMoney = parseInt(localStorage.getItem('money')) || 50;
    currentMoney += yieldValue;
    localStorage.setItem('money', currentMoney);
    alert("You harvested " + plant.produceType.name + " for $" + yieldValue + "!");
    // Reset the slot
    garden[slotNumber] = { plantedTime: null, wateredTime: null, fertilized: false, stage: "Empty", produceType: null };
    updateGardenUI();
    updatePlayerStatus();
  }

  // ----------------------------
  // Existing Code for Watering, Fertilizing, etc.
  // ----------------------------
  function openPlantSelectionModal(slotNumber) {
    document.getElementById('plantSelectionModal').style.display = 'block';
    document.getElementById('plantSelectionModal').setAttribute('data-slot', slotNumber);
    let select = document.getElementById('plantTypeSelect');
    select.innerHTML = "";
    plantTypes.forEach(pt => {
      let option = document.createElement('option');
      option.value = pt.name;
      option.textContent = pt.name + " ($" + pt.price + ")";
      select.appendChild(option);
    });
  }
  function closePlantSelectionModal() {
    document.getElementById('plantSelectionModal').style.display = 'none';
  }
  function confirmPlantSelection() {
    let slotNumber = document.getElementById('plantSelectionModal').getAttribute('data-slot');
    let selectedName = document.getElementById('plantTypeSelect').value;
    let selectedPlant = plantTypes.find(pt => pt.name === selectedName);
    let seeds = parseInt(localStorage.getItem('seeds')) || 0;
    if (seeds <= 0) {
      alert("No seeds available. Purchase from the Grocery Store.");
      closePlantSelectionModal();
      return;
    }
    seeds -= 1;
    localStorage.setItem('seeds', seeds);
    garden[slotNumber] = {
      plantedTime: Date.now(),
      wateredTime: Date.now(),
      fertilized: false,
      stage: "Seed",
      produceType: selectedPlant
    };
    updateGardenUI();
    updatePlayerStatus();
    closePlantSelectionModal();
  }
  function waterPlant(slotNumber) {
    garden[slotNumber].wateredTime = Date.now();
    alert("Plant in slot " + slotNumber + " watered.");
    updateGardenUI();
  }
  function fertilizePlant(slotNumber) {
    garden[slotNumber].fertilized = true;
    alert("Plant in slot " + slotNumber + " fertilized.");
    updateGardenUI();
  }
  function plantMushroomTree() {
    let mSeeds = parseInt(localStorage.getItem('mushroomSeeds')) || 0;
    if (mSeeds <= 0) {
      alert("No mushroom seeds available. Purchase from the Grocery Store.");
      return;
    }
    if (garden[11].plantedTime === null) {
      mSeeds -= 1;
      localStorage.setItem('mushroomSeeds', mSeeds);
      garden[11] = {
        plantedTime: Date.now(),
        wateredTime: Date.now(),
        fertilized: false,
        stage: "Seed",
        mushrooms: 0,
        produceType: mushroomTypes[Math.floor(Math.random() * mushroomTypes.length)]
      };
      updateGardenUI();
      updatePlayerStatus();
    } else {
      alert("The mushroom tree is already planted.");
    }
  }
  // The sellProduce function (sells all mature produce at once)
  function sellProduce() {
    let totalEarnings = 0;
    for (let i = 1; i <= 10; i++) {
      if (garden[i].stage === "Mature" && garden[i].produceType) {
        totalEarnings += garden[i].produceType.price;
        garden[i] = { plantedTime: null, wateredTime: null, fertilized: false, stage: "Empty", produceType: null };
        let slot = document.getElementById('slot' + i);
        let btn = slot.querySelector('button.harvestBtn');
        if (btn) btn.remove();
      }
    }
    if (garden[11].stage === "Mature" && garden[11].produceType) {
      totalEarnings += (garden[11].mushrooms * garden[11].produceType.price);
      garden[11] = { plantedTime: null, wateredTime: null, fertilized: false, stage: "Empty", mushrooms: 0, produceType: null };
      let slot = document.getElementById('mushroomTree');
      let btn = slot.querySelector('button.harvestBtn');
      if (btn) btn.remove();
    }
    let currentMoney = parseInt(localStorage.getItem('money')) || 50;
    currentMoney += totalEarnings;
    localStorage.setItem('money', currentMoney);
    alert("You sold your mature produce for $" + totalEarnings + ". Current money: $" + currentMoney);
    updatePlayerStatus();
    updateGardenUI();
  }

  // ----------------------------
  // Power Source Simulation (unchanged)
  // ----------------------------
  let windSpeed = localStorage.getItem('windSpeed') || 50;
  let brakeEngaged = JSON.parse(localStorage.getItem('brakeEngaged')) || false;
  let powerOutputConfirmed = JSON.parse(localStorage.getItem('powerOutputConfirmed')) || false;
  let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
  let garbageLevel = localStorage.getItem('garbageLevel') || 0;
  let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
  let powerStatus = "Unknown";
  function updateWindSpeed() {
    windSpeed = document.getElementById('windSpeedSlider').value;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    localStorage.setItem('windSpeed', windSpeed);
    updateVoltage();
    updateLastInteraction();
  }
  function toggleBrake() {
    brakeEngaged = !brakeEngaged;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    localStorage.setItem('brakeEngaged', brakeEngaged);
    updateVoltage();
    updateLastInteraction();
  }
  function togglePowerOutput() {
    powerOutputConfirmed = !powerOutputConfirmed;
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    localStorage.setItem('powerOutputConfirmed', powerOutputConfirmed);
    evaluatePowerOutput();
    updateLastInteraction();
  }
  function lubricate() {
    logPowerMessage("Lubrication complete. Moving parts are now well-oiled.");
    updateLastInteraction();
  }
  function updateVoltage() {
    let factor = brakeEngaged ? 0.5 : 1.0;
    let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
    voltage = Math.max(0, voltage);
    document.getElementById('voltageDisplay').textContent = voltage.toFixed(1);
    localStorage.setItem('voltage', voltage);
  }
  function evaluatePowerOutput() {
    if(windSpeed >= 40 && windSpeed <= 70 && powerOutputConfirmed) {
      powerStatus = "On";
    } else {
      powerStatus = "Off";
    }
    document.getElementById('powerStatusDisplay').textContent = powerStatus;
    if(powerStatus === "Off") {
      alert("Power is insufficient! Flats will experience reduced services.");
    }
  }
  function simulateRandomEvent() {
    if (Date.now() - lastInteractionTime > 30000) {
      logPowerMessage("System overload due to inactivity! Flats experience a blackout for 1-2 days.");
    }
    const events = [
      "Sudden strong winds detected! Adjust wind speed or engage brakes.",
      "Low energy output observed! Check lubrication or adjust controls.",
      "Minor electrical fault occurred! Reset the circuit breaker.",
      "Dust accumulation detected! Perform a quick maintenance check."
    ];
    logPowerMessage(events[Math.floor(Math.random() * events.length)]);
  }
  function logPowerMessage(message) {
    const logDiv = document.getElementById('minigameLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  function toggleInstructions() {
    const instrDiv = document.getElementById("instructions");
    instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
  }
  function updateLastInteraction() {
    lastInteractionTime = Date.now();
    localStorage.setItem('lastInteractionTime', lastInteractionTime);
  }
  function updateGarbageDisplay() {
    const now = Date.now();
    const elapsedHours = Math.floor((now - lastGarbageUpdate) / 3600000);
    garbageLevel = Math.min(100, Number(garbageLevel) + elapsedHours * 10);
    lastGarbageUpdate = now;
    localStorage.setItem('garbageLevel', garbageLevel);
    localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    if(garbageLevel > 80) {
      alert("High garbage levels detected! The community is getting sick.");
    }
  }
  function clearGarbage() {
    garbageLevel = 0;
    localStorage.setItem('garbageLevel', garbageLevel);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    logGarbageMessage("Garbage cleared by player.");
  }
  function logGarbageMessage(message) {
    const logDiv = document.getElementById('garbageLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // ----------------------------
  // Season Simulation
  // ----------------------------
  let currentSeason = "Spring";
  function updateSeason() {
    const seasons = ["Spring", "Summer", "Autumn", "Winter"];
    let index = Math.floor((Date.now() / 120000)) % seasons.length;
    currentSeason = seasons[index];
    console.log("Current Season: " + currentSeason);
  }
  setInterval(updateSeason, 120000);

  // ----------------------------
  // Modal Panel Utilities
  // ----------------------------
  function hidePanel(panelId) {
    document.getElementById(panelId).style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }

  // ----------------------------
  // DOMContentLoaded & Initialization
  // ----------------------------
  window.onload = function() {
    // Generate room number options
    var roomSelect = document.getElementById('roomNumber');
    if (roomSelect) {
      for (let i = 1; i <= 25; i++){
        let option = document.createElement('option');
        option.value = i;
        option.textContent = "Room " + i;
        roomSelect.appendChild(option);
      }
    }
    // Generate grid buttons for rooms
    var gridContainer = document.querySelector(".grid");
    if (gridContainer) {
      const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
      rooms.forEach(function(room) {
        let btn = document.createElement("button");
        btn.textContent = "Room " + room;
        btn.onclick = function() { openRoomInteraction("Room " + room); };
        gridContainer.appendChild(btn);
      });
    }
    // Generate plant slots
    var plantSlotsDiv = document.getElementById("plantSlots");
    if (plantSlotsDiv) {
      plantSlotsDiv.innerHTML = "";
      for (let i = 1; i <= 10; i++){
        let slotDiv = document.createElement("div");
        slotDiv.className = "slot";
        slotDiv.id = "slot" + i;
        slotDiv.innerHTML = 'Slot ' + i + ': <span class="status">Empty</span> <button onclick="openPlantSelectionModal('+ i +')">Plant Seed</button>';
        plantSlotsDiv.appendChild(slotDiv);
      }
      let treeDiv = document.createElement("div");
      treeDiv.className = "slot";
      treeDiv.id = "mushroomTree";
      treeDiv.innerHTML = 'Tree for Mushrooms: <span class="status">Empty</span> <button onclick="plantMushroomTree()">Plant Mushroom</button>';
      plantSlotsDiv.appendChild(treeDiv);
    }
    document.getElementById('windSpeedSlider').value = windSpeed;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    updateVoltage();
    updateGarbageDisplay();
    updateSeason();
    if (localStorage.getItem('playerName')) {
      checkCharacterExistence();
    }
    setInterval(updateVoltage, 5000);
    setInterval(simulateRandomEvent, 3600000);
    setInterval(updateGarbageDisplay, 3600000);
    setInterval(updateGardenUI, 60000);
  };
</script>
</body>
</html>
