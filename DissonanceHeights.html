<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for Soviet-era signage look -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    /* Global Styles & Eastern European Snowy Minimal Theme */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background:
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
        url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed;
      background-size: cover;
      color: #eee;
    }
    h1, h2, h3 {
      font-family: 'Russo One', sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .container, .panel, #characterCreation, .modal, #loginPanel {
      background-image: url('https://www.transparenttextures.com/patterns/concrete-wall.png');
      background-color: rgba(0, 0, 0, 0.6);
    }
    .container {
      position: relative;
      width: 600px;
      margin: 20px auto;
      padding: 10px;
      border-radius: 8px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    .panel h2, .modal h2 {
      text-align: center;
      color: #fff;
    }
    /* Grid of Rooms */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin: 20px 0;
      justify-content: center;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.2);
      border: 1px solid #777;
      cursor: pointer;
      font-size: 14px;
      color: #eee;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .grid button:hover {
      background-color: rgba(255,255,255,0.4);
    }
    /* Buttons */
    .garden-button {
      position: absolute;
      left: 210px;
      top: 10px;
      padding: 10px;
      background-color: #5DADE2;
      border: 2px solid #fff;
      border-radius: 4px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: rgba(211,211,211,0.3);
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      border-radius: 4px;
    }
    /* Exit button moved below garbage chute */
    .exit-button {
      position: absolute;
      left: 0;
      top: 530px;
      padding: 10px 15px;
      background-color: #FF4136;
      border: 2px solid #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 1001;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: rgba(192,192,255,0.5);
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: rgba(200,150,130,0.7);
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      border-radius: 4px;
      color: #222;
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    #characterCreation input,
    #characterCreation select,
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Enlarged editing fields for Biodata */
    #playerStatus input,
    #playerStatus textarea {
      width: 100% !important;
      font-size: 16px;
      padding: 8px;
      margin-bottom: 10px;
    }
    /* Modal Styles (for plant selection, kitchen, water, door interaction) */
    .modal, #doorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 1000;
    }
    .modal button, .modal input, .modal select, .modal textarea,
    #doorModal button, #doorModal input {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    /* Responsive Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
    }
    /* Responsive Chat Log */
    #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
    /* Biodata Panel */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Harvest Inventory Display */
    #harvestInventory {
      margin-top: 10px;
      padding: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
    }
    /* Garden Slots */
    #garden-panel .slot {
      margin: 10px 0;
      padding: 5px;
      border: 1px solid #777;
      border-radius: 4px;
    }
    #garden-panel .slot button {
      margin-left: 5px;
      padding: 3px 6px;
      font-size: 12px;
    }
    /* New panel for Login */
    #loginPanel {
      margin: 20px auto;
      max-width: 300px;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      color: #fff;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
      display: none;
    }
    /* In-App Notification Panel */
    #notificationPanel {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px;
      border: 1px solid #fff;
      border-radius: 4px;
      z-index: 1002;
      display: none;
      max-width: 300px;
      font-size: 14px;
    }
    /* New Community Kitchen Panel */
    #kitchen-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Recipe Panel for Cooking (new) */
    #recipePanel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* New Water Supplies Panel */
    #water-panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      border-radius: 8px;
      background: rgba(0,0,0,0.7);
    }
    /* Chat area within panels */
    .panel .chatArea {
      border: 1px solid #ccc;
      padding: 10px;
      height: 150px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
      color: #fff;
      border-radius: 4px;
    }
  </style>
  <!-- Firebase SDKs: Auth and Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- Hidden YouTube Player for Ambient Music -->
<iframe id="bgMusic" width="0" height="0" src="https://www.youtube.com/embed/-gKkA9SIxKw?autoplay=1&loop=1&playlist=-gKkA9SIxKw&si=RHzSkbFheF50TT_9" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position:absolute; left:-9999px;"></iframe>

<!-- Toggle Music Player Button (for Skip Ads if they appear) -->
<div style="text-align:center; margin-top:10px;">
  <button onclick="toggleMusicPlayer()">Toggle Music Player</button>
</div>

<!-- Login Panel -->
<div id="loginPanel">
  <h3>Login / Register</h3>
  <input type="email" id="loginEmail" placeholder="Email" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button onclick="loginUser()">Login</button>
  <button onclick="registerUser()">Register</button>
  <button onclick="googleSignIn()">Sign in with Google</button>
</div>

<!-- Character Creation Section -->
<div id="characterCreation">
  <h3>Create Your Character</h3>
  <p>Welcome, <span id="displayName"></span>!</p>
  <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
    <input type="text" id="charName" placeholder="Name" required>
    <input type="number" id="charAge" placeholder="Age" required>
    <select id="charGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
    <textarea id="charBackstory" placeholder="Backstory" required></textarea>
    <input type="text" id="charSkills" placeholder="Skills (comma separated)" required>
    <input type="text" id="charInventory" placeholder="Inventory (comma separated)" required>
    <input type="text" id="charAlliances" placeholder="Alliances (comma separated)">
    <input type="text" id="charRivalries" placeholder="Rivalries (comma separated)">
    <input type="number" id="charReputation" placeholder="Reputation" value="0" required>
    <select id="roomNumber" required>
      <option value="">Select Room Number</option>
    </select>
    <button type="submit">Create Character</button>
  </form>
</div>

<!-- Main Game Section -->
<div id="mainGame" style="display: none;">
  <!-- Notification Panel for In-App Alerts -->
  <div id="notificationPanel"></div>

  <!-- Main Screen -->
  <div id="main-screen">
    <div class="container">
      <!-- Garbage Chute and Exit Button (Exit below the chute) -->
      <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
      <button class="exit-button" onclick="signOutUser()">Exit</button>
      <button class="garden-button" onclick="openGardenPanel()">Community Garden</button>
      <div class="grid">
        <!-- Room buttons will be generated dynamically -->
      </div>
      <!-- Modified Power Room Button with Alert Symbol -->
      <button class="power-room" onclick="showPowerPanel()">
        Power Room <span id="powerAlert" style="display:none; font-size:1.2em; color:red;">!</span>
      </button>
    </div>
    <div class="facilities">
      <button onclick="openKitchenPanel()">Community Kitchen</button>
      <button onclick="openGroceryPanel()">Groceries Stand</button>
      <button onclick="openWaterPanel()">Water Supplies (Laundry)</button>
      <button onclick="togglePlayerStatus()">Biodata</button>
    </div>
    <div id="playerStatus">
      <!-- Biodata updated dynamically; toggle show/hide -->
    </div>
  </div>

  <!-- Power Source Panel with Enhanced Service Info -->
  <div id="minigame-panel" class="panel">
    <h2>Wind Turbine Control Panel</h2>
    <p><strong>Objective:</strong> Ensure the turbine provides electricity, water heating, and lighting.</p>
    <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    <div id="instructions" style="display: none;">
      <p>
        <strong>Step 1:</strong> Adjust the wind speed using the slider.<br>
        <strong>Step 2:</strong> Engage or release the brake as needed.<br>
        <strong>Step 3:</strong> Apply Lubricant Oil (if available) to maintain smooth operation.<br>
        <strong>Step 4:</strong> Confirm power output to ensure optimal performance.
      </p>
    </div>
    <div class="control">
      <label for="windSpeedSlider">Wind Speed Regulator:</label>
      <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
      <span id="windSpeedValue"></span>
    </div>
    <div class="control">
      <label for="brakeButton">Brake System:</label>
      <button id="brakeButton" onclick="toggleBrake()">Engage Brake</button>
    </div>
    <div class="control">
      <label>Voltage Monitor:</label>
      <span id="voltageDisplay"></span> V
    </div>
    <div class="control">
      <label for="lubricateButton">Apply Lubricant Oil:</label>
      <button id="lubricateButton" onclick="lubricate()">Apply Oil</button>
    </div>
    <div class="control">
      <label for="powerOutputConfirm">Power Output Confirm:</label>
      <button id="powerOutputConfirm" onclick="togglePowerOutput()">Confirm Output</button>
    </div>
    <!-- New Power Suggestions Section -->
    <div class="control">
      <h4>Service Impact & Suggestions:</h4>
      <div id="powerSuggestions" style="font-size:14px; background:rgba(255,255,255,0.1); padding:5px; border-radius:4px;"></div>
    </div>
    <div class="control">
      <button onclick="hidePanel('minigame-panel')">Return to Main Screen</button>
    </div>
    <h3>System Log:</h3>
    <div id="minigameLog"></div>
    <div class="control">
      <label>Power Status:</label>
      <span id="powerStatusDisplay">Unknown</span>
    </div>
  </div>

  <!-- Garbage Chute Panel -->
  <div id="garbage-panel" class="panel">
    <h2>Garbage Chute Control</h2>
    <p><strong>Objective:</strong> Clear accumulated garbage before it causes a community health crisis.</p>
    <div class="control">
      <label>Garbage Level:</label>
      <span id="garbageDisplay"></span> / 100
    </div>
    <div class="control">
      <button onclick="clearGarbage()">Clear Garbage</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('garbage-panel')">Return to Main Screen</button>
    </div>
    <h3>Garbage Log:</h3>
    <div id="garbageLog"></div>
  </div>

  <!-- Grocery Store Panel (Room Decoration removed) -->
  <div id="grocery-panel" class="panel">
    <h2>Grocery Store</h2>
    <p>Purchase essential items. Prices may vary with electricity availability.</p>
    <!-- Food Staples -->
    <div class="grocery-item">
      <p><strong>Food Staples</strong> - $10<br><em>Basic nourishment to reduce hunger.</em></p>
      <button onclick="buyItem('Food Staples')">Buy Food</button>
    </div>
    <!-- 20 Types of Seeds -->
    <div id="seedList">
      <h4>Seeds for Community Garden</h4>
      <!-- Dynamically generated seed items -->
    </div>
    <!-- 5 Types of Mushrooms -->
    <div id="mushroomList">
      <h4>Mushrooms for Cultivation</h4>
      <!-- Dynamically generated mushroom items -->
    </div>
    <!-- Lubricant Oil -->
    <div class="grocery-item">
      <p><strong>Lubricant Oil</strong> - $5<br><em>Essential for keeping the power panel running smoothly. Consumed on use.</em></p>
      <button onclick="buyItem('Lubricant Oil')">Buy Lubricant Oil</button>
    </div>
    <!-- Alcohol -->
    <div class="grocery-item">
      <p><strong>Alcohol</strong> - $3<br><em>Boosts mood but may have minor setbacks on health.</em></p>
      <button onclick="buyItem('Alcohol')">Buy Alcohol</button>
    </div>
    <!-- Cigarettes -->
    <div class="grocery-item">
      <p><strong>Cigarettes</strong> - $4<br><em>Temporarily improves mood but reduces health over time.</em></p>
      <button onclick="buyItem('Cigarettes')">Buy Cigarettes</button>
    </div>
    <h3>Your Harvest Inventory</h3>
    <div id="harvestInventory"></div>
    <button onclick="sellHarvest()">Sell Harvest</button>
    <button onclick="hidePanel('grocery-panel')">Return to Main Menu</button>
  </div>

  <!-- Community Garden Panel -->
  <div id="garden-panel" class="panel">
    <h2>Community Garden</h2>
    <p>Manage your rooftop garden. Plants (seeds or mushrooms) need watering and fertilizing; seasonal changes affect growth.</p>
    <div id="plantSlots">
      <!-- Plant slots will be generated dynamically -->
    </div>
    <button onclick="harvestProduce()">Harvest Produce</button>
    <button onclick="hidePanel('garden-panel')">Return to Main Screen</button>
  </div>

  <!-- Community Kitchen Panel with Unified Cooking Process -->
  <div id="kitchen-panel" class="panel">
    <h2>Community Kitchen</h2>
    <p>Access the cookbook to view 20 available recipes. Each recipe has a single-sentence description based on plants and mushrooms grown in the community garden, along with its benefits and setbacks.</p>
    <!-- The Cook button now opens the Recipe Panel -->
    <button onclick="openRecipePanel()">Cook</button>
    <!-- Display dynamic stove status -->
    <div id="stoveStatus" style="margin-top:10px; font-size:14px;">Stove: Available</div>
    <!-- Cooking Process Simulation (hidden by default) -->
    <div id="cookingProcess" style="display:none; margin-top:10px; font-size:14px;">
      <p>Cooking in progress... Please wait 1 minute.</p>
    </div>
    <!-- Chat area for Community Kitchen -->
    <div>
      <h4>Kitchen Chat</h4>
      <div class="chatArea" id="kitchenChatLog"></div>
      <input type="text" id="kitchenChatInput" placeholder="Type a message...">
      <button onclick="sendKitchenChat()">Send</button>
    </div>
    <button onclick="hidePanel('kitchen-panel')">Return to Main Screen</button>
  </div>

  <!-- Recipe Panel for Cooking -->
  <div id="recipePanel" class="panel">
    <h2>Recipe Selection</h2>
    <div id="recipeListContainer" style="max-height:300px; overflow-y:auto;"></div>
    <!-- When Cancel is clicked here, return to the Community Kitchen panel -->
    <button onclick="hidePanel('recipePanel'); openKitchenPanel();">Cancel</button>
  </div>

  <!-- Water Supplies (Laundry) Panel -->
  <div id="water-panel" class="panel">
    <h2>Water Supplies (Laundry)</h2>
    <p>Water pressure is directly linked to the performance of the power panel. Use the washing machine to clean clothes â€“ remember, low power output may result in lower water pressure.</p>
    <div>
      <p><strong>Water Pressure:</strong> <span id="waterPressureDisplay">Calculating...</span> PSI</p>
    </div>
    <div>
      <h4>Washing Machine</h4>
      <button onclick="washClothes()">Wash Clothes</button>
      <div class="chatArea" id="laundryChatLog"></div>
      <input type="text" id="laundryChatInput" placeholder="Type a message...">
      <button onclick="sendLaundryChat()">Send</button>
    </div>
    <button onclick="hidePanel('water-panel')">Return to Main Screen</button>
  </div>

  <!-- Chat Panel (Room Chat / Door Chat) -->
  <div id="chatPanel" class="panel">
    <h2 id="chatRoomTitle"></h2>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="closeChat()">Close Chat</button>
  </div>
</div>

<!-- Door Modal for Front Door Interactions -->
<div id="doorModal">
  <h2 id="doorTitle">Door Interaction</h2>
  <div id="doorOptions">
    <button onclick="handleKnock()">Knock</button>
    <button onclick="showPasswordInput()">Enter Password</button>
  </div>
  <div id="passwordDiv" style="display:none;">
    <input type="text" id="doorPassword" placeholder="Enter 4-digit password">
    <button onclick="verifyPassword()">Submit Password</button>
  </div>
  <button onclick="closeDoorModal()">Cancel</button>
</div>

<script>
  // Store original background settings
  const originalBackground = "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.pexels.com/photos/10741254/pexels-photo-10741254.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2') no-repeat center center fixed";

  // ----------------------------
  // Firebase Initialization & Config
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
    authDomain: "thephantasyreport.firebaseapp.com",
    projectId: "thephantasyreport",
    storageBucket: "thephantasyreport.firebasestorage.app",
    messagingSenderId: "887983841070",
    appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
    measurementId: "G-9MS36H0YV4"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ----------------------------
  // Room Password Mapping (default values)
  // ----------------------------
  const roomPasswords = {
    "Room 1": "0001",
    "Room 2": "0002",
    "Room 3": "0003",
    "Room 4": "0004",
    "Room 5": "0005",
    "Room 6": "0006",
    "Room 7": "0007",
    "Room 8": "0008",
    "Room 9": "0009",
    "Room 10": "0010",
    "Room 11": "0011",
    "Room 12": "0715",
    "Room 13": "0013",
    "Room 14": "0014",
    "Room 15": "0015",
    "Room 16": "0016",
    "Room 17": "0017",
    "Room 18": "0018",
    "Room 19": "0019",
    "Room 20": "0020",
    "Room 21": "0021",
    "Room 22": "0022",
    "Room 23": "0023",
    "Room 24": "0024",
    "Room 25": "0025"
  };

  // Global variables for current room and mode
  let currentRoom = "";
  let doorChatMode = false;
  let harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");

  // ----------------------------
  // Centralized Recipes Array (20 recipes)
  // ----------------------------
  const recipes = [];
  // For demonstration, we create 20 recipes using two samples duplicated
  for (let i = 0; i < 10; i++) {
    recipes.push({
      title: "Garden Salad " + (i+1),
      description: "A refreshing mix of greens and button mushrooms that boosts vitality, though too much may slightly lower hunger.",
      ingredients: [
        { name: "Sunflower Seed", amount: 2 },
        { name: "Button Mushroom", amount: 3 }
      ],
      water: "100ml",
      benefits: "Boosts energy and mood.",
      setbacks: "Slightly decreases hunger."
    });
    recipes.push({
      title: "Mushroom Medley " + (i+1),
      description: "A savory dish combining portobello mushrooms with pumpkin seeds that improves strength but may affect mood if overconsumed.",
      ingredients: [
        { name: "Portobello Mushroom", amount: 2 },
        { name: "Pumpkin Seed", amount: 2 }
      ],
      water: "120ml",
      benefits: "Improves strength.",
      setbacks: "May lower mood if eaten in excess."
    });
  }

  // ----------------------------
  // Helper Functions: Update Mood and Hunger
  // ----------------------------
  function updateMood(delta) {
    const playerEmail = localStorage.getItem('playerName');
    if (!playerEmail) return;
    const safePlayerName = sanitizePlayerName(playerEmail);
    db.collection('players').doc(safePlayerName).get().then(doc => {
      if (doc.exists) {
        let currentMood = doc.data().mood || 100;
        let newMood = Math.max(0, currentMood + delta);
        db.collection('players').doc(safePlayerName).set({ mood: newMood, lastUpdated: Date.now() }, { merge: true });
      }
    });
  }

  function updateHunger(delta) {
    const playerEmail = localStorage.getItem('playerName');
    if (!playerEmail) return;
    const safePlayerName = sanitizePlayerName(playerEmail);
    db.collection('players').doc(safePlayerName).get().then(doc => {
      if (doc.exists) {
        let currentHunger = doc.data().hunger || 0;
        let newHunger = Math.max(0, currentHunger + delta);
        db.collection('players').doc(safePlayerName).set({ hunger: newHunger, lastUpdated: Date.now() }, { merge: true });
      }
    });
  }

  // ----------------------------
  // Inventory Functions
  // ----------------------------
  function addItem(item, qty = 1) {
    if (harvestInventory[item]) {
      harvestInventory[item] += qty;
    } else {
      harvestInventory[item] = qty;
    }
    updateHarvestInventoryUI();
  }

  function removeItem(item, qty = 1) {
    if (harvestInventory[item]) {
      harvestInventory[item] = Math.max(0, harvestInventory[item] - qty);
      if (harvestInventory[item] === 0) {
        delete harvestInventory[item];
      }
    }
    updateHarvestInventoryUI();
  }

  // ----------------------------
  // In-App Notification Listener
  // ----------------------------
  function listenForNotifications() {
    const ownerEmail = localStorage.getItem('playerName');
    if (!ownerEmail) return;
    db.collection("notifications")
      .where("owner", "==", ownerEmail)
      .orderBy("timestamp", "desc")
      .onSnapshot(snapshot => {
        let notifications = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          notifications += `<p>${data.message}</p>`;
        });
        const panel = document.getElementById("notificationPanel");
        if (notifications) {
          panel.innerHTML = notifications;
          panel.style.display = "block";
        } else {
          panel.style.display = "none";
        }
      });
  }

  // ----------------------------
  // Utility: Clear All Game State from localStorage
  // ----------------------------
  function clearGameState() {
    const keys = ['playerName', 'characterName', 'money', 'seeds', 'mushroomSeeds', 'windSpeed', 'brakeEngaged', 'powerOutputConfirmed', 'lastInteractionTime', 'garbageLevel', 'lastGarbageUpdate', 'harvestInventory'];
    keys.forEach(key => localStorage.removeItem(key));
  }

  // ----------------------------
  // Sign Out Function
  // ----------------------------
  function signOutUser() {
    firebase.auth().signOut().then(() => {
      clearGameState();
      window.location.href = "index.html";
    }).catch((error) => {
      console.error("Error signing out: ", error);
    });
  }

  // ----------------------------
  // Exit Button, Garbage Chute, and Panel Toggles
  // ----------------------------
  function showGarbagePanel() {
    document.getElementById('garbage-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function showPowerPanel() {
    document.body.style.backgroundImage = "url('https://i.pinimg.com/736x/2d/d9/76/2dd9762815138628d3c380fe097241d2.jpg')";
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundPosition = "center center";
    document.getElementById('minigame-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function openGroceryPanel() {
    document.getElementById('grocery-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    updateHarvestInventoryUI();
  }
  function openGardenPanel() {
    document.getElementById('garden-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function openKitchenPanel() {
    document.getElementById('kitchen-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function openWaterPanel() {
    document.getElementById('water-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    document.getElementById('waterPressureDisplay').textContent = Math.round(localStorage.getItem('voltage') * 0.8);
  }

  // ----------------------------
  // Buy Item Function (Grocery Store) with Benefits/Setbacks
  // ----------------------------
  function buyItem(item) {
    const prices = {
      'Food Staples': 10,
      'Lubricant Oil': 5,
      'Alcohol': 3,
      'Cigarettes': 4
    };
    let price = prices[item] || 2;
    let money = parseInt(localStorage.getItem('money')) || 50;
    if (money >= price) {
      money -= price;
      localStorage.setItem('money', money);
      alert("Purchased " + item + " for $" + price + ". Remaining money: $" + money);
      addItem(item, 1);
      applyItemEffects(item);
      updatePlayerStatus();
    } else {
      alert("Not enough money to purchase " + item);
    }
  }

  function applyItemEffects(item) {
    switch(item) {
      case "Food Staples":
        updateHunger(-5);
        updateMood(2);
        break;
      case "Lubricant Oil":
        updateMood(1);
        break;
      default:
        if(item.includes("Seed")) {
          updateMood(2);
        } else if(item.includes("Mushroom")) {
          updateMood(1);
          updateHunger(-1);
        } else if(item === "Alcohol") {
          updateMood(3);
          updateHunger(1);
        } else if(item === "Cigarettes") {
          updateMood(2);
          updateHunger(1);
        }
        break;
    }
  }

  // ----------------------------
  // Authentication Functions
  // ----------------------------
  function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById('loginPanel').style.display = 'none';
        checkCharacterExistence();
      })
      .catch(error => {
        alert("Login error: " + error.message);
      });
  }
  function registerUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById('loginPanel').style.display = 'none';
        checkCharacterExistence();
      })
      .catch(error => {
        alert("Registration error: " + error.message);
      });
  }
  function googleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        document.getElementById('loginPanel').style.display = 'none';
        checkCharacterExistence();
      })
      .catch(error => {
        alert("Google sign-in error: " + error.message);
      });
  }
  auth.onAuthStateChanged(user => {
    if (user) {
      if (!localStorage.getItem('playerName')) {
        localStorage.setItem('playerName', user.email);
      }
      checkCharacterExistence();
      listenForNotifications();
    } else {
      document.getElementById('loginPanel').style.display = 'block';
      document.getElementById('mainGame').style.display = 'none';
      document.getElementById('characterCreation').style.display = 'none';
    }
  });

  // ----------------------------
  // Character Creation & Management
  // ----------------------------
  function sanitizePlayerName(name) {
    return name.replace(/[\/\\]/g, '_');
  }
  function checkCharacterExistence() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    db.collection('players').doc(safePlayerName).get().then((doc) => {
      if (doc.exists) {
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      } else {
        document.getElementById('characterCreation').style.display = 'block';
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('displayName').innerText = playerName;
        document.getElementById('charName').value = playerName;
      }
    }).catch((error) => {
      console.error("Error checking character existence:", error);
    });
  }
  function createCharacter() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    const charName = document.getElementById('charName').value;
    const charAge = document.getElementById('charAge').value;
    const charGender = document.getElementById('charGender').value;
    const charReason = document.getElementById('charReason').value;
    const charBackstory = document.getElementById('charBackstory').value;
    const charSkills = document.getElementById('charSkills').value;
    const charInventory = document.getElementById('charInventory').value;
    const charAlliances = document.getElementById('charAlliances').value;
    const charRivalries = document.getElementById('charRivalries').value;
    const charReputation = document.getElementById('charReputation').value;
    const roomNumber = document.getElementById('roomNumber').value;
    const playerData = {
      name: charName,
      age: charAge,
      gender: charGender,
      reason: charReason,
      backstory: charBackstory,
      skills: charSkills.split(',').map(s => s.trim()),
      inventory: charInventory.split(',').map(i => i.trim()),
      alliances: charAlliances ? charAlliances.split(',').map(a => a.trim()) : [],
      rivalries: charRivalries ? charRivalries.split(',').map(r => r.trim()) : [],
      reputation: parseInt(charReputation) || 0,
      roomNumber: roomNumber,
      health: 100,
      hunger: 0,
      injury: 0,
      mood: 100,
      conditions: {
        physical: "Healthy",
        mental: "Content",
        activity: "Idle"
      },
      lastUpdated: Date.now()
    };
    db.collection('players').doc(safePlayerName).set(playerData, { merge: true })
      .then(() => {
        localStorage.setItem('characterName', charName);
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
        db.collection('rooms').doc('Room ' + roomNumber).set({
          owner: playerName
        }, { merge: true });
      })
      .catch((error) => {
        console.error("Error creating character:", error);
      });
  }
  let isEditing = false;
  function enableEdit() {
    isEditing = true;
    updatePlayerStatus();
  }
  function cancelEdit() {
    isEditing = false;
    updatePlayerStatus();
  }
  function togglePlayerStatus() {
    const biodataDiv = document.getElementById('playerStatus');
    if(biodataDiv.style.display === "none" || biodataDiv.style.display === "") {
      biodataDiv.style.display = "block";
    } else {
      biodataDiv.style.display = "none";
    }
  }
  function updatePlayerStatus() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    db.collection('players').doc(safePlayerName)
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          localStorage.setItem('characterName', data.name);
          let statusHTML = `<h3>Biodata</h3>`;
          if (!isEditing) {
            let coreStatsHTML = `<h4>Core Stats</h4>`;
            coreStatsHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
            coreStatsHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
            coreStatsHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
            coreStatsHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
            coreStatsHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
            coreStatsHTML += `<p><strong>Room:</strong> ${data.roomNumber ? "Room " + data.roomNumber : "Not set"}</p>`;
            coreStatsHTML += `<p><strong>Reputation:</strong> ${data.reputation || 0}</p>`;
            
            let narrativeHTML = `<h4>Background</h4>`;
            narrativeHTML += `<p><strong>Reason:</strong> ${data.reason || "N/A"}</p>`;
            narrativeHTML += `<p><strong>Backstory:</strong> ${data.backstory || "N/A"}</p>`;
            narrativeHTML += `<p><strong>Skills:</strong> ${data.skills ? data.skills.join(", ") : "N/A"}</p>`;
            narrativeHTML += `<p><strong>Alliances:</strong> ${data.alliances ? data.alliances.join(", ") : "None"}</p>`;
            narrativeHTML += `<p><strong>Rivalries:</strong> ${data.rivalries ? data.rivalries.join(", ") : "None"}</p>`;
            
            let inventoryHTML = `<h4>Inventory</h4>`;
            if (Object.keys(harvestInventory).length > 0) {
              for (let item in harvestInventory) {
                inventoryHTML += `<p>${item}: ${harvestInventory[item]}</p>`;
              }
            } else {
              inventoryHTML += `<p>None</p>`;
            }
            
            statusHTML += `<div id="coreStats">${coreStatsHTML}</div>`;
            statusHTML += `<div id="narrativeStats" style="display:none;">${narrativeHTML}</div>`;
            statusHTML += `<button id="toggleNarrative" onclick="toggleNarrative()">Show Narrative</button>`;
            statusHTML += `<button onclick="enableEdit()">Edit Biodata</button>`;
            statusHTML += inventoryHTML;
          } else {
            statusHTML += `<h3>Edit Character</h3>`;
            statusHTML += `<div><strong>Core Stats</strong><br>`;
            statusHTML += `<p><strong>Name:</strong> <input type="text" id="editName" value="${data.name}" style="height:40px; font-size:16px;" /></p>`;
            statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
            statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
            statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
            statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
            statusHTML += `<p><strong>Room:</strong> <input type="number" id="editRoomNumber" value="${data.roomNumber || ''}" min="1" max="25" style="height:40px; font-size:16px;" /></p>`;
            statusHTML += `<p><strong>Reputation:</strong> <input type="number" id="editReputation" value="${data.reputation || 0}" style="height:40px; font-size:16px;" /></p></div>`;
            statusHTML += `<div><strong>Background</strong><br>`;
            statusHTML += `<p><strong>Reason:</strong> <textarea id="editReason" style="height:80px; font-size:16px;">${data.reason}</textarea></p>`;
            statusHTML += `<p><strong>Backstory:</strong> <textarea id="editBackstory" style="height:80px; font-size:16px;">${data.backstory || ""}</textarea></p>`;
            statusHTML += `<p><strong>Skills:</strong> <input type="text" id="editSkills" value="${data.skills ? data.skills.join(", ") : ""}" style="height:40px; font-size:16px;" /></p>`;
            statusHTML += `<p><strong>Alliances:</strong> <input type="text" id="editAlliances" value="${data.alliances ? data.alliances.join(", ") : ""}" style="height:40px; font-size:16px;" /></p>`;
            statusHTML += `<p><strong>Rivalries:</strong> <input type="text" id="editRivalries" value="${data.rivalries ? data.rivalries.join(", ") : ""}" style="height:40px; font-size:16px;" /></p></div>`;
            statusHTML += `<button onclick="saveBiodata()">Save Changes</button>`;
            statusHTML += `<button onclick="cancelEdit()">Cancel</button>`;
          }
          statusHTML += `<p><strong>Money:</strong> $${localStorage.getItem('money') || 50}</p>`;
          statusHTML += `<p><strong>Seeds:</strong> ${localStorage.getItem('seeds') || 0}</p>`;
          statusHTML += `<p><strong>Mushroom Seeds:</strong> ${localStorage.getItem('mushroomSeeds') || 0}</p>`;
          document.getElementById('playerStatus').innerHTML = statusHTML;
          updateHarvestInventoryUI();
        }
      }, (error) => {
        console.error("Error getting player status:", error);
      });
  }
  function toggleNarrative() {
    const narrativeDiv = document.getElementById('narrativeStats');
    const toggleButton = document.getElementById('toggleNarrative');
    if(narrativeDiv.style.display === "none"){
      narrativeDiv.style.display = "block";
      toggleButton.textContent = "Hide Narrative";
    } else {
      narrativeDiv.style.display = "none";
      toggleButton.textContent = "Show Narrative";
    }
  }
  function saveBiodata() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const safePlayerName = sanitizePlayerName(playerName);
    const updatedData = {
      name: document.getElementById('editName').value,
      roomNumber: document.getElementById('editRoomNumber').value,
      reputation: parseInt(document.getElementById('editReputation').value) || 0,
      reason: document.getElementById('editReason').value,
      backstory: document.getElementById('editBackstory').value,
      skills: document.getElementById('editSkills').value.split(',').map(s => s.trim()),
      alliances: document.getElementById('editAlliances').value.split(',').map(a => a.trim()),
      rivalries: document.getElementById('editRivalries').value.split(',').map(r => r.trim()),
      lastUpdated: Date.now()
    };
    db.collection('players').doc(safePlayerName).set(updatedData, { merge: true })
      .then(() => {
        isEditing = false;
        updatePlayerStatus();
      })
      .catch(error => {
        console.error("Error saving biodata:", error);
      });
  }

  // ----------------------------
  // Community Kitchen Chat & Unified Cooking Functions
  // ----------------------------
  function sendKitchenChat() {
    const msg = document.getElementById('kitchenChatInput').value;
    if (msg.trim() !== "") {
      db.collection("messages").add({
        room: "Community Kitchen",
        sender: localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown",
        content: msg,
        chatType: "kitchen",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('kitchenChatInput').value = "";
    }
  }
  function listenForKitchenChat() {
    const chatLog = document.getElementById('kitchenChatLog');
    db.collection("messages")
      .where("room", "==", "Community Kitchen")
      .where("chatType", "==", "kitchen")
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  // New function to open the Recipe Panel instead of a popup
  function openRecipePanel() {
    const container = document.getElementById('recipeListContainer');
    container.innerHTML = "";
    recipes.forEach((r, index) => {
      const div = document.createElement('div');
      div.style.borderBottom = "1px solid #555";
      div.style.padding = "5px 0";
      div.innerHTML = `<strong>${index+1}: ${r.title}</strong><br>
                       ${r.description}<br>
                       <em>Ingredients:</em> ${r.ingredients.map(i => `${i.name} (${i.amount})`).join(", ")}<br>
                       <em>Water:</em> ${r.water}<br>
                       <em>Benefits:</em> ${r.benefits} &nbsp;&nbsp; <em>Setbacks:</em> ${r.setbacks}<br>
                       <button onclick="cookRecipe(recipes[${index}])">Cook</button>`;
      container.appendChild(div);
    });
    document.getElementById('recipePanel').style.display = 'block';
    document.getElementById('kitchen-panel').style.display = 'none';
  }
  function cookRecipe(recipe) {
    // Hide the recipe panel
    document.getElementById('recipePanel').style.display = 'none';
    // Check inventory for each required ingredient
    let missingIngredients = [];
    recipe.ingredients.forEach(ing => {
      if (!harvestInventory[ing.name] || harvestInventory[ing.name] < ing.amount) {
        missingIngredients.push(`${ing.name} (need ${ing.amount}, have ${harvestInventory[ing.name] || 0})`);
      }
    });
    if (missingIngredients.length > 0) {
      alert("Cannot cook recipe. Missing ingredients:\n" + missingIngredients.join("\n"));
      // Redirect back to the Recipe Panel
      openRecipePanel();
      return;
    }
    // Remove the required ingredients from inventory
    recipe.ingredients.forEach(ing => {
      removeItem(ing.name, ing.amount);
    });
    // Update stove status to "In Use"
    document.getElementById("stoveStatus").textContent = "Stove: In Use";
    // Show cooking process indicator
    document.getElementById("cookingProcess").style.display = "block";
    // Simulate a 1-minute cooking delay
    setTimeout(() => {
      document.getElementById("cookingProcess").style.display = "none";
      document.getElementById("stoveStatus").textContent = "Stove: Available";
      alert("Cooking complete! You made: " + recipe.title);
      // Add the cooked dish to inventory (as a tradable/giftable/eatable item)
      addItem("Cooked: " + recipe.title, 1);
      // Optionally update player stats based on recipe benefits and setbacks
    }, 60000);
  }

  // ----------------------------
  // Water Supplies (Laundry) Chat & Washing Machine Functions
  // ----------------------------
  function sendLaundryChat() {
    const msg = document.getElementById('laundryChatInput').value;
    if (msg.trim() !== "") {
      db.collection("messages").add({
        room: "Water Supplies",
        sender: localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown",
        content: msg,
        chatType: "laundry",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('laundryChatInput').value = "";
    }
  }
  function listenForLaundryChat() {
    const chatLog = document.getElementById('laundryChatLog');
    db.collection("messages")
      .where("room", "==", "Water Supplies")
      .where("chatType", "==", "laundry")
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  function washClothes() {
    alert("You washed your clothes. Your health improves slightly.");
    updateMood(3);
  }

  // ----------------------------
  // Room Interaction & Chat Functions
  // ----------------------------
  function openRoomInteraction(roomName) {
    currentRoom = roomName;
    db.collection("rooms").doc(roomName).get().then(doc => {
      if (doc.exists) {
        const roomData = doc.data();
        const currentPlayer = localStorage.getItem("playerName");
        if (currentPlayer === roomData.owner) {
          openRoomChat(roomName);
        } else {
          showDoorModal(roomName);
        }
      } else {
        alert("Room " + roomName + " does not exist. Please contact support.");
      }
    }).catch(error => {
      console.error("Error fetching room data:", error);
      alert("Error fetching room data for " + roomName);
    });
  }
  function openRoomChat(roomName) {
    doorChatMode = false;
    document.getElementById('chatRoomTitle').textContent = roomName + " Chat (Inside)";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function openDoorChat(roomName) {
    doorChatMode = true;
    document.getElementById('chatRoomTitle').textContent = roomName + " Door Chat (Visitor)";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    listenForMessages(roomName);
  }
  function listenForMessages(roomName) {
    const chatLog = document.getElementById('chatLog');
    const messagesRef = db.collection("messages");
    messagesRef
      .where("room", "==", roomName)
      .where("chatType", "==", doorChatMode ? "door" : "room")
      .orderBy("timestamp")
      .onSnapshot((querySnapshot) => {
        chatLog.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          const p = document.createElement('p');
          p.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
          chatLog.appendChild(p);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
  }
  function closeChat() {
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    currentRoom = "";
  }
  async function sendChatMessage() {
    const msg = document.getElementById('chatInput').value;
    if (msg.trim() !== "") {
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      try {
        await db.collection("messages").add({
          room: currentRoom,
          sender: characterName,
          content: msg,
          chatType: doorChatMode ? "door" : "room",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('chatInput').value = "";
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ----------------------------
  // Door Modal Functions
  // ----------------------------
  function showDoorModal(roomName) {
    currentRoom = roomName;
    document.getElementById('doorTitle').textContent = "You are at the door of " + roomName;
    document.getElementById('doorModal').style.display = 'block';
    document.getElementById('passwordDiv').style.display = 'none';
    document.getElementById('doorPassword').value = "";
  }
  function closeDoorModal() {
    document.getElementById('doorModal').style.display = 'none';
  }
  function showPasswordInput() {
    document.getElementById('passwordDiv').style.display = 'block';
  }
  function verifyPassword() {
    const enteredPassword = document.getElementById('doorPassword').value;
    const correctPassword = roomPasswords[currentRoom];
    if (enteredPassword === correctPassword) {
      alert("Password correct. You now enter the room.");
      closeDoorModal();
      openRoomChat(currentRoom);
    } else {
      alert("Incorrect password. Please try again or choose to knock.");
    }
  }
  function handleKnock() {
    alert("You knocked on the door. Please wait for the ownerâ€™s response.");
    db.collection("rooms").doc(currentRoom).get().then(doc => {
      if (doc.exists) {
        const owner = doc.data().owner;
        const visitor = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "A visitor";
        db.collection("notifications").add({
          owner: owner,
          room: currentRoom,
          message: `${visitor} knocked on your door of ${currentRoom}.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }).catch(error => {
      console.error("Error sending knock notification:", error);
    });
    closeDoorModal();
    openDoorChat(currentRoom);
  }

  // ----------------------------
  // Power Source Simulation Functions
  // ----------------------------
  let windSpeed = localStorage.getItem('windSpeed') || 50;
  let brakeEngaged = JSON.parse(localStorage.getItem('brakeEngaged')) || false;
  let powerOutputConfirmed = JSON.parse(localStorage.getItem('powerOutputConfirmed')) || false;
  let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
  let garbageLevel = localStorage.getItem('garbageLevel') || 0;
  let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();
  let powerStatus = "Unknown";
  function updateWindSpeed() {
    windSpeed = document.getElementById('windSpeedSlider').value;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    localStorage.setItem('windSpeed', windSpeed);
    updateVoltage();
    updateLastInteraction();
  }
  function toggleBrake() {
    brakeEngaged = !brakeEngaged;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    localStorage.setItem('brakeEngaged', brakeEngaged);
    updateVoltage();
    updateLastInteraction();
  }
  function togglePowerOutput() {
    powerOutputConfirmed = !powerOutputConfirmed;
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    localStorage.setItem('powerOutputConfirmed', powerOutputConfirmed);
    evaluatePowerOutput();
    updateLastInteraction();
  }
  function lubricate() {
    if (harvestInventory["Lubricant Oil"] && harvestInventory["Lubricant Oil"] > 0) {
      removeItem("Lubricant Oil", 1);
      logPowerMessage("Lubricant applied. Moving parts are now well-oiled.");
      updateLastInteraction();
    } else {
      alert("You don't have any Lubricant Oil. Please purchase some from the Grocery Store.");
    }
  }
  function updateVoltage() {
    let factor = brakeEngaged ? 0.5 : 1.0;
    let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
    voltage = Math.max(0, voltage);
    document.getElementById('voltageDisplay').textContent = voltage.toFixed(1);
    localStorage.setItem('voltage', voltage);
  }
  function evaluatePowerOutput() {
    if (windSpeed >= 40 && windSpeed <= 70 && powerOutputConfirmed) {
      powerStatus = "On";
    } else {
      powerStatus = "Off";
    }
    document.getElementById('powerStatusDisplay').textContent = powerStatus;
    if (powerStatus === "Off") {
      document.getElementById('powerAlert').style.display = "inline";
      let suggestionText = "Reduced services in flats:\n";
      suggestionText += "- Water Supplies (lower water pressure)\n";
      suggestionText += "- Lighting (dimmer lights)\n";
      suggestionText += "- Heating (reduced warmth)\n\n";
      suggestionText += "This may affect your biodata (health and mood).\n";
      suggestionText += "Suggestions: Increase wind speed, engage the brake appropriately, or apply Lubricant Oil.";
      document.getElementById('powerSuggestions').textContent = suggestionText;
      alert("Power is insufficient! Flats will experience reduced services.");
    } else {
      document.getElementById('powerAlert').style.display = "none";
      document.getElementById('powerSuggestions').textContent = "";
    }
  }
  function simulatePowerEvent() {
    if (Date.now() - lastInteractionTime > 60000) {
      windSpeed = Math.max(0, windSpeed - 5);
      localStorage.setItem('windSpeed', windSpeed);
      updateVoltage();
    }
  }
  function updateGarbageDisplay() {
    const now = Date.now();
    const elapsedMinutes = Math.floor((now - lastGarbageUpdate) / 60000);
    if (elapsedMinutes > 0) {
      garbageLevel = Math.min(100, Number(garbageLevel) + elapsedMinutes);
      lastGarbageUpdate = now;
      localStorage.setItem('garbageLevel', garbageLevel);
      localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
      document.getElementById('garbageDisplay').textContent = garbageLevel;
      if (garbageLevel > 80) {
        alert("High garbage levels detected! The community is getting sick.");
      }
    }
  }
  function logPowerMessage(message) {
    const logDiv = document.getElementById('minigameLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  function toggleInstructions() {
    const instrDiv = document.getElementById("instructions");
    instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
  }
  function updateLastInteraction() {
    lastInteractionTime = Date.now();
    localStorage.setItem('lastInteractionTime', lastInteractionTime);
  }

  // ----------------------------
  // NEW: Health Decline Due to High Garbage
  // ----------------------------
  function simulateHealthDecline() {
    if (garbageLevel > 80) {
      const playerEmail = localStorage.getItem('playerName');
      if (!playerEmail) return;
      const safePlayerName = sanitizePlayerName(playerEmail);
      db.collection('players').doc(safePlayerName).get().then((doc) => {
        if (doc.exists) {
          let data = doc.data();
          let currentHealth = data.health || 100;
          let newHealth = Math.max(0, currentHealth - 1);
          db.collection('players').doc(safePlayerName).set({ health: newHealth, lastUpdated: Date.now() }, { merge: true });
          if (newHealth === 0) {
            playerDied();
          }
        }
      }).catch((error) => {
        console.error("Error decreasing health: ", error);
      });
    }
  }
  function playerDied() {
    alert("Your health has reached zero. You have died.");
    clearGameState();
    window.location.href = "index.html";
  }

  // ----------------------------
  // Season Simulation
  // ----------------------------
  let currentSeason = "Spring";
  function updateSeason() {
    const seasons = ["Spring", "Summer", "Autumn", "Winter"];
    let index = Math.floor((Date.now() / 120000)) % seasons.length;
    currentSeason = seasons[index];
    console.log("Current Season: " + currentSeason);
  }
  setInterval(updateSeason, 120000);

  // ----------------------------
  // Modal Panel Utilities
  // ----------------------------
  function hidePanel(panelId) {
    document.getElementById(panelId).style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    if (panelId === 'minigame-panel') {
      document.body.style.background = originalBackground;
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center center";
    }
  }

  // ----------------------------
  // Toggle Music Player Function
  // ----------------------------
  function toggleMusicPlayer() {
    var player = document.getElementById("bgMusic");
    if (player.style.display === "none" || player.style.display === "" || player.style.width === "0px") {
      player.style.display = "block";
      player.style.width = "300px";
      player.style.height = "200px";
      player.style.position = "relative";
      player.style.left = "0";
    } else {
      player.style.display = "none";
      player.style.width = "0";
      player.style.height = "0";
      player.style.position = "absolute";
      player.style.left = "-9999px";
    }
  }

  // ----------------------------
  // Functions to Generate Seed and Mushroom Items in Grocery Stand
  // ----------------------------
  const seedTypes = [
    "Sunflower Seed", "Pumpkin Seed", "Corn Seed", "Wheat Seed", "Rice Seed",
    "Barley Seed", "Oat Seed", "Millet Seed", "Sorghum Seed", "Quinoa Seed",
    "Flax Seed", "Sesame Seed", "Chia Seed", "Cumin Seed", "Mustard Seed",
    "Fennel Seed", "Caraway Seed", "Anise Seed", "Poppy Seed", "Basil Seed"
  ];
  const mushroomTypes = [
    "Button Mushroom", "Portobello Mushroom", "Shiitake Mushroom", "Oyster Mushroom", "Enoki Mushroom"
  ];
  function generateGroceryItems() {
    let seedContainer = document.getElementById("seedList");
    seedTypes.forEach(seed => {
      let div = document.createElement("div");
      div.className = "grocery-item";
      div.innerHTML = `<p><strong>${seed}</strong> - $2<br><em>${seed} is ideal for growing nutrient-rich produce.</em></p>
                       <button onclick="buyItem('${seed}')">Buy ${seed}</button>`;
      seedContainer.appendChild(div);
    });
    let mushroomContainer = document.getElementById("mushroomList");
    mushroomTypes.forEach(mushroom => {
      let div = document.createElement("div");
      div.className = "grocery-item";
      div.innerHTML = `<p><strong>${mushroom}</strong> - $2<br><em>${mushroom} adds unique flavor and nutrients.</em></p>
                       <button onclick="buyItem('${mushroom}')">Buy ${mushroom}</button>`;
      mushroomContainer.appendChild(div);
    });
  }

  // ----------------------------
  // Clear Garbage Function with Logging
  // ----------------------------
  function clearGarbage() {
    garbageLevel = 0;
    localStorage.setItem('garbageLevel', garbageLevel);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
    const logDiv = document.getElementById('garbageLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${characterName} cleared the garbage.</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // ----------------------------
  // DOMContentLoaded & Initialization
  // ----------------------------
  window.onload = function() {
    var roomSelect = document.getElementById('roomNumber');
    if (roomSelect) {
      for (let i = 1; i <= 25; i++) {
        let option = document.createElement('option');
        option.value = i;
        option.textContent = "Room " + i;
        roomSelect.appendChild(option);
      }
    }
    var gridContainer = document.querySelector(".grid");
    if (gridContainer) {
      const rooms = [21,22,23,24,25,16,17,18,19,20,11,12,13,14,15,6,7,8,9,10,1,2,3,4,5];
      rooms.forEach(function(room) {
        let btn = document.createElement("button");
        btn.textContent = "Room " + room;
        btn.onclick = function() { openRoomInteraction("Room " + room); };
        gridContainer.appendChild(btn);
      });
    }
    var plantSlotsDiv = document.getElementById("plantSlots");
    if (plantSlotsDiv) {
      plantSlotsDiv.innerHTML = "";
      for (let i = 1; i <= 10; i++) {
        let slotDiv = document.createElement("div");
        slotDiv.className = "slot";
        slotDiv.id = "slot" + i;
        slotDiv.innerHTML = 'Slot ' + i + ': <span class="status">Empty</span> <button onclick="openPlantSelectionModal(' + i + ')">Plant Seed</button>';
        plantSlotsDiv.appendChild(slotDiv);
      }
      let treeDiv = document.createElement("div");
      treeDiv.className = "slot";
      treeDiv.id = "mushroomTree";
      treeDiv.innerHTML = 'Tree for Mushrooms: <span class="status">Empty</span> <button onclick="plantMushroomTree()">Plant Mushroom</button>';
      plantSlotsDiv.appendChild(treeDiv);
    }
    document.getElementById('windSpeedSlider').value = windSpeed;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    updateVoltage();
    updateGarbageDisplay();
    updateSeason();
    if (localStorage.getItem('playerName')) {
      checkCharacterExistence();
    }
    harvestInventory = JSON.parse(localStorage.getItem('harvestInventory') || "{}");
    generateGroceryItems();
    setInterval(simulatePowerEvent, 60000);
    setInterval(updateGarbageDisplay, 60000);
    setInterval(updateVoltage, 5000);
    setInterval(simulateHealthDecline, 60000);
    listenForKitchenChat();
    listenForLaundryChat();
  };

  // Placeholder functions for planting seeds and mushrooms
  function openPlantSelectionModal(slotNumber) {
    alert("Select a seed to plant in Slot " + slotNumber + ". (Functionality to be implemented.)");
  }
  function plantMushroomTree() {
    alert("Planting a mushroom tree. (Functionality to be implemented.)");
  }
  function harvestProduce() {
    alert("Harvesting produce from the Community Garden. (Functionality to be implemented.)");
  }
  function sellHarvest() {
    alert("Selling harvested produce. (Functionality to be implemented.)");
  }
</script>
</body>
</html>
