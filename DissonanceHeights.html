<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dissonance Heights</title>
  <style>
    /* Global Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      position: relative;
      width: 600px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-template-rows: repeat(5, 100px);
      gap: 5px;
      margin-left: 60px;
    }
    .grid button {
      width: 100%;
      height: 100%;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 14px;
    }
    .garbage-chute {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 520px;
      background-color: #d1d1d1;
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      writing-mode: vertical-rl;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
    }
    .power-room {
      position: absolute;
      top: 210px;
      left: calc(60px + 520px + 10px);
      width: 100px;
      height: 100px;
      background-color: #c0c0ff;
      border: 2px solid #666;
      cursor: pointer;
      font-size: 14px;
    }
    .facilities {
      margin-top: 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .facilities button {
      padding: 10px 20px;
      background-color: #ffc;
      border: 1px solid #999;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    .panel {
      display: none;
      border: 2px solid #444;
      padding: 20px;
      width: 600px;
      margin: 20px auto;
      background: #fff;
    }
    .panel h2 {
      text-align: center;
    }
    .control {
      margin-bottom: 15px;
    }
    .control label {
      display: inline-block;
      width: 200px;
    }
    .control input[type="range"] {
      width: 200px;
    }
    #minigameLog, #garbageLog, #chatLog {
      border: 1px solid #ccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    /* Chat Panel */
    #chatPanel {
      display: none;
      border: 2px solid #444;
      padding: 10px;
      width: 400px;
      margin: 20px auto;
      background: #fff;
    }
    /* Character Status Box */
    #playerStatus {
      margin: 20px auto;
      max-width: 300px;
      background: #fff;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
    }
    /* Character Creation Section */
    #characterCreation {
      margin: 20px auto;
      max-width: 300px;
      background: #fff;
      border: 2px solid #444;
      padding: 10px;
      font-size: 14px;
      display: none;
    }
    #characterCreation input, 
    #characterCreation select, 
    #characterCreation textarea {
      width: 95%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
    }
  </style>
  <!-- Firebase SDKs: Auth, Firestore, and Socket.IO -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
</head>
<body>

<!-- Character Creation Section (shown if no character exists) -->
<div id="characterCreation">
  <h3>Create Your Character</h3>
  <p>Welcome, <span id="displayName"></span>!</p>
  <form id="createCharacterForm" onsubmit="event.preventDefault(); createCharacter();">
    <input type="text" id="charName" placeholder="Name" required>
    <input type="number" id="charAge" placeholder="Age" required>
    <select id="charGender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="charReason" placeholder="Reason for staying at Dissonance Heights" required></textarea>
    <button type="submit">Create Character</button>
  </form>
</div>

<!-- Main Game Section -->
<div id="mainGame" style="display: none;">
  <!-- Main Screen -->
  <div id="main-screen">
    <div class="container">
      <button class="garbage-chute" onclick="showGarbagePanel()">Garbage Chute</button>
      <div class="grid">
        <!-- 25 Room Buttons -->
        <button onclick="openRoomChat('Room 21')">Room 21</button>
        <button onclick="openRoomChat('Room 22')">Room 22</button>
        <button onclick="openRoomChat('Room 23')">Room 23</button>
        <button onclick="openRoomChat('Room 24')">Room 24</button>
        <button onclick="openRoomChat('Room 25')">Room 25</button>
        <button onclick="openRoomChat('Room 16')">Room 16</button>
        <button onclick="openRoomChat('Room 17')">Room 17</button>
        <button onclick="openRoomChat('Room 18')">Room 18</button>
        <button onclick="openRoomChat('Room 19')">Room 19</button>
        <button onclick="openRoomChat('Room 20')">Room 20</button>
        <button onclick="openRoomChat('Room 11')">Room 11</button>
        <button onclick="openRoomChat('Room 12')">Room 12</button>
        <button onclick="openRoomChat('Room 13')">Room 13</button>
        <button onclick="openRoomChat('Room 14')">Room 14</button>
        <button onclick="openRoomChat('Room 15')">Room 15</button>
        <button onclick="openRoomChat('Room 6')">Room 6</button>
        <button onclick="openRoomChat('Room 7')">Room 7</button>
        <button onclick="openRoomChat('Room 8')">Room 8</button>
        <button onclick="openRoomChat('Room 9')">Room 9</button>
        <button onclick="openRoomChat('Room 10')">Room 10</button>
        <button onclick="openRoomChat('Room 1')">Room 1</button>
        <button onclick="openRoomChat('Room 2')">Room 2</button>
        <button onclick="openRoomChat('Room 3')">Room 3</button>
        <button onclick="openRoomChat('Room 4')">Room 4</button>
        <button onclick="openRoomChat('Room 5')">Room 5</button>
      </div>
      <button class="power-room" onclick="showPowerPanel()">Power Room</button>
    </div>
    <div class="facilities">
      <button onclick="handleClick('Community Kitchen')">Community Kitchen</button>
      <button onclick="handleClick('Groceries Stand')">Groceries Stand</button>
      <button onclick="handleClick('Water Supplies (Laundry)')">Water Supplies (Laundry)</button>
      <!-- Toggle Status Button -->
      <button onclick="togglePlayerStatus()">Toggle Status</button>
    </div>
    <!-- Character Status Box -->
    <div id="playerStatus">
      <h3>Character Status</h3>
      <p>Your character data will appear here.</p>
    </div>
  </div>

  <!-- Power Source Panel -->
  <div id="minigame-panel" class="panel">
    <h2>Wind Turbine Control Panel</h2>
    <p><strong>Objective:</strong> Ensure the turbine remains stable and provides electricity (affecting water and heating) to the flats.</p>
    <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    <div id="instructions" style="display: none;">
      <p>Adjust the wind speed, engage brakes when needed, lubricate the turbine, and confirm power output.</p>
    </div>
    <div class="control">
      <label for="windSpeedSlider">Wind Speed Regulator:</label>
      <input type="range" id="windSpeedSlider" min="0" max="100" onchange="updateWindSpeed()">
      <span id="windSpeedValue"></span>
    </div>
    <div class="control">
      <label for="brakeButton">Brake System:</label>
      <button id="brakeButton" onclick="toggleBrake()">Engage Brake</button>
    </div>
    <div class="control">
      <label>Voltage Monitor:</label>
      <span id="voltageDisplay"></span> V
    </div>
    <div class="control">
      <label for="lubricateButton">Lubrication Check:</label>
      <button id="lubricateButton" onclick="lubricate()">Lubricate</button>
    </div>
    <div class="control">
      <label for="powerOutputConfirm">Power Output Confirm:</label>
      <button id="powerOutputConfirm" onclick="togglePowerOutput()">Confirm Output</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('minigame-panel')">Return to Main Screen</button>
    </div>
    <h3>System Log:</h3>
    <div id="minigameLog"></div>
  </div>

  <!-- Garbage Chute Panel -->
  <div id="garbage-panel" class="panel">
    <h2>Garbage Chute Control</h2>
    <p><strong>Objective:</strong> Clear the accumulated garbage before it piles up too high.</p>
    <div class="control">
      <label>Garbage Level:</label>
      <span id="garbageDisplay"></span> / 100
    </div>
    <div class="control">
      <button onclick="clearGarbage()">Clear Garbage</button>
    </div>
    <div class="control">
      <button onclick="hidePanel('garbage-panel')">Return to Main Screen</button>
    </div>
    <h3>Garbage Log:</h3>
    <div id="garbageLog"></div>
  </div>

  <!-- Chat Panel -->
  <div id="chatPanel" class="panel">
    <h2 id="chatRoomTitle"></h2>
    <div id="chatLog"></div>
    <input type="text" id="chatInput" placeholder="Type your message...">
    <button onclick="sendChatMessage()">Send</button>
    <button onclick="closeChat()">Close Chat</button>
  </div>
</div>

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD5avvNbSB5L_YtpyxbBYYnvUpjMa0WglE",
    authDomain: "thephantasyreport.firebaseapp.com",
    projectId: "thephantasyreport",
    storageBucket: "thephantasyreport.firebasestorage.app",
    messagingSenderId: "887983841070",
    appId: "1:887983841070:web:252290aa7b51d7d8f7a4bf",
    measurementId: "G-9MS36H0YV4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Toggle Status Visibility
  function togglePlayerStatus() {
    const statusBox = document.getElementById('playerStatus');
    if (statusBox.style.display === "none" || statusBox.style.display === "") {
      statusBox.style.display = "block";
    } else {
      statusBox.style.display = "none";
    }
  }

  // Initialize Socket.IO
  const socket = io();

  // Persistent state from localStorage
  let windSpeed = localStorage.getItem('windSpeed') || 50;
  let brakeEngaged = JSON.parse(localStorage.getItem('brakeEngaged')) || false;
  let powerOutputConfirmed = JSON.parse(localStorage.getItem('powerOutputConfirmed')) || false;
  let lastInteractionTime = localStorage.getItem('lastInteractionTime') || Date.now();
  let garbageLevel = localStorage.getItem('garbageLevel') || 0;
  let lastGarbageUpdate = localStorage.getItem('lastGarbageUpdate') || Date.now();

  // ----------------------------
  // Main Screen & Panel Functions
  // ----------------------------
  function showPowerPanel() {
    document.getElementById('minigame-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function showGarbagePanel() {
    updateGarbageDisplay();
    document.getElementById('garbage-panel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
  }
  function hidePanel(panelId) {
    document.getElementById(panelId).style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
  }
  function handleClick(label) {
    openRoomChat(label);
  }

  // ----------------------------
  // Room Chat Functions
  // ----------------------------
  let currentRoom = "";
  function openRoomChat(roomName) {
    currentRoom = roomName;
    document.getElementById('chatRoomTitle').textContent = roomName + " Chat";
    document.getElementById('chatLog').innerHTML = "";
    document.getElementById('chatPanel').style.display = 'block';
    document.getElementById('main-screen').style.display = 'none';
    socket.emit('joinRoom', roomName);
  }
  function closeChat() {
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    socket.emit('leaveRoom', currentRoom);
    currentRoom = "";
  }
  function sendChatMessage() {
    const msg = document.getElementById('chatInput').value;
    if (msg.trim() !== "") {
      // Use "characterName" if set, otherwise fallback to the sign-in name ("playerName")
      const characterName = localStorage.getItem('characterName') || localStorage.getItem('playerName') || "Unknown";
      const chatLog = document.getElementById('chatLog');
      const p = document.createElement('p');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${characterName}: ${msg}`;
      chatLog.appendChild(p);
      chatLog.scrollTop = chatLog.scrollHeight;
      socket.emit('chatMessage', { room: currentRoom, message: msg, sender: characterName });
      document.getElementById('chatInput').value = "";
    }
  }
  socket.on('chatMessage', data => {
    if (data.room === currentRoom) {
      const chatLog = document.getElementById('chatLog');
      const p = document.createElement('p');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${data.sender}: ${data.message}`;
      chatLog.appendChild(p);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
  });
  document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ----------------------------
  // Power Source Simulation Functions
  // ----------------------------
  function updateWindSpeed() {
    windSpeed = document.getElementById('windSpeedSlider').value;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    localStorage.setItem('windSpeed', windSpeed);
    updateVoltage();
    updateLastInteraction();
  }
  function toggleBrake() {
    brakeEngaged = !brakeEngaged;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    localStorage.setItem('brakeEngaged', brakeEngaged);
    updateVoltage();
    updateLastInteraction();
  }
  function togglePowerOutput() {
    powerOutputConfirmed = !powerOutputConfirmed;
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    localStorage.setItem('powerOutputConfirmed', powerOutputConfirmed);
    updateLastInteraction();
  }
  function lubricate() {
    logPowerMessage("Lubrication complete. Moving parts are now well-oiled.");
    updateLastInteraction();
  }
  function updateVoltage() {
    let factor = brakeEngaged ? 0.5 : 1.0;
    let voltage = Math.round(windSpeed * factor + (Math.random() * 10 - 5));
    voltage = Math.max(0, voltage);
    document.getElementById('voltageDisplay').textContent = voltage.toFixed(1);
    localStorage.setItem('voltage', voltage);
  }
  function simulateRandomEvent() {
    if (Date.now() - lastInteractionTime > 30000) {
      logPowerMessage("System overload due to inactivity! Flats experience a blackout for 1-2 days.");
    }
    const events = [
      "Sudden strong winds detected! Adjust wind speed or engage brakes.",
      "Low energy output observed! Check lubrication or adjust controls.",
      "Minor electrical fault occurred! Reset the circuit breaker.",
      "Dust accumulation detected! Perform a quick maintenance check."
    ];
    logPowerMessage(events[Math.floor(Math.random() * events.length)]);
  }
  function logPowerMessage(message) {
    const logDiv = document.getElementById('minigameLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  function toggleInstructions() {
    const instrDiv = document.getElementById("instructions");
    instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
  }
  function updateLastInteraction() {
    lastInteractionTime = Date.now();
    localStorage.setItem('lastInteractionTime', lastInteractionTime);
  }

  // ----------------------------
  // Garbage Chute Simulation Functions
  // ----------------------------
  function updateGarbageDisplay() {
    const now = Date.now();
    const elapsedHours = Math.floor((now - lastGarbageUpdate) / 3600000);
    garbageLevel = Math.min(100, Number(garbageLevel) + elapsedHours * 10);
    lastGarbageUpdate = now;
    localStorage.setItem('garbageLevel', garbageLevel);
    localStorage.setItem('lastGarbageUpdate', lastGarbageUpdate);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
  }
  function clearGarbage() {
    garbageLevel = 0;
    localStorage.setItem('garbageLevel', garbageLevel);
    document.getElementById('garbageDisplay').textContent = garbageLevel;
    logGarbageMessage("Garbage cleared by player.");
    socket.emit('disposeGarbage');
  }
  function logGarbageMessage(message) {
    const logDiv = document.getElementById('garbageLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // ----------------------------
  // Firebase: Player Join, Status Update & Display
  // ----------------------------
  function updatePlayerStatus() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    db.collection('players').doc(playerName)
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          // Optionally, update localStorage with the chosen character name:
          localStorage.setItem('characterName', data.name);
          let statusHTML = `<h3>Character Status</h3>`;
          statusHTML += `<p><strong>Name:</strong> ${data.name}</p>`;
          statusHTML += `<p><strong>Health:</strong> ${data.health}</p>`;
          statusHTML += `<p><strong>Hunger:</strong> ${data.hunger}</p>`;
          statusHTML += `<p><strong>Injury:</strong> ${data.injury}</p>`;
          statusHTML += `<p><strong>Mood:</strong> ${data.mood}</p>`;
          statusHTML += `<p><strong>Gender:</strong> ${data.gender || "N/A"}</p>`;
          statusHTML += `<p><strong>Age:</strong> ${data.age || "N/A"}</p>`;
          statusHTML += `<p><strong>Reason:</strong> ${data.reason || "N/A"}</p>`;
          statusHTML += `<p><strong>Physical:</strong> ${data.conditions.physical}</p>`;
          statusHTML += `<p><strong>Mental:</strong> ${data.conditions.mental}</p>`;
          statusHTML += `<p><strong>Activity:</strong> ${data.conditions.activity}</p>`;
          statusHTML += `<p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString()}</p>`;
          document.getElementById('playerStatus').innerHTML = statusHTML;
        }
      }, (error) => {
        console.error("Error getting player status:", error);
      });
  }

  // Check if character exists and show appropriate section
  function checkCharacterExistence() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    db.collection('players').doc(playerName).get().then((doc) => {
      if (doc.exists) {
        // Character exists: show main game
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      } else {
        // Character doesn't exist: show character creation section
        document.getElementById('characterCreation').style.display = 'block';
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('displayName').innerText = playerName;
        // Pre-fill the name field
        document.getElementById('charName').value = playerName;
      }
    }).catch((error) => {
      console.error("Error checking character existence:", error);
    });
  }

  function createCharacter() {
    const playerName = localStorage.getItem('playerName');
    if (!playerName) return;
    const charName = document.getElementById('charName').value;
    const charAge = document.getElementById('charAge').value;
    const charGender = document.getElementById('charGender').value;
    const charReason = document.getElementById('charReason').value;

    const playerData = {
      name: charName,
      age: charAge,
      gender: charGender,
      reason: charReason,
      health: 100,
      hunger: 0,
      injury: 0,
      mood: 100,
      conditions: {
        physical: "Healthy",
        mental: "Content",
        activity: "Idle"
      },
      lastUpdated: Date.now()
    };

    db.collection('players').doc(playerName).set(playerData, { merge: true })
      .then(() => {
        // Store the chosen character name in localStorage
        localStorage.setItem('characterName', charName);
        document.getElementById('characterCreation').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        updatePlayerStatus();
      })
      .catch((error) => {
        console.error("Error creating character:", error);
      });
  }

  // Listen for global game state updates from the server
  socket.on('gameStateUpdate', gameState => {
    logPowerMessage(`Global update: Electricity: ${gameState.resources.electricity}, Heat: ${gameState.resources.heat}, Water: ${gameState.resources.water}`);
  });

  // ----------------------------
  // Initialization
  // ----------------------------
  window.onload = function() {
    document.getElementById('windSpeedSlider').value = windSpeed;
    document.getElementById('windSpeedValue').textContent = windSpeed;
    document.getElementById('brakeButton').textContent = brakeEngaged ? "Release Brake" : "Engage Brake";
    document.getElementById('powerOutputConfirm').textContent = powerOutputConfirmed ? "Output Confirmed" : "Confirm Output";
    updateVoltage();
    updateGarbageDisplay();
    // Check if a player is signed in and then check for their character document
    if (localStorage.getItem('playerName')) {
      checkCharacterExistence();
    }
    setInterval(updateVoltage, 5000);
    setInterval(simulateRandomEvent, 3600000);
    setInterval(updateGarbageDisplay, 3600000);
  };
</script>
</body>
</html>
